<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="ko">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>app.ciceron_lib &#8212; CICERON 2.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <link rel="index" title="색인" href="../../genindex.html" />
    <link rel="search" title="검색" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for app.ciceron_lib</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">hashlib</span><span class="o">,</span> <span class="nn">codecs</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">string</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">paypalrestsdk</span><span class="o">,</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">make_response</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">current_app</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">iamport</span> <span class="k">import</span> <span class="n">Iamport</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.requestwarehouse</span> <span class="k">import</span> <span class="n">Warehousing</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">requestwarehouse</span> <span class="k">import</span> <span class="n">Warehousing</span>

<span class="n">super_user</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pjh0308@gmail.com&quot;</span><span class="p">,</span> <span class="s2">&quot;happyhj@gmail.com&quot;</span><span class="p">,</span> <span class="s2">&quot;admin@ciceron.me&quot;</span><span class="p">]</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">매우 자주 사용하게 될 라이브러리 함수</span>
<span class="sd">get_user_id(): 이메일 주소를 넣으면 user_id를 받을 수 있음.</span>
<span class="sd">get_new_id(): 해당 테이블에서 사용하는 sequence</span>
<span class="sd">parameter_to_bool(): parameter가 boolean 타입이면 True/False로 parsing해줌</span>

<span class="sd">@login_required: 세션을 먼저 감지하여 로그인이 되어 있는지 살펴본다.</span>
<span class="sd">strict_translator_checker: 해당 티켓에 로그인한 번역가가 번역 가능한지 언어 체크</span>
<span class="sd">translationAuthChecker: 로그인한 번역가가 해당 티켓의 번역가인지 알아봄</span>
<span class="sd">clientAuthChecker: 로그인한 의뢰인이 해당 티켓의 의뢰인인지 알려줌</span>

<span class="sd">json_from_V_REQUESTS: 쿼리한 결과를 python dict로 만들어줌.</span>
<span class="sd">update_user_record: 유저 통계 업데이트</span>
<span class="sd">parse_request: request를 parsing하여 dictionary로 만들어줌. www-urlencode이든, form-data이튼, application/json이든 모두 감별함</span>

<span class="sd">string2Data: 문자열 날짜/시간 데이터를 Datetime object로 만들어줌</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="get_hashed_password"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.get_hashed_password">[문서]</a><span class="k">def</span> <span class="nf">get_hashed_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    비밀번호 hashing 라이브러리. Salt 넣으면 그것도 반영하여 만들어줌</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hash_maker</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">salt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hash_maker</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hash_maker</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">salt</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="n">salt</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">hash_maker</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>

<div class="viewcode-block" id="random_string_gen"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.random_string_gen">[문서]</a><span class="k">def</span> <span class="nf">random_string_gen</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">chars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    무작위 string 만들어줌. 길이 조절도 가능함</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span>

    <span class="n">gened_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">gened_string</span> <span class="o">=</span> <span class="n">gened_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gened_string</span></div>

<span class="c1">#def check_and_update_reg_key(conn, os_name, registration_id):</span>
<span class="c1">#    # Register key: Android</span>
<span class="c1">#    user_id = session[&#39;username&#39;]</span>
<span class="c1">#    cursor = conn.execute(&quot;SELECT * FROM RegKey_%s WHERE id = ?&quot; % os_name, [buffer(user_id)])</span>
<span class="c1">#    result = cursor.fetchall()</span>
<span class="c1">#    if len(result) == 0:</span>
<span class="c1">#        conn.execute(&quot;INSERT INTO RegKey_android VALUES (?, ?)&quot;), [buffer(user_id), buffer(registration_id)]</span>
<span class="c1">#    elif len(result) == 1 and result[0][1] != registration_id:</span>
<span class="c1">#        conn.execute(&quot;UPDATE RegKey_android SET reg_key = ? WHERE id = ?&quot;, [buffer(registration_id), buffer(user_id)])</span>

<div class="viewcode-block" id="get_id_from_text"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.get_id_from_text">[문서]</a><span class="k">def</span> <span class="nf">get_id_from_text</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    text와 테이블 이름을 넣으면 입력한 text의 ID를 찾아줌</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT id from CICERON.</span><span class="si">%s</span><span class="s2"> WHERE text = &quot;</span> <span class="o">%</span> <span class="n">table</span>
    <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>            <span class="n">result</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="get_user_id"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.get_user_id">[문서]</a><span class="k">def</span> <span class="nf">get_user_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">text_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    이메이을 넣으면 해당 사용자의 ID를 찾아줌</span>
<span class="sd">    email은 indexing 해놨기때문에 성능상의 큰 문제는 없을것임</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id from CICERON.D_USERS WHERE email = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">text_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>            <span class="n">result</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="get_facebook_user_id"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.get_facebook_user_id">[문서]</a><span class="k">def</span> <span class="nf">get_facebook_user_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">text_id</span><span class="p">):</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id, real_id from CICERON.D_FACEBOOK_USERS WHERE email = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">text_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Duplicated facebook user ID&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>            <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="get_user_email"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.get_user_email">[문서]</a><span class="k">def</span> <span class="nf">get_user_email</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">num_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    User ID를 넣으면 email을 찾아주는 함수인데 얼마나 사용할진 모르겠음</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT email from CICERON.D_USERS WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="n">num_id</span><span class="p">])</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>            <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="get_user_name"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.get_user_name">[문서]</a><span class="k">def</span> <span class="nf">get_user_name</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">num_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    User ID를 넣으면 유저 이름을 찾아줌. 주로 이메일 날릴때 Dear xxx를 채우기 위하여 새용</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name from CICERON.D_USERS WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="n">num_id</span><span class="p">])</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>            <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="get_text_from_id"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.get_text_from_id">[문서]</a><span class="k">def</span> <span class="nf">get_text_from_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">id_num</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ID를 넣으면 해당 테이블의 text를 찾아줌</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT text from CICERON.</span><span class="si">%s</span><span class="s2"> WHERE id = &quot;</span> <span class="o">%</span> <span class="n">table</span>
    <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">id_num</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>            <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="get_new_id"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.get_new_id">[문서]</a><span class="k">def</span> <span class="nf">get_new_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    테이블에서 사용하는 sequece에서 새 ID를 따줌.</span>
<span class="sd">    이 기능을 사용하려면 seqeunce 이름을 SEQ_&lt;table_name&gt;으로 해야 함 (ex CICERON.SEQ_F_REQUESTS)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT nextval(&#39;CICERON.SEQ_</span><span class="si">%s</span><span class="s2">&#39;) &quot;</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
    <span class="n">current_id_list</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">current_id_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="get_path_from_id"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.get_path_from_id">[문서]</a><span class="k">def</span> <span class="nf">get_path_from_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">id_num</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT path from CICERON.</span><span class="si">%s</span><span class="s2"> WHERE id = &quot;</span> <span class="o">%</span> <span class="n">table</span>
    <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">id_num</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>            <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="get_group_id_from_user_and_text"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.get_group_id_from_user_and_text">[문서]</a><span class="k">def</span> <span class="nf">get_group_id_from_user_and_text</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT id FROM CICERON.</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">table</span>
    <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND text = </span><span class="si">%s</span><span class="s2"> &quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="get_device_id"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.get_device_id">[문서]</a><span class="k">def</span> <span class="nf">get_device_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT reg_key FROM CICERON.D_MACHINES WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND is_push_allowed = true&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">reg_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">reg_key</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span></div>

<div class="viewcode-block" id="parameter_to_bool"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.parameter_to_bool">[문서]</a><span class="k">def</span> <span class="nf">parameter_to_bool</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="get_total_amount"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.get_total_amount">[문서]</a><span class="k">def</span> <span class="nf">get_total_amount</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">is_additional</span><span class="o">=</span><span class="s1">&#39;false&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    네고 기능때문에 points 자체로는 총액이 되지 않기 때문에 nego_price와 더해줘야 한다.</span>
<span class="sd">    이 때, 총합을 계산하는 라이브러리</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">total_amount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">is_additional</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT points FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">total_amount</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT points FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">cur_amount</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT nego_price FROM CICERON.D_QUEUE_LISTS WHERE request_id = </span><span class="si">%s</span><span class="s2"> AND user_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">nego_amount</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">rs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nego_amount</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;ERROR&#39;</span>

        <span class="n">total_amount</span> <span class="o">=</span> <span class="n">nego_amount</span> <span class="o">-</span> <span class="n">cur_amount</span>

    <span class="k">return</span> <span class="n">total_amount</span></div>

<div class="viewcode-block" id="ddosCheckAndWriteLog"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.ddosCheckAndWriteLog">[문서]</a><span class="k">def</span> <span class="nf">ddosCheckAndWriteLog</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API 실행 전, 해당 IP에서 1초에 100번 이상 실행되면 30분동안 접속 차단한다.</span>
<span class="sd">    그리고 차단하지 않은 IP는 임시 테이블에 로그를 남겨 나중에 분석 자료로 이용한다.</span>

<span class="sd">    그리고 현재 로그를 쌓는 곳은 임시테이블이고, 30분에 한 번씩 Agent가 돌아 로그를 영구보관소로 옮긴다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;useremail&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span>
    <span class="n">api_endpoint</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">]</span>
    <span class="n">ip_address</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x-forwarded-for-client-ip&#39;</span><span class="p">)</span>

    <span class="n">query_apiCount</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT count(*) FROM CICERON.TEMP_ACTIONS_LOG</span>
<span class="s2">          WHERE (user_id = </span><span class="si">%s</span><span class="s2"> OR ip_address = </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">            AND log_time BETWEEN (CURRENT_TIMESTAMP - interval &#39;1 seconds&#39;) AND CURRENT_TIMESTAMP&quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_apiCount</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">conn_count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">query_getBlacklist</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT count(*) FROM CICERON.BLACKLIST</span>
<span class="s2">          WHERE user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            AND CURRENT_TIMESTAMP BETWEEN time_from AND time_to</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_getBlacklist</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">blacklist_count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">is_OK</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">conn_count</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;useremail&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">query_insertBlackList</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            INSERT INTO CICERON.BLACKLIST (id, user_id, ip_address, time_from, time_to)</span>
<span class="s2">            VALUES</span>
<span class="s2">            (</span>
<span class="s2">               nextval(&#39;CICERON.SEQ_BLACKLIST&#39;)</span>
<span class="s2">              ,</span><span class="si">%s</span><span class="s2"></span>
<span class="s2">              ,</span><span class="si">%s</span><span class="s2"></span>
<span class="s2">              ,CURRENT_TIMESTAMP</span>
<span class="s2">              ,CURRENT_TIMESTAMP + interval(&#39;30 minutes&#39;)</span>
<span class="s2">            )</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_insertBlackList</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">is_OK</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">blacklist_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;useremail&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">is_OK</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">query_insertLog</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO CICERON.TEMP_ACTIONS_LOG</span>
<span class="s2">          (id, user_id, method, api, log_time, ip_address)</span>
<span class="s2">        VALUES</span>
<span class="s2">          (</span>
<span class="s2">             nextval(&#39;CICERON.SEQ_USER_ACTIONS&#39;)</span>
<span class="s2">            ,</span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            ,</span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            ,</span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            ,CURRENT_TIMESTAMP</span>
<span class="s2">            ,</span><span class="si">%s</span><span class="s2"></span>
<span class="s2">          )</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_insertLog</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">api_endpoint</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">is_OK</span></div>

<div class="viewcode-block" id="apiURLOrganizer"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.apiURLOrganizer">[문서]</a><span class="k">def</span> <span class="nf">apiURLOrganizer</span><span class="p">(</span><span class="n">api_base</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">basic</span> <span class="o">=</span> <span class="n">api_base</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span>
    <span class="n">param</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">basic</span> <span class="o">+</span> <span class="n">query</span></div>

<div class="viewcode-block" id="login_required"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.login_required">[문서]</a><span class="k">def</span> <span class="nf">login_required</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DDOS 공격 검출기로 해당 IP가 블랙 리스트에 올라갔는지, 그리고 블랙 리스트에 올려야 하는지 살펴본다.</span>
<span class="sd">    아무 이상이 없다면 로그인이 되어 있는지 세션 설정값을 본다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">is_ddos_free</span> <span class="o">=</span> <span class="n">ddosCheckAndWriteLog</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;useremail&#39;</span> <span class="ow">in</span> <span class="n">session</span> <span class="ow">and</span> <span class="n">is_ddos_free</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_ddos_free</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                       <span class="n">status_code</span> <span class="o">=</span> <span class="mi">499</span><span class="p">,</span>
                       <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Blocked connection&quot;</span>
               <span class="p">),</span> <span class="mi">499</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                       <span class="n">status_code</span> <span class="o">=</span> <span class="mi">403</span><span class="p">,</span>
                       <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Login required&quot;</span>
               <span class="p">),</span> <span class="mi">403</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decorated_function</span></div>

<div class="viewcode-block" id="admin_required"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.admin_required">[문서]</a><span class="k">def</span> <span class="nf">admin_required</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Admin으로 로그인되어 있는지 체크한다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;useremail&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                       <span class="n">status_code</span> <span class="o">=</span> <span class="mi">403</span><span class="p">,</span>
                       <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Admin only&quot;</span>
               <span class="p">),</span> <span class="mi">403</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">decorated_function</span></div>

<div class="viewcode-block" id="exception_detector"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.exception_detector">[문서]</a><span class="k">def</span> <span class="nf">exception_detector</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span><span class="mi">500</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decorated_function</span></div>

<div class="viewcode-block" id="translator_checker"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.translator_checker">[문서]</a><span class="k">def</span> <span class="nf">translator_checker</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    번역가 권한이 있는 유저인지 체크한다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT is_translator FROM CICERON.D_USERS WHERE email = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                       <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;You are not translator. This API is only for translators.&quot;</span>
                       <span class="p">),</span> <span class="mi">403</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decorated_function</span></div>

<div class="viewcode-block" id="translator_checker_plain"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.translator_checker_plain">[문서]</a><span class="k">def</span> <span class="nf">translator_checker_plain</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    위와 같은 일을 하나, 이건 decorator가 아니다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT is_translator FROM CICERON.D_USERS WHERE email = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">rs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="strict_translator_checker"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.strict_translator_checker">[문서]</a><span class="k">def</span> <span class="nf">strict_translator_checker</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    번역가가 해당 의뢰를 번역할 수 있는지 체크</span>
<span class="sd">        1. 해당 의뢰의 언어쌍 조사</span>
<span class="sd">        2. 모국어와 구사가능언어를 수집하여 두 언어 모두 구사가능 언어인지 살펴봄.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT is_translator, mother_language_id, other_language_list_id FROM CICERON.D_USERS WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span> <span class="ow">or</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Get language list</span>
    <span class="n">mother_language_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT language_id FROM CICERON.D_TRANSLATABLE_LANGUAGES WHERE user_id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">language_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="p">]</span>
    <span class="n">language_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mother_language_id</span><span class="p">)</span>

    <span class="c1"># Check request language</span>
    <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT original_lang_id, target_lang_id FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT original_lang_id, target_lang_id FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2"> AND is_paid = true &quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="n">original_lang_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">target_lang_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">original_lang_id</span> <span class="ow">in</span> <span class="n">language_list</span> <span class="ow">and</span> <span class="n">target_lang_id</span> <span class="ow">in</span> <span class="n">language_list</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>

        <span class="c1">#return make_response(</span>
        <span class="c1">#        json.jsonify(</span>
        <span class="c1">#           message = &quot;You are not translator. This API is only for translators.&quot;</span>
        <span class="c1">#           ), 401)</span>

<div class="viewcode-block" id="translationAuthChecker"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.translationAuthChecker">[문서]</a><span class="k">def</span> <span class="nf">translationAuthChecker</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">status_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    실제 해당 번역가 유저가 번역하고 있는 의뢰인지 살펴봄</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT count(*) FROM CICERON.V_REQUESTS WHERE status_id = </span><span class="si">%s</span><span class="s2"> AND request_id = </span><span class="si">%s</span><span class="s2"> AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">status_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="clientAuthChecker"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.clientAuthChecker">[문서]</a><span class="k">def</span> <span class="nf">clientAuthChecker</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">status_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    실제 자신이 의뢰한 티켓인지 살펴봄</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT count(*) FROM CICERON.V_REQUESTS WHERE status_id = </span><span class="si">%s</span><span class="s2"> AND request_id = </span><span class="si">%s</span><span class="s2"> AND client_user_id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">status_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="crossdomain"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.crossdomain">[문서]</a><span class="k">def</span> <span class="nf">crossdomain</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">max_age</span><span class="o">=</span><span class="mi">21600</span><span class="p">,</span> <span class="n">attach_to_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">automatic_options</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Max-Age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_age</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span>

    <span class="k">return</span> <span class="n">decorator</span></div>

<div class="viewcode-block" id="orderNoGenerator"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.orderNoGenerator">[문서]</a><span class="k">def</span> <span class="nf">orderNoGenerator</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iamport 방식으로 결제할 때에는 주문번호를 만들어 주지 않기 때문에 우리가 직접 만들어야 한다.</span>
<span class="sd">    주문번호 형식은 YYYYMMDDxxxx (ex 20160716abcd) 방식으로 한다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">order_no</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">order_no</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">random_string_gen</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT count(*) FROM CICERON.PAYMENT_INFO WHERE order_no = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">order_no</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="n">order_no</span></div>

<div class="viewcode-block" id="getProfile"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.getProfile">[문서]</a><span class="k">def</span> <span class="nf">getProfile</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    프로파일 조회</span>
<span class="sd">    D_USERS와 그 밖에 필요한 정보들을 JSON 형태로 보여줌</span>

<span class="sd">    옛날 기획에 뱃지도 보여주자 했는데 현재는 중단된 상태.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">query_userinfo</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT  </span>
<span class="s2">            id, email, name, mother_language_id, is_translator,</span>
<span class="s2">            other_language_list_id, profile_pic_path,</span>
<span class="s2">            numOfRequestPending, numOfRequestOngoing, numOfRequestCompleted,</span>
<span class="s2">            numOfTranslationPending, numOfTranslationOngoing, numOfTranslationCompleted,</span>
<span class="s2">            badgeList_id, profile_text, trans_request_state, nationality, residence</span>
<span class="s2">        FROM CICERON.D_USERS WHERE id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_userinfo</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">userinfo</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT language_id FROM CICERON.D_TRANSLATABLE_LANGUAGES WHERE user_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">other_language_list</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="p">]</span> <span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT badge_id FROM CICERON.D_AWARDED_BADGES WHERE user_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">badgeList</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="p">])</span>

    <span class="c1"># GET list: user&#39;s keywords</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT key.text FROM CICERON.D_USER_KEYWORDS ids JOIN CICERON.D_KEYWORDS key ON ids.keyword_id = key.id WHERE ids.user_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="p">])</span>

    <span class="n">result</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">user_email</span><span class="o">=</span>                     <span class="nb">str</span><span class="p">(</span><span class="n">userinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">user_name</span><span class="o">=</span>                      <span class="nb">str</span><span class="p">(</span><span class="n">userinfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
        <span class="n">user_motherLang</span><span class="o">=</span>                <span class="n">userinfo</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="n">user_profilePicPath</span><span class="o">=</span>            <span class="nb">str</span><span class="p">(</span><span class="n">userinfo</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="k">if</span> <span class="n">userinfo</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;img/anon.jpg&#39;</span><span class="p">,</span>
        <span class="n">user_translatableLang</span><span class="o">=</span>          <span class="n">other_language_list</span><span class="p">,</span>
        <span class="n">user_numOfRequestsPending</span><span class="o">=</span>       <span class="n">userinfo</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
        <span class="n">user_numOfRequestsOngoing</span><span class="o">=</span>       <span class="n">userinfo</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
        <span class="n">user_numOfRequestsCompleted</span><span class="o">=</span>     <span class="n">userinfo</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
        <span class="n">user_numOfTranslationsPending</span><span class="o">=</span>   <span class="n">userinfo</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
        <span class="n">user_numOfTranslationsOngoing</span><span class="o">=</span>   <span class="n">userinfo</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
        <span class="n">user_numOfTranslationsCompleted</span><span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span>
        <span class="n">user_badgeList</span><span class="o">=</span>                 <span class="n">badgeList</span><span class="p">,</span>
        <span class="n">user_isTranslator</span><span class="o">=</span>              <span class="kc">True</span> <span class="k">if</span> <span class="n">userinfo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">user_profileText</span><span class="o">=</span>               <span class="nb">str</span><span class="p">(</span><span class="n">userinfo</span><span class="p">[</span><span class="mi">14</span><span class="p">]),</span>
        <span class="n">user_revenue</span><span class="o">=</span>                   <span class="o">-</span><span class="mi">65535</span><span class="p">,</span>
        <span class="n">user_keywords</span><span class="o">=</span>                   <span class="n">keywords</span><span class="p">,</span>
        <span class="n">user_transRequestState</span><span class="o">=</span>         <span class="n">userinfo</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span>
        <span class="n">user_nationality</span><span class="o">=</span>                 <span class="n">userinfo</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span>
        <span class="n">user_residence</span><span class="o">=</span>                 <span class="n">userinfo</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">price</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;user_additionalPoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price</span>

    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="json_from_V_REQUESTS"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.json_from_V_REQUESTS">[문서]</a><span class="k">def</span> <span class="nf">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;newsfeed&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    의뢰에 관련된 모든 정보를 JSON 형태로 보여줌. 권한이랑 포인트 등등 때문에 적잖이 로직이 복잡하다.</span>

<span class="sd">        1. return_rate: 기본 0.7. 번역가는 개별적으로 환급 비율을 따로 설정할 수 있다. </span>
<span class="sd">          의뢰인이 가격을 10이라고 설정했어도, 번역가에게는 받아갈 돈 7로 표시하기 위하여 쿼리질을 한다.</span>
<span class="sd">        2. CICERON.V_QUEUE_LISTS 에서 해당 티켓에 네고를 건 사용자 프로필들을 조회해온다.</span>
<span class="sd">        3. 글자수 및 단어수 계산</span>
<span class="sd">        4. 그 밖에.. 번역가와 의뢰인, 단문 번역과 일반 번역, 그리고 번역 status에 따라 보여주고 가려야 할 내용 통제를 로직으로 수행한다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Return rate</span>
    <span class="n">query_returnRate</span> <span class="o">=</span> <span class="s2">&quot;SELECT return_rate FROM CICERON.D_USERS WHERE email = </span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_returnRate</span><span class="p">,</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span> <span class="p">))</span>
    <span class="n">ret_returnRate</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="n">return_rate</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">ret_returnRate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret_returnRate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">return_rate</span> <span class="o">=</span> <span class="n">ret_returnRate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">warehouse</span> <span class="o">=</span> <span class="n">Warehousing</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">:</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># For fetching translators in queue</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM CICERON.V_QUEUE_LISTS WHERE request_id = </span><span class="si">%s</span><span class="s2"> ORDER BY user_id&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>

        <span class="n">queue_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">q_item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">getProfile</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">q_item</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rate</span><span class="o">=</span><span class="n">return_rate</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="n">q_item</span><span class="p">[</span><span class="mi">17</span><span class="p">])</span>
            <span class="n">queue_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>

        <span class="c1"># For getting word count of the request</span>
        <span class="c1">#request_id = row[30]</span>
        <span class="n">text_for_counting</span> <span class="o">=</span> <span class="n">warehouse</span><span class="o">.</span><span class="n">restoreRequestByString</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_for_counting</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_of_words</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">num_of_letters</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_of_letters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_for_counting</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">num_of_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_for_counting</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>

        <span class="n">main_text</span> <span class="o">=</span> <span class="n">text_for_counting</span>

        <span class="n">item</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">request_clientId</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">request_clientName</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                <span class="n">request_clientPicPath</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;img/anon.jpg&#39;</span><span class="p">,</span>
                <span class="n">request_originalLang</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
                <span class="n">request_targetLang</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span>
                <span class="n">request_isSos</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span>
                <span class="n">request_format</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">19</span><span class="p">],</span>
                <span class="n">request_subject</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span>
                <span class="n">request_isText</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">29</span><span class="p">],</span>
                <span class="n">request_text</span><span class="o">=</span><span class="n">main_text</span><span class="p">,</span>
                <span class="n">request_isPhoto</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span>
                <span class="n">request_photoPath</span><span class="o">=</span><span class="n">get_path_from_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="s2">&quot;D_REQUEST_PHOTOS&quot;</span><span class="p">),</span>
                <span class="n">request_isSound</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">35</span><span class="p">],</span>
                <span class="n">request_soundPath</span><span class="o">=</span><span class="n">get_path_from_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">36</span><span class="p">],</span> <span class="s2">&quot;D_REQUEST_SOUNDS&quot;</span><span class="p">),</span>
                <span class="n">request_isFile</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">33</span><span class="p">],</span>
                <span class="n">request_filePath</span><span class="o">=</span><span class="n">get_path_from_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">34</span><span class="p">],</span> <span class="s2">&quot;D_REQUEST_FILES&quot;</span><span class="p">),</span>
                <span class="n">request_context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># For marking</span>
                <span class="n">request_status</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span>
                <span class="n">request_registeredTime</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">request_dueTime</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">request_transStartTime</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">55</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">55</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">request_expectedTime</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">request_words</span><span class="o">=</span><span class="n">num_of_words</span><span class="p">,</span>
                <span class="n">request_letters</span><span class="o">=</span><span class="n">num_of_letters</span><span class="p">,</span>
                <span class="n">request_points</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="k">if</span> <span class="n">purpose</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;client&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">row</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">*</span> <span class="n">return_rate</span><span class="p">,</span>
                <span class="n">request_translatorsInQueue</span><span class="o">=</span><span class="n">queue_list</span><span class="p">,</span>
                <span class="n">request_translatorId</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                <span class="n">request_translatorName</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                <span class="n">request_translatorPicPath</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;img/anon.jpg&#39;</span><span class="p">,</span>
                <span class="n">request_translatorBadgeList</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># For marking</span>
                <span class="n">request_translatedText</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># For marking</span>
                <span class="n">request_translatorComment</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">40</span><span class="p">],</span>
                <span class="n">request_translatedTone</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">42</span><span class="p">],</span>
                <span class="n">request_submittedTime</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">request_feedbackScore</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">54</span><span class="p">],</span>
                <span class="n">request_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># For marking</span>
                <span class="n">request_isI18n</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">59</span><span class="p">],</span>
                <span class="n">request_isMovie</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">60</span><span class="p">],</span>
                <span class="n">request_isGroupRequest</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">61</span><span class="p">],</span>
                <span class="n">request_isDocx</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">62</span><span class="p">],</span>
                <span class="n">request_isPublic</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">63</span><span class="p">],</span>
                <span class="n">request_resellPrice</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span>
                <span class="n">request_isCopyrightChecked</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">65</span><span class="p">],</span>
                <span class="n">request_numberOfMemberInGroup</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">66</span><span class="p">],</span>
                <span class="n">request_currentNumberOfMember</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">67</span><span class="p">],</span>
                <span class="n">request_isCopyrightConfirmed</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">68</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_isAdditionalPointNeeded&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">56</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">purpose</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;client&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="mi">57</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_addionalPoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">57</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">purpose</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;client&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="mi">57</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_addionalPoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">57</span><span class="p">]</span> <span class="o">*</span> <span class="n">return_rate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_addionalPoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_isAdditionalPointPaid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">58</span><span class="p">]</span> 

        <span class="k">if</span> <span class="n">purpose</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;stoa&quot;</span><span class="p">):</span>
            <span class="c1"># Show context if normal request, or show main text</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># True</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_text</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_translatedText&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_text</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_soundPath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_photoPath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_filePath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="n">purpose</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pending_client&quot;</span><span class="p">,</span> <span class="s2">&quot;pending_translator&quot;</span><span class="p">]:</span>
            <span class="c1"># Show context if normal request, or show main text</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># True</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_text</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_translatedText&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">warehouse</span><span class="o">.</span><span class="n">restoreTranslationByString</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">purpose</span> <span class="o">==</span> <span class="s2">&quot;ongoing_translator&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_text</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_text</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span>

            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_translatedText&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">warehouse</span><span class="o">.</span><span class="n">restoreTranslationByString</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">purpose</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;complete_translator&quot;</span><span class="p">,</span> <span class="s2">&quot;complete_client&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_text</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_text</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span>

            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_translatedText&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">warehouse</span><span class="o">.</span><span class="n">restoreTranslationByString</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">purpose</span> <span class="o">==</span> <span class="s2">&quot;ongoing_client&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># False</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">purpose</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;complete&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">purpose</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ongoing&#39;</span><span class="p">):</span>
            <span class="c1"># For getting translator&#39;s badges</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT badge_id FROM CICERON.D_AWARDED_BADGES WHERE id = (SELECT badgeList_id FROM CICERON.D_USERS WHERE id = </span><span class="si">%s</span><span class="s2"> LIMIT 1)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="p">))</span>
            <span class="n">badge_list</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="p">])</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;request_translatorBadgeList&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">badge_list</span>

            <span class="c1"># Add profile for translator</span>

            <span class="n">translator_info</span> <span class="o">=</span> <span class="n">getProfile</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;translatorInfo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translator_info</span> <span class="k">if</span> <span class="n">translator_info</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="complete_groups"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.complete_groups">[문서]</a><span class="k">def</span> <span class="nf">complete_groups</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url_group_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    그룹 조회, 생성, 그룹명 수정, 및 삭제 라이브러리</span>
<span class="sd">    기능은 똑같지만 번역가와 의뢰인계정이 쓰는 테이블 이름이 다르기에 라이브러리화 시키고 테이블 이름을 받아 동일한 로직을 사용할 수 있도록 구성하였다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">my_user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT id, text FROM CICERON.</span><span class="si">%s</span><span class="s2"> WHERE user_id = &quot;</span> <span class="o">%</span> <span class="n">table</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &quot;</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND registered_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">since</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;ORDER BY id DESC &quot;</span>
        <span class="k">if</span> <span class="n">page</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">my_user_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rs</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;group_name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="s2">&quot;Incoming&quot;</span> <span class="ow">or</span> <span class="n">group_name</span> <span class="o">==</span> <span class="s1">&#39;Incoming&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">my_user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

        <span class="n">query_count</span> <span class="o">=</span> <span class="s2">&quot;SELECT count(*) FROM CICERON.</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">table</span>
        <span class="n">query_count</span> <span class="o">+=</span> <span class="s2">&quot;WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND text = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_count</span><span class="p">,</span> <span class="p">(</span><span class="n">my_user_id</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">new_group_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO CICERON.</span><span class="si">%s</span><span class="s2"> VALUES &quot;</span> <span class="o">%</span> <span class="n">table</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">new_group_id</span><span class="p">,</span> <span class="n">my_user_id</span><span class="p">,</span> <span class="n">group_name</span><span class="p">))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">group_name</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;PUT&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">url_group_id</span><span class="p">)</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;group_name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="s2">&quot;Incoming&quot;</span> <span class="ow">or</span> <span class="n">group_name</span> <span class="o">==</span> <span class="s2">&quot;Incoming&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;UPDATE CICERON.</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">table</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;SET text = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">group_name</span><span class="p">,</span> <span class="n">group_id</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">group_name</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">group_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">url_group_id</span><span class="p">)</span>
        <span class="n">group_text</span> <span class="o">=</span> <span class="n">get_text_from_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_text</span> <span class="o">==</span> <span class="s2">&quot;Incoming&quot;</span> <span class="ow">or</span> <span class="n">group_text</span> <span class="o">==</span> <span class="s1">&#39;Incoming&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">group_text</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">2</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM CICERON.</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">table</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span> <span class="p">,</span> <span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="p">))</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">default_group_id</span> <span class="o">=</span> <span class="n">get_group_id_from_user_and_text</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;Incoming&quot;</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;TRANSLATOR&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;translator_completed_group_id&#39;</span>
        <span class="k">else</span><span class="p">:</span>                             <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;client_completed_group_id&#39;</span>

        <span class="n">query_update_temp</span> <span class="o">=</span> <span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET </span><span class="si">%(col)s</span><span class="s2"> = ? WHERE </span><span class="si">%(col)s</span><span class="s2"> = ?&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;col&#39;</span><span class="p">:</span><span class="n">col</span><span class="p">}</span>
        <span class="n">query_update</span> <span class="o">=</span> <span class="n">query_update_temp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_update</span><span class="p">,</span> <span class="p">(</span><span class="n">default_group_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">))</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">group_id</span></div>

<div class="viewcode-block" id="save_request"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.save_request">[문서]</a><span class="k">def</span> <span class="nf">save_request</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">str_request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    번역을 완료하면서 마지막 코멘트, 글의 톤 등을 저장하는 데 쓰이는 라이브러리이다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_request_id</span><span class="p">)</span>
    <span class="n">new_comment</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;request_comment&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">new_tone</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;request_tone&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT translatedText, comment_id, tone_id FROM CICERON.V_REQUESTS WHERE request_id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="n">translatedText_path</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">comment_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">tone_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Save new comment</span>
    <span class="k">if</span> <span class="n">new_comment</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">comment_id</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.D_COMMENTS SET text = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">new_comment</span><span class="p">,</span> <span class="n">comment_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comment_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;D_COMMENTS&quot;</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.D_COMMENTS VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">comment_id</span><span class="p">,</span> <span class="n">new_comment</span><span class="p">))</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET comment_id = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">comment_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">))</span>

    <span class="c1"># Save new tone</span>
    <span class="k">if</span> <span class="n">new_tone</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tone_id</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.D_TONES SET text = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">new_tone</span><span class="p">,</span> <span class="n">tone_id</span><span class="p">))</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET tone_id = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">tone_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tone_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;D_TONES&quot;</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.D_TONES VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">tone_id</span><span class="p">,</span> <span class="n">new_tone</span><span class="p">))</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET tone_id = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">tone_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">))</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="update_user_record"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.update_user_record">[문서]</a><span class="k">def</span> <span class="nf">update_user_record</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">translator_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">client_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;UPDATE CICERON.D_USERS SET </span>
<span class="s2">                numOfRequestPending = (SELECT count(id) FROM CICERON.F_REQUESTS WHERE status_id = 0 AND client_user_id = </span><span class="si">%s</span><span class="s2">),</span>
<span class="s2">                numOfRequestOngoing = (SELECT count(id) FROM CICERON.F_REQUESTS WHERE status_id = 1 AND client_user_id = </span><span class="si">%s</span><span class="s2">),</span>
<span class="s2">                numOfRequestCompleted = (SELECT count(id) FROM CICERON.F_REQUESTS WHERE status_id = 2 AND client_user_id = </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">client_id</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">translator_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;UPDATE CICERON.D_USERS SET </span>
<span class="s2">                numOfTranslationPending = (SELECT count(queue.id) FROM CICERON.F_REQUESTS fact LEFT OUTER JOIN CICERON.D_QUEUE_LISTS queue ON fact.queue_id = queue.id WHERE fact.status_id = 0 AND queue.user_id = </span><span class="si">%s</span><span class="s2"> ),</span>
<span class="s2">                numOfTranslationOngoing = (SELECT count(id) FROM CICERON.F_REQUESTS WHERE status_id = 1 AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> ),</span>
<span class="s2">                numOfTranslationCompleted = (SELECT count(id) FROM CICERON.F_REQUESTS WHERE status_id = 2 AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> )</span>
<span class="s2">                WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">translator_id</span><span class="p">,</span> <span class="n">translator_id</span><span class="p">,</span> <span class="n">translator_id</span><span class="p">,</span> <span class="n">translator_id</span><span class="p">))</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="parse_request"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.parse_request">[문서]</a><span class="k">def</span> <span class="nf">parse_request</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    application/json, application/x-wwwurlencode, multipart/form-data 같은 다양한 형식에서도</span>
<span class="sd">    POST request를 python dict 형태로 나타낼 수 있게 만들어주는 라이브러리이다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">form</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">parameter_list</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parameter_list</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parameter_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">return</span> <span class="n">result</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">form</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">return</span> <span class="n">result</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span></div>
 
<div class="viewcode-block" id="send_push"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.send_push">[문서]</a><span class="k">def</span> <span class="nf">send_push</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">gcm_obj</span><span class="p">,</span>
              <span class="n">user_ids</span><span class="p">,</span>
              <span class="n">message</span><span class="p">,</span>
              <span class="n">collapse_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">delay_while_idle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">time_to_live</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">restricted_package_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">dry_run</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    푸시 알람 날려주는 API이다. 근데 잘 안먹힌다. 이유는 모르겠다. 경험자가 필요하다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">registration_keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">user_ids</span><span class="p">:</span>
        <span class="n">user_number</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT reg_key FROM CICERON.D_MACHINES WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND is_push_allowed = true&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_number</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">client_infos</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c1"># Gather registration IDs</span>
        <span class="n">registration_keys</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">client_infos</span> <span class="p">])</span>

    <span class="n">notification</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">),</span>
            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;detail&#39;</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="c1"># Send one message to devices at once</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">registration_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">gcm_obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">registration_keys</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span>
                    <span class="n">collapse_key</span><span class="o">=</span><span class="n">collapse_key</span><span class="p">,</span>
                    <span class="n">delay_while_idle</span><span class="o">=</span><span class="n">delay_while_idle</span><span class="p">,</span>
                    <span class="n">time_to_live</span><span class="o">=</span><span class="n">time_to_live</span><span class="p">,</span>
                    <span class="n">restricted_package_name</span><span class="o">=</span><span class="n">restricted_package_name</span><span class="p">,</span>
                    <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span>
                    <span class="n">notification</span><span class="o">=</span><span class="n">notification</span>
                    <span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="send_mail"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.send_mail">[문서]</a><span class="k">def</span> <span class="nf">send_mail</span><span class="p">(</span><span class="n">mail_to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">mail_from</span><span class="o">=</span><span class="s1">&#39;no-reply@ciceron.me&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    주어진 mesasge를 메일로 날려주는 라이브러리이다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">smtplib</span>
    <span class="kn">import</span> <span class="nn">base64</span>
    <span class="kn">from</span> <span class="nn">email.mime.multipart</span> <span class="k">import</span> <span class="n">MIMEMultipart</span>
    <span class="kn">from</span> <span class="nn">email.mime.text</span> <span class="k">import</span> <span class="n">MIMEText</span>

    <span class="n">content</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">_charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEMultipart</span><span class="p">(</span><span class="s1">&#39;alternative&#39;</span><span class="p">)</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;From&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CICERON team &lt;</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="n">mail_from</span>
    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mail_to</span><span class="p">)</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="s1">&#39;smtp.gmail.com:587&#39;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
    <span class="n">a</span><span class="o">.</span><span class="n">starttls</span><span class="p">()</span>
    <span class="n">a</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s1">&#39;no-reply@ciceron.me&#39;</span><span class="p">,</span> <span class="s1">&#39;ciceron3388!&#39;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="s1">&#39;no-reply@ciceron.me&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mail_to</span><span class="p">),</span> <span class="n">msg</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>
    <span class="n">a</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span></div>

<div class="viewcode-block" id="store_notiTable"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.store_notiTable">[문서]</a><span class="k">def</span> <span class="nf">store_notiTable</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">noti_type_id</span><span class="p">,</span> <span class="n">target_user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    노테를 테이블에 쌓아준다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">new_noti_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;F_NOTIFICATION&quot;</span><span class="p">)</span>
    <span class="c1"># The query below is original</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO CICERON.F_NOTIFICATION VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,CURRENT_TIMESTAMP,false,false)&quot;</span>
    <span class="c1"># The query below is that mail alarm is forcefully turned off</span>
    <span class="c1">#query = &quot;INSERT INTO F_NOTIFICATION VALUES (?,?,?,?,CURRENT_TIMESTAMP,1)&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">new_noti_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">noti_type_id</span><span class="p">,</span> <span class="n">target_user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="pick_random_translator"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.pick_random_translator">[문서]</a><span class="k">def</span> <span class="nf">pick_random_translator</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">from_lang</span><span class="p">,</span> <span class="n">to_lang</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    해당 언어쌍을 번역할 수 있는 번역가를 랜덤으로 number명만큼 추출하여 준다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;WITH translators AS (</span>
<span class="s2">                   SELECT distinct usr.id usr_id FROM CICERON.D_USERS usr</span>
<span class="s2">        JOIN CICERON.V_TRANSLATABLE_LANGUAGES trans ON usr.id = trans.user_id</span>
<span class="s2">        JOIN CICERON.V_TRANSLATABLE_LANGUAGES trans2 ON usr.id = trans2.user_id</span>
<span class="s2">        WHERE (usr.mother_language_id = </span><span class="si">%s</span><span class="s2"> AND trans.translatable_language_id = </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">           OR (trans.translatable_language_id = </span><span class="si">%s</span><span class="s2"> AND usr.mother_language_id = </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">           OR (trans.translatable_language_id = </span><span class="si">%s</span><span class="s2"> AND trans2.translatable_language_id = </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">           )</span>
<span class="s2">           SELECT distinct usr_id FROM translators OFFSET FLOOR(RANDOM() * (SELECT COUNT(*) FROM translators)) LIMIT </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">from_lang</span><span class="p">,</span> <span class="n">to_lang</span><span class="p">,</span> <span class="n">from_lang</span><span class="p">,</span> <span class="n">to_lang</span><span class="p">,</span> <span class="n">from_lang</span><span class="p">,</span> <span class="n">to_lang</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="string2Date"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.string2Date">[문서]</a><span class="k">def</span> <span class="nf">string2Date</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="getRoutingAddressAndAlertType"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.getRoutingAddressAndAlertType">[문서]</a><span class="k">def</span> <span class="nf">getRoutingAddressAndAlertType</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">noti_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    노티에서 링크를 제공할 때, request의 상태를 파악하여 좀 더 똑똑하게 링크를 주기 위함이다.</span>

<span class="sd">    테스트 시스템인지, 프로덕션 시스템인지..</span>
<span class="sd">    티켓이 기간 만료인지, 삭제인지, 그 밖인지</span>
<span class="sd">    유저가 번역가인지 아닌지</span>
<span class="sd">    등등을 고려하여 라우팅 주소를 만든다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">requesterNoti</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span>
    <span class="n">translatorNotiType</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>

    <span class="n">HOST</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PURPOSE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;PROD&#39;</span><span class="p">:</span>
        <span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;http://ciceron.me&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;http://ciceron.xyz&#39;</span>

    <span class="n">isAlert</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">alertType</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">link</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">queryGetStatus</span> <span class="o">=</span> <span class="s2">&quot;SELECT is_paid, status_id, ongoing_worker_id FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">queryGetStatus</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,)</span> <span class="p">)</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="n">is_paid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">status_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">translator_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">status_id</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
        <span class="c1"># Deleted or outdated request</span>
        <span class="n">isAlert</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">alertType</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Not existing</span>
        <span class="n">link</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">elif</span> <span class="n">status_id</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">is_paid</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Ticket in stoa</span>
        <span class="n">isAlert</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">alertType</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="s1">&#39;stoa&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">status_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">is_paid</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">noti_type</span> <span class="ow">in</span> <span class="n">translatorNotiType</span> <span class="ow">and</span> <span class="n">user_id</span> <span class="o">!=</span> <span class="n">translator_id</span><span class="p">:</span>
        <span class="c1"># Not my ticket / ongoing, closed ticket</span>
        <span class="n">isAlert</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">alertType</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Cannot access</span>
        <span class="n">link</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">elif</span> <span class="n">status_id</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">is_paid</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">noti_type</span> <span class="ow">in</span> <span class="n">translatorNotiType</span> <span class="ow">and</span> <span class="n">user_id</span> <span class="o">==</span> <span class="n">translator_id</span><span class="p">:</span>
        <span class="c1"># My ongoing ticket / Expected due</span>
        <span class="n">isAlert</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">alertType</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="s1">&#39;translating&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
        
    <span class="k">elif</span> <span class="n">status_id</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">is_paid</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">noti_type</span> <span class="ow">in</span> <span class="n">translatorNotiType</span> <span class="ow">and</span> <span class="n">user_id</span> <span class="o">==</span> <span class="n">translator_id</span><span class="p">:</span>
        <span class="n">isAlert</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">alertType</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="s1">&#39;activity&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">status_id</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">is_paid</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">noti_type</span> <span class="ow">in</span> <span class="n">requesterNoti</span><span class="p">:</span>
        <span class="c1"># My ongoing ticket / Expected due</span>
        <span class="n">isAlert</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">alertType</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="s1">&#39;processingrequests&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
        
    <span class="k">elif</span> <span class="n">status_id</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">is_paid</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">noti_type</span> <span class="ow">in</span> <span class="n">requesterNoti</span><span class="p">:</span>
        <span class="n">isAlert</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">alertType</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="s1">&#39;donerequests&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">noti_type</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">):</span>
        <span class="n">isAlert</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">alertType</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">isAlert</span><span class="p">,</span> <span class="n">alertType</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_noti_data"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.get_noti_data">[문서]</a><span class="k">def</span> <span class="nf">get_noti_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">noti_type</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">optional_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    노티 데이터를 제공한다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">HOST</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PURPOSE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;PROD&#39;</span><span class="p">:</span>
        <span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;http://ciceron.me&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;http://ciceron.xyz&#39;</span>

    <span class="n">user_name</span> <span class="o">=</span> <span class="n">get_user_name</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>

    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
         <span class="s2">&quot;notiType&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
         <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="n">HOST</span><span class="p">,</span>
         <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">user_name</span><span class="p">,</span>
         <span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
         <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
         <span class="s2">&quot;hero&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
         <span class="s2">&quot;new_due&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
         <span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="n">request_id</span><span class="p">,</span>
         <span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="n">getRoutingAddressAndAlertType</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">noti_type</span><span class="p">)</span>
         <span class="p">}</span>

    <span class="k">if</span> <span class="n">noti_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;notiType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;New request!&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;New ticket is waiting for your help!&quot;</span>

    <span class="k">elif</span> <span class="n">noti_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;notiType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;When could you finish?&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Inform your deadline to the client!&quot;</span>

    <span class="k">elif</span> <span class="n">noti_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;notiType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Check client&#39;s feedback :)&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Client left a feedback for your help:) Please check it!&quot;</span>
            
    <span class="k">elif</span> <span class="n">noti_type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;notiType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Deadline exceeded :(&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Deadline of your ticket has just exceeded. Client will decide how to deal with.&quot;</span>

    <span class="k">elif</span> <span class="n">noti_type</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;notiType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;new_due&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optional_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new_due&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;You can work for your ticket more!&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Client has just exteneded the deadline! Please be strict the deadline for this time :)&quot;</span>

    <span class="k">elif</span> <span class="n">noti_type</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;notiType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No expected deadline :(&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Your ticket has just been put back into stoa due to no answer of deadline :( Please make sure to answer deadline until one third of deadline.&quot;</span>

    <span class="k">elif</span> <span class="n">noti_type</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;notiType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;hero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_user_name</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">optional_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hero&#39;</span><span class="p">))</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Hero comes!&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Hero has just started working for your ticket!&quot;</span>

    <span class="k">elif</span> <span class="n">noti_type</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;notiType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;expected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">optional_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expected&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">optional_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expected&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Check expected deadline&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Hero thinks that your ticket can be finished by XX:XX:XX&quot;</span>

    <span class="k">elif</span> <span class="n">noti_type</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;notiType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;hero&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_user_name</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">optional_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hero&#39;</span><span class="p">))</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Hero gave up translation :(&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Hero checked your ticket but he/she gave up translating.&quot;</span>

    <span class="k">elif</span> <span class="n">noti_type</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;notiType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No expected deadline from hero :(&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Hero didn&#39;t answer when the ticket could be finished. Your request is put into stoa.&quot;</span>

    <span class="k">elif</span> <span class="n">noti_type</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;notiType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Translation complete!&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Your ticket has just been finished translating! Please rate the translation queality of your ticket!&quot;</span>

    <span class="k">elif</span> <span class="n">noti_type</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;notiType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Deadline exceeded :(&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Your hero didn&#39;t finish your ticket yet.&quot;</span>

    <span class="k">elif</span> <span class="n">noti_type</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;notiType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No hero for your ticket :(&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No hero comes for your ticket. You may keep posting in stoa, or delete the ticket.&quot;</span>

    <span class="k">elif</span> <span class="n">noti_type</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;notiType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Point returned :)&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Your points has just paid back to your account!&quot;</span>

    <span class="k">return</span> <span class="n">message</span></div>

<div class="viewcode-block" id="send_noti_suite"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.send_noti_suite">[문서]</a><span class="k">def</span> <span class="nf">send_noti_suite</span><span class="p">(</span><span class="n">gcm_server</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">noti_type_id</span><span class="p">,</span> <span class="n">target_user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">optional_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    파라미터를 받아와</span>
<span class="sd">    노티 테이블에 넣고</span>
<span class="sd">    어떤 메시지를 줄 지 가져온다음 푸시 알람 및 메일까지 날려주는 종합 노티 라이브러리 함수이다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">store_notiTable</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">noti_type_id</span><span class="p">,</span> <span class="n">target_user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
    <span class="n">message_dict</span> <span class="o">=</span> <span class="n">get_noti_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">noti_type_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">optional_info</span><span class="o">=</span><span class="n">optional_info</span><span class="p">)</span>
    <span class="n">regKeys_oneuser</span> <span class="o">=</span> <span class="n">get_device_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="c1">#print &quot;Send push to the device: %s&quot; % regKeys_oneuser</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">regKeys_oneuser</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">gcm_noti</span> <span class="o">=</span> <span class="n">gcm_server</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">regKeys_oneuser</span><span class="p">,</span> <span class="s2">&quot;Ciceron push&quot;</span><span class="p">,</span> <span class="n">notification</span><span class="o">=</span><span class="n">message_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="send_noti_lite"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.send_noti_lite">[문서]</a><span class="k">def</span> <span class="nf">send_noti_lite</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">noti_type_id</span><span class="p">,</span> <span class="n">target_user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">optional_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    노티 전송 라이트 버전이다. 미완성으로 보인다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">store_notiTable</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">noti_type_id</span><span class="p">,</span> <span class="n">target_user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
    <span class="n">message_dict</span> <span class="o">=</span> <span class="n">get_noti_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">noti_type_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">optional_info</span><span class="o">=</span><span class="n">optional_info</span><span class="p">)</span>
    <span class="n">regKeys_oneuser</span> <span class="o">=</span> <span class="n">get_device_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="signUpQuick"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.signUpQuick">[문서]</a><span class="k">def</span> <span class="nf">signUpQuick</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mother_language_id</span><span class="p">,</span> <span class="n">nationality_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">residence_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">external_service_provider</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    회원 가입 함수이다.</span>
<span class="sd">    회원 테이블에 정보 밀어넣고, 그 밖에 비밀번호, 적립금 및 포인트를 넣는다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Duplicate check</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select id from CICERON.D_USERS where email = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">check_data</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Status code 400 (BAD REQUEST)</span>
        <span class="c1"># Description: Duplicate ID</span>
        <span class="k">return</span> <span class="mi">412</span>

    <span class="k">if</span> <span class="s1">&#39;@&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">email</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">417</span>

    <span class="c1"># Insert values to D_USERS</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;D_USERS&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;New user id: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;INSERT INTO CICERON.D_USERS</span>
<span class="s2">            VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,CURRENT_TIMESTAMP)&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">user_id</span><span class="p">,</span>
             <span class="n">email</span><span class="p">,</span>
             <span class="n">name</span><span class="p">,</span>
             <span class="n">mother_language_id</span><span class="p">,</span>
             <span class="kc">False</span><span class="p">,</span>
             <span class="kc">None</span><span class="p">,</span>
             <span class="kc">None</span><span class="p">,</span>
             <span class="mi">0</span><span class="p">,</span>
             <span class="mi">0</span><span class="p">,</span>
             <span class="mi">0</span><span class="p">,</span>
             <span class="mi">0</span><span class="p">,</span>
             <span class="mi">0</span><span class="p">,</span>
             <span class="mi">0</span><span class="p">,</span>
             <span class="kc">None</span><span class="p">,</span>
             <span class="s2">&quot;nothing&quot;</span><span class="p">,</span>
             <span class="mi">0</span><span class="p">,</span>
             <span class="n">nationality_id</span><span class="p">,</span>
             <span class="n">residence_id</span><span class="p">,</span>
             <span class="mf">0.7</span><span class="p">))</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.PASSWORDS VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">))</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.REVENUE VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.RETURN_POINT VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;facebook&#39;</span> <span class="ow">in</span> <span class="n">external_service_provider</span><span class="p">:</span>
        <span class="n">new_facebook_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;D_FACEBOOK_USERS&quot;</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.D_FACEBOOK_USERS VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">) &quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">new_facebook_id</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="mi">200</span></div>

<div class="viewcode-block" id="commonPromotionCodeChecker"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.commonPromotionCodeChecker">[문서]</a><span class="k">def</span> <span class="nf">commonPromotionCodeChecker</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
    <span class="c1"># return: (val1, val2, message)</span>
    <span class="c1">#          val1: is valid code? (codeType)</span>
    <span class="c1">#          val2: How much?</span>
    <span class="c1">#          message: Message</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    공용 프로모션 코드 validator이다.</span>
<span class="sd">    코드는 유효한지, 유효한 코드지만 이미 사용한 코드인지 등등을 체크한다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">query_commonPromotionCode</span><span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT id, benefitPoint, expireTime FROM CICERON.PROMOTIONCODES_COMMON WHERE text = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_commonPromotionCode</span><span class="p">,</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;There is no promo code matched.&quot;</span><span class="p">)</span>

    <span class="n">code_id</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">benefitPoint</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">expireTime</span> <span class="o">=</span> <span class="n">string2Date</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">expireTime</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;This promo code is expired.&quot;</span><span class="p">)</span>

    <span class="n">query_userCheck</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT count(*) FROM CICERON.USEDPROMOTION_COMMON WHERE id = </span><span class="si">%s</span><span class="s2"> AND user_id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_userCheck</span><span class="p">,</span> <span class="p">(</span><span class="n">code_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;You&#39;ve already used this code.&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">benefitPoint</span><span class="p">,</span> <span class="s2">&quot;You may use this code.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="commonPromotionCodeExecutor"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.commonPromotionCodeExecutor">[문서]</a><span class="k">def</span> <span class="nf">commonPromotionCodeExecutor</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    프로모션 코드를 적용한다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">query_searchPromoCodeId</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT id FROM CICERON.PROMOTIONCODES_COMMON WHERE text = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_searchPromoCodeId</span><span class="p">,</span> <span class="p">(</span><span class="n">code</span> <span class="p">))</span>
    <span class="n">code_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">query_commonPromotionCodeExeutor</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO CICERON.USEDPROMOTION_COMMON VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_commonPromotionCodeExeutor</span><span class="p">,</span> <span class="p">(</span><span class="n">code_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="individualPromotionCodeChecker"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.individualPromotionCodeChecker">[문서]</a><span class="k">def</span> <span class="nf">individualPromotionCodeChecker</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
    <span class="c1"># return: (val1, val2)</span>
    <span class="c1">#          val1: is valid code?</span>
    <span class="c1">#          val2: How much?</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    개인 프로모션 코드 validator이다.</span>
<span class="sd">    그 밖의 기능은 위와 같다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">query_individualPromotionCode</span><span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT benefitPoint, expireTime, is_used FROM CICERON.PROMOTIONCODES_USER WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND text = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_individualPromotionCode</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">code</span><span class="p">))</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;There is no promo code matched.&quot;</span><span class="p">)</span>

    <span class="n">benefitPoint</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">expireTime</span> <span class="o">=</span> <span class="n">string2Date</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">isUsed</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">expireTime</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;This promo code is expired.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">isUsed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;You&#39;ve already used this code.&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">benefitPoint</span><span class="p">,</span> <span class="s2">&quot;You may use this code.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="individualPromotionCodeExecutor"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.individualPromotionCodeExecutor">[문서]</a><span class="k">def</span> <span class="nf">individualPromotionCodeExecutor</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    개인용 프로모션 코드 적용기이다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">query_commonPromotionCodeExeutor</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        UPDATE CICERON.PROMOTIONCODES_USER SET is_used = true WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND text = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_commonPromotionCodeExeutor</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">code</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="payment_start"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.payment_start">[문서]</a><span class="k">def</span> <span class="nf">payment_start</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">pay_by</span><span class="p">,</span> <span class="n">pay_via</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">total_amount</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">host_ip</span><span class="p">,</span>
        <span class="n">use_point</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="n">is_additional</span><span class="o">=</span><span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    결제 함수이다. 자세한 설명은 아래에 계속...</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Point deduction</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    use_point: 포인트를 사용한다면, 먼저 가지고 있는 포인트보다 사용한다고 넣은 포인트가 큰지 아닌지부터 판단해야 한다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_point</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Check whether use_point exceeds or not</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT amount FROM CICERON.RETURN_POINT WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">current_point</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">current_point</span> <span class="o">-</span> <span class="n">use_point</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.00001</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;point_exceeded_than_you_have&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">current_point</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">amount</span> <span class="o">=</span> <span class="n">total_amount</span> <span class="o">-</span> <span class="n">use_point</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="n">total_amount</span>

    <span class="c1"># Promo code deduction</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    프로모션 코드를 적용한다면, 먼저 validate 해 보고 유효하면 적용한 후, 총액에서 할인해준다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">promo_type</span> <span class="o">!=</span> <span class="s1">&#39;null&#39;</span><span class="p">:</span>
        <span class="n">isCommonCode</span><span class="p">,</span> <span class="n">commonPoint</span><span class="p">,</span> <span class="n">commonMessage</span> <span class="o">=</span> <span class="n">commonPromotionCodeChecker</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">)</span>
        <span class="n">isIndivCode</span><span class="p">,</span> <span class="n">indivPoint</span><span class="p">,</span> <span class="n">indivMessage</span> <span class="o">=</span> <span class="n">individualPromotionCodeChecker</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isCommonCode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">-</span> <span class="n">commonPoint</span>
        <span class="k">elif</span> <span class="n">isIndivCode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">-</span> <span class="n">indivPoint</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Paypal, Alipay, Iamport 등등에 따라서 잘 처리해준다.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">pay_via</span> <span class="o">==</span> <span class="s1">&#39;paypal&#39;</span> <span class="ow">and</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        페이팔은 그냥 모든 정보를 URL에 박아서 페이팔에 넘겨주면 된다.</span>
<span class="sd">        결제는 페이팔에서 한 후 콜백으로 postprocessing을 불러오기때문에, 여기서는 페이팔로의 링크만 제공해주면 된다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># SANDBOX</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PURPOSE&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;PROD&quot;</span><span class="p">:</span>
            <span class="n">paypalrestsdk</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;sandbox&quot;</span><span class="p">,</span>
                    <span class="n">client_id</span><span class="o">=</span><span class="s2">&quot;AQX4nD2IQ4xQ03Rm775wQ0SptsSe6-WBdMLldyktgJG0LPhdGwBf90C7swX2ymaSJ-PuxYKicVXg12GT&quot;</span><span class="p">,</span>
                    <span class="n">client_secret</span><span class="o">=</span><span class="s2">&quot;EHUxNGZPZNGe_pPDrofV80ZKkSMbApS2koofwDYRZR6efArirYcJazG2ao8eFqqd8sX-8fUd2im9GzBG&quot;</span>
            <span class="p">)</span>

        <span class="c1"># LIVE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">paypalrestsdk</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;live&quot;</span><span class="p">,</span>
                    <span class="n">client_id</span><span class="o">=</span><span class="s2">&quot;AevAg0UyjlRVArPOUN6jjsRVQrlasLZVyqJrioOlnF271796_2taD1HOZFry9TjkAYSTZExpyFyJV5Tl&quot;</span><span class="p">,</span>
                    <span class="n">client_secret</span><span class="o">=</span><span class="s2">&quot;EJjp8RzEmFRH_qpwzOyJU7ftf9GxZM__vl5w2pqERkXrt3aI6nsVBj2MnbkfLsDzcZzX3KW8rgqTdSIR&quot;</span>
                    <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

        <span class="n">payment</span> <span class="o">=</span> <span class="n">paypalrestsdk</span><span class="o">.</span><span class="n">Payment</span><span class="p">({</span>
          <span class="s2">&quot;intent&quot;</span><span class="p">:</span> <span class="s2">&quot;sale&quot;</span><span class="p">,</span>
          <span class="s2">&quot;payer&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;payment_method&quot;</span><span class="p">:</span> <span class="s2">&quot;paypal&quot;</span><span class="p">},</span>
          <span class="s2">&quot;redirect_urls&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;return_url&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:5000/api/user/requests/</span><span class="si">%d</span><span class="s2">/payment/postprocess?pay_via=paypal&amp;status=success&amp;user_id=</span><span class="si">%s</span><span class="s2">&amp;pay_amt=</span><span class="si">%.2f</span><span class="s2">&amp;pay_by=</span><span class="si">%s</span><span class="s2">&amp;use_point=</span><span class="si">%.2f</span><span class="s2">&amp;promo_type=</span><span class="si">%s</span><span class="s2">&amp;promo_code=</span><span class="si">%s</span><span class="s2">&amp;is_additional=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host_ip</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span> <span class="n">amount</span><span class="p">,</span> <span class="n">pay_by</span><span class="p">,</span> <span class="n">use_point</span><span class="p">,</span> <span class="n">promo_type</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">,</span> <span class="n">is_additional</span><span class="p">),</span>
            <span class="s2">&quot;cancel_url&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:5000/api/user/requests/</span><span class="si">%d</span><span class="s2">/payment/postprocess?pay_via=paypal&amp;status=fail&amp;user_id=</span><span class="si">%s</span><span class="s2">&amp;pay_amt=</span><span class="si">%.2f</span><span class="s2">&amp;pay_by=</span><span class="si">%s</span><span class="s2">&amp;use_point=</span><span class="si">%.2f</span><span class="s2">&amp;promo_type=</span><span class="si">%s</span><span class="s2">&amp;promo_code=</span><span class="si">%s</span><span class="s2">&amp;is_additional=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host_ip</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span> <span class="n">amount</span><span class="p">,</span> <span class="n">pay_by</span><span class="p">,</span> <span class="n">use_point</span><span class="p">,</span> <span class="n">promo_type</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">,</span> <span class="n">is_additional</span><span class="p">)},</span>
          <span class="s2">&quot;transactions&quot;</span><span class="p">:</span> <span class="p">[{</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">amount</span><span class="p">,</span>
                <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="s2">&quot;USD&quot;</span><span class="p">,</span>
            <span class="p">},</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Ciceron translation request fee USD: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">amount</span> <span class="p">}]})</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">payment</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>  <span class="c1"># return True or False</span>
        <span class="n">paypal_link</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">payment</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;REDIRECT&#39;</span><span class="p">:</span>
                <span class="n">paypal_link</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span>
                <span class="k">break</span>

        <span class="n">red_link</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:5000/api/user/requests/</span><span class="si">%d</span><span class="s2">/payment/postprocess?pay_via=paypal&amp;status=success&amp;user_id=</span><span class="si">%s</span><span class="s2">&amp;pay_amt=</span><span class="si">%.2f</span><span class="s2">&amp;pay_by=</span><span class="si">%s</span><span class="s2">&amp;use_point=</span><span class="si">%.2f</span><span class="s2">&amp;promo_type=</span><span class="si">%s</span><span class="s2">&amp;promo_code=</span><span class="si">%s</span><span class="s2">&amp;is_additional=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host_ip</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span> <span class="n">amount</span><span class="p">,</span> <span class="n">pay_by</span><span class="p">,</span> <span class="n">use_point</span><span class="p">,</span> <span class="n">promo_type</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">,</span> <span class="n">is_additional</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;paypal_success&#39;</span><span class="p">,</span> <span class="n">paypal_link</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;paypal_error&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">elif</span> <span class="n">pay_via</span> <span class="o">==</span> <span class="s1">&#39;alipay&#39;</span> <span class="ow">and</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        알리페이도 페이팔과 흐름은 비슷하다. 알리페이 결제 링크 생성 후, 알리페이로 이동하여 결제가 완료되면 다시 콜백으로 씨세론으로 들어와 접수가 완료됨을 알 수 있는 시스템이다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">alipay</span> <span class="k">import</span> <span class="n">Alipay</span>
        <span class="n">order_no</span> <span class="o">=</span> <span class="n">orderNoGenerator</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

        <span class="n">alipay_obj</span> <span class="o">=</span> <span class="n">Alipay</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="s1">&#39;2088021580332493&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;lksk5gkmbsj0w7ejmhziqmoq2gdda3jo&#39;</span><span class="p">,</span> <span class="n">seller_email</span><span class="o">=</span><span class="s1">&#39;contact@ciceron.me&#39;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="s1">&#39;诗谐论翻译&#39;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
            <span class="s1">&#39;out_trade_no&#39;</span><span class="p">:</span> <span class="n">order_no</span><span class="p">,</span>
            <span class="c1">#&#39;subject&#39;: &#39;TEST&#39;,</span>
            <span class="s1">&#39;total_fee&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;return_url&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:5000/api/user/requests/</span><span class="si">%d</span><span class="s2">/payment/postprocess?pay_via=alipay&amp;status=success&amp;user_id=</span><span class="si">%s</span><span class="s2">&amp;pay_amt=</span><span class="si">%.2f</span><span class="s2">&amp;pay_by=</span><span class="si">%s</span><span class="s2">&amp;use_point=</span><span class="si">%.2f</span><span class="s2">&amp;promo_type=</span><span class="si">%s</span><span class="s2">&amp;promo_code=</span><span class="si">%s</span><span class="s2">&amp;is_additional=</span><span class="si">%s</span><span class="s2">&amp;ciceron_order_no=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host_ip</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span> <span class="n">amount</span><span class="p">,</span> <span class="n">pay_by</span><span class="p">,</span> <span class="n">use_point</span><span class="p">,</span> <span class="n">promo_type</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">,</span> <span class="n">is_additional</span><span class="p">,</span> <span class="n">order_no</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="n">provided_link</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pay_by</span> <span class="o">==</span> <span class="s1">&#39;web&#39;</span><span class="p">:</span>
                <span class="n">provided_link</span> <span class="o">=</span> <span class="n">alipay_obj</span><span class="o">.</span><span class="n">create_forex_trade_url</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">pay_by</span> <span class="o">==</span> <span class="s1">&#39;mobile&#39;</span><span class="p">:</span>
                <span class="n">provided_link</span> <span class="o">=</span> <span class="n">alipay_obj</span><span class="o">.</span><span class="n">create_forex_trade_wap_url</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;alipay_failure&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="s1">&#39;alipay_success&#39;</span><span class="p">,</span> <span class="n">provided_link</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">elif</span> <span class="n">pay_via</span> <span class="o">==</span> <span class="s1">&#39;iamport&#39;</span> <span class="ow">and</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        아임포트 No-ActiveX 결제 시스템이다.</span>

<span class="sd">        직접 카드번호 및 유효기간 등의 정보를 물러와서 결제를 바로 한다.</span>
<span class="sd">        그리고 이 자리에서 바로 결제를 하기 때문에 postprocessing 과정을 거쳐서 할 작업을 여기서 다 한다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Should check USD-&gt;KRW currency</span>
        <span class="c1"># Hard coded: 1200</span>
        <span class="n">new_payload</span> <span class="o">=</span> <span class="n">payload</span>
        <span class="n">kor_amount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount</span> <span class="o">*</span> <span class="mi">1160</span><span class="p">)</span>
        <span class="n">order_no</span> <span class="o">=</span> <span class="n">orderNoGenerator</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

        <span class="n">new_payload</span><span class="p">[</span><span class="s1">&#39;merchant_uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order_no</span>
        <span class="n">new_payload</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kor_amount</span>

        <span class="n">pay_module</span> <span class="o">=</span> <span class="n">Iamport</span><span class="p">(</span><span class="n">imp_key</span><span class="o">=</span><span class="mi">2311212273535904</span><span class="p">,</span> <span class="n">imp_secret</span><span class="o">=</span><span class="s1">&#39;jZM7opWBO5K2cZfVoMgYJhsnSw4TiSmBR8JgyGRnLCpYCFT0raZbsrylYDehvBSnKCDjivG4862KLWLd&#39;</span><span class="p">)</span>

        <span class="n">payment_result</span> <span class="o">=</span> <span class="n">pay_module</span><span class="o">.</span><span class="n">pay_onetime</span><span class="p">(</span><span class="o">**</span><span class="n">new_payload</span><span class="p">)</span>
        <span class="n">double_check</span> <span class="o">=</span> <span class="n">pay_module</span><span class="o">.</span><span class="n">is_paid</span><span class="p">(</span><span class="o">**</span><span class="n">payment_result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">double_check</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;iamport_error&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># DB process</span>
        <span class="k">if</span> <span class="n">is_additional</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
            <span class="n">query_setToPaid</span> <span class="o">=</span> <span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET is_paid = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query_setToPaid</span> <span class="o">=</span> <span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET is_additional_points_paid = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_setToPaid</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>

        <span class="n">payment_info_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;PAYMENT_INFO&quot;</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.PAYMENT_INFO (id, request_id, client_id, payed_via, order_no, pay_amount, payed_time) VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,CURRENT_TIMESTAMP)&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">payment_info_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;iamport&quot;</span><span class="p">,</span> <span class="n">order_no</span><span class="p">,</span> <span class="n">amount</span><span class="p">))</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">pay_by</span> <span class="o">==</span> <span class="s2">&quot;web&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;iamport_success&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">pay_by</span> <span class="o">==</span> <span class="s2">&quot;mobile&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;iamport_success&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">elif</span> <span class="n">pay_via</span> <span class="o">==</span> <span class="s2">&quot;point_only&quot;</span> <span class="ow">or</span> <span class="n">amount</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        이도 저도 아니고 포인트로 결제한다면 iamport와 마찬가지로 postprocessing 없이 진행할 수 있다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT amount FROM CICERON.RETURN_POINT WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">current_point</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">use_point</span> <span class="o">&gt;</span> <span class="mf">0.01</span> <span class="ow">and</span> <span class="n">current_point</span> <span class="o">-</span> <span class="n">use_point</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.00001</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You requested to use your points more than what you have. Price: </span><span class="si">%.2f</span><span class="s2">, Your purse: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">total_amount</span><span class="p">,</span> <span class="n">current_point</span><span class="p">)),</span> <span class="mi">402</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">amount</span> <span class="o">=</span> <span class="n">current_point</span> <span class="o">-</span> <span class="n">use_point</span>

        <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.RETURN_POINT SET amount = amount - </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">use_point</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>

        <span class="k">if</span> <span class="n">is_additional</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
            <span class="n">query_setToPaid</span> <span class="o">=</span> <span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET is_paid = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query_setToPaid</span> <span class="o">=</span> <span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET is_additional_points_paid = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_setToPaid</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">pay_by</span> <span class="o">==</span> <span class="s2">&quot;web&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;point_success&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">pay_by</span> <span class="o">==</span> <span class="s2">&quot;mobile&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;point_success&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="payment_postprocess"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.payment_postprocess">[문서]</a><span class="k">def</span> <span class="nf">payment_postprocess</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">pay_by</span><span class="p">,</span> <span class="n">pay_via</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">is_success</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span>
        <span class="n">use_point</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="n">is_additional</span><span class="o">=</span><span class="s1">&#39;false&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    로직</span>
<span class="sd">        1. 지불로 처리힌다.</span>
<span class="sd">        2. 지불 정보 한 줄 INSERT한다.</span>
<span class="sd">        3. 프로모션 코드 사용처리한다.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Point deduction</span>
    <span class="k">if</span> <span class="n">use_point</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.return_point SET amount = amount - </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">use_point</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>

    <span class="k">if</span> <span class="n">pay_via</span> <span class="o">==</span> <span class="s1">&#39;paypal&#39;</span><span class="p">:</span>
        <span class="n">payment_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;paymentId&#39;</span><span class="p">]</span>
        <span class="n">payer_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;PayerID&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">is_success</span><span class="p">:</span>
            <span class="n">payment_info_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;PAYMENT_INFO&quot;</span><span class="p">)</span>
            <span class="c1"># Paypal payment exeuction</span>
            <span class="n">payment</span> <span class="o">=</span> <span class="n">paypalrestsdk</span><span class="o">.</span><span class="n">Payment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">payment_id</span><span class="p">)</span>
            <span class="n">payment</span><span class="o">.</span><span class="n">execute</span><span class="p">({</span><span class="s2">&quot;payer_id&quot;</span><span class="p">:</span> <span class="n">payer_id</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">is_additional</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">query_setToPaid</span> <span class="o">=</span> <span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET is_paid = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query_setToPaid</span> <span class="o">=</span> <span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET is_additional_points_paid = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_setToPaid</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>

            <span class="c1"># Payment information update</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.PAYMENT_INFO (id, request_id, client_id, payed_via, order_no, pay_amount, payed_time) VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,CURRENT_TIMESTAMP)&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">payment_info_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;paypal&quot;</span><span class="p">,</span> <span class="n">payment_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="p">))</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="c1">#return redirect(&quot;success&quot;)</span>

    <span class="k">elif</span> <span class="n">pay_via</span> <span class="o">==</span> <span class="s2">&quot;alipay&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_success</span><span class="p">:</span>
            <span class="c1"># Get &amp; store order ID and price</span>
            <span class="n">payment_info_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;PAYMENT_INFO&quot;</span><span class="p">)</span>
            <span class="n">order_no</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;ciceron_order_no&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">is_additional</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">query_setToPaid</span> <span class="o">=</span> <span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET is_paid = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query_setToPaid</span> <span class="o">=</span> <span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET is_additional_points_paid = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_setToPaid</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>

            <span class="c1"># Payment information update</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.PAYMENT_INFO (id, request_id, client_id, payed_via, order_no, pay_amount, payed_time) VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,CURRENT_TIMESTAMP)&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">payment_info_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;alipay&quot;</span><span class="p">,</span> <span class="n">order_no</span><span class="p">,</span> <span class="n">amount</span><span class="p">))</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">promo_type</span> <span class="o">==</span> <span class="s1">&#39;common&#39;</span><span class="p">:</span>
        <span class="n">commonPromotionCodeExecutor</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">promo_type</span> <span class="o">==</span> <span class="s1">&#39;indiv&#39;</span><span class="p">:</span>
        <span class="n">individualPromotionCodeExecutor</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">)</span>

    <span class="c1"># Notification for normal request</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT original_lang_id, target_lang_id FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">record</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No record for this request. Request ID: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;no_record&#39;</span>

    <span class="n">original_lang_id</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">target_lang_id</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">rs</span> <span class="o">=</span> <span class="n">pick_random_translator</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">original_lang_id</span><span class="p">,</span> <span class="n">target_lang_id</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">:</span>
        <span class="n">store_notiTable</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
        <span class="n">regKeys_oneuser</span> <span class="o">=</span> <span class="n">get_device_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">message_dict</span> <span class="o">=</span> <span class="n">get_noti_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">request_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">regKeys_oneuser</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gcm_noti</span> <span class="o">=</span> <span class="n">gcm_server</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">regKeys_oneuser</span><span class="p">,</span> <span class="n">message_dict</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pay_by</span> <span class="o">==</span> <span class="s2">&quot;web&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;payment_success&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">pay_by</span> <span class="o">==</span> <span class="s2">&quot;mobile&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;payment_success&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="approve_negoPoint"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.approve_negoPoint">[문서]</a><span class="k">def</span> <span class="nf">approve_negoPoint</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">translator_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">translator_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">406</span>

    <span class="c1"># 1. Get diff_amount</span>
    <span class="c1"># 1.1. Get current point of the ticket and queue ID</span>
    <span class="n">query_getCurPointAndQueueID</span> <span class="o">=</span> <span class="s2">&quot;SELECT points, queue_id, status_id FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2"> AND client_user_id = </span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_getCurPointAndQueueID</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">406</span>

    <span class="n">current_point</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">queue_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">status_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">status_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">402</span>

    <span class="c1"># 1.2. Get suggested point</span>
    <span class="n">query_getSuggestedPoint</span> <span class="o">=</span> <span class="s2">&quot;SELECT nego_price FROM CICERON.D_QUEUE_LISTS WHERE id = </span><span class="si">%s</span><span class="s2"> AND request_id = </span><span class="si">%s</span><span class="s2"> AND user_id = </span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_getSuggestedPoint</span><span class="p">,</span> <span class="p">(</span><span class="n">queue_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">translator_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">406</span>

    <span class="n">nego_point</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">diff_point</span> <span class="o">=</span> <span class="n">nego_point</span> <span class="o">-</span> <span class="n">current_point</span>
    <span class="k">if</span> <span class="n">diff_point</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">409</span>

    <span class="c1"># 2. Set the queued hero to your hero, status = 1, is_need_additional_points = true, is_additional_points_paid = false</span>
    <span class="n">query_updateHero</span> <span class="o">=</span> <span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET is_need_additional_points = true, ongoing_worker_id = </span><span class="si">%s</span><span class="s2">, additional_points= </span><span class="si">%s</span><span class="s2">, is_additional_points_paid=false, status_id = 1 WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_updateHero</span><span class="p">,</span> <span class="p">(</span><span class="n">translator_id</span><span class="p">,</span> <span class="n">diff_point</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">200</span></div>

<div class="viewcode-block" id="calculateChecksum"><a class="viewcode-back" href="../../docs/app.ciceron_lib.html#app.ciceron_lib.calculateChecksum">[문서]</a><span class="k">def</span> <span class="nf">calculateChecksum</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">checksum_obj</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">checksum_obj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">checksum_obj</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">모듈 코드</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>빠른 검색</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="바로 가기" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, psy2848048.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>