<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="ko">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>app.application &#8212; CICERON 2.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <link rel="index" title="색인" href="../../genindex.html" />
    <link rel="search" title="검색" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for app.application</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">어플리케이션 서버 본 코드</span>
<span class="sd">URL rule과 Response가 정의되어 있음.</span>

<span class="sd">TODO: 이 파일에서는 Function call만 하고, Query 날리는 것은 모두 라이브러리화 시켜 서버 갈아타기 쉽게 하기</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">make_response</span><span class="p">,</span> <span class="n">send_from_directory</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">send_file</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)))</span> <span class="p">)</span>

<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">from</span> <span class="nn">flask_cors</span> <span class="k">import</span> <span class="n">CORS</span>
<span class="kn">from</span> <span class="nn">flask_session</span> <span class="k">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">flask_cache</span> <span class="k">import</span> <span class="n">Cache</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">i18nHandler</span> <span class="k">import</span> <span class="n">I18nHandler</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.i18nHandler</span> <span class="k">import</span> <span class="n">I18nHandler</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">detourserverConnector</span> <span class="k">import</span> <span class="n">Connector</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.detourserverConnector</span> <span class="k">import</span> <span class="n">Connector</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ciceron_lib</span> <span class="k">import</span> <span class="o">*</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.ciceron_lib</span> <span class="k">import</span> <span class="o">*</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">requestwarehouse</span> <span class="k">import</span> <span class="n">Warehousing</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.requestwarehouse</span> <span class="k">import</span> <span class="n">Warehousing</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">groupRequest</span> <span class="k">import</span> <span class="n">GroupRequest</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.groupRequest</span> <span class="k">import</span> <span class="n">GroupRequest</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">requestResell</span> <span class="k">import</span> <span class="n">RequestResell</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.requestResell</span> <span class="k">import</span> <span class="n">RequestResell</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">payment</span> <span class="k">import</span> <span class="n">Payment</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.payment</span> <span class="k">import</span> <span class="n">Payment</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">localizer</span> <span class="k">import</span> <span class="n">LocalizerAPI</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.localizer</span> <span class="k">import</span> <span class="n">LocalizerAPI</span>

<span class="c1">#from flask_oauth import OAuth</span>

<span class="c1"># DATABASE = &#39;../db/ciceron.db&#39;</span>
<span class="n">DATABASE</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1"># parser = argparse.ArgumentParser(description=&#39;Translation agent&#39;)</span>
<span class="c1"># parser.add_argument(&#39;--dbpass&#39;, dest=&#39;dbpass&#39;, help=&#39;DB password&#39;)</span>
<span class="c1"># args = parser.parse_args()</span>

<span class="c1"># os.environ[&#39;DYLD_LIBRARY_PATH&#39;] = &#39;/usr/local/opt/openssl/lib&#39;</span>
<span class="sd">&quot;&quot;&quot; Execute following first!!&quot;&quot;&quot;</span>
<span class="sd">&quot;&quot;&quot; export DYLD_LIBRARY_PATH=&#39;/usr/local/opt/openssl/lib&#39; &quot;&quot;&quot;</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PURPOSE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;PROD&#39;</span><span class="p">:</span>
    <span class="n">DATABASE</span> <span class="o">=</span> <span class="s2">&quot;host=ciceronprod.cng6yzqtxqhh.ap-northeast-1.rds.amazonaws.com port=5432 dbname=ciceron user=ciceron_web password=noSecret01!&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">DATABASE</span> <span class="o">=</span> <span class="s2">&quot;host=cicerontest.cng6yzqtxqhh.ap-northeast-1.rds.amazonaws.com port=5432 dbname=ciceron user=ciceron_web password=noSecret01!&quot;</span>

<span class="n">VERSION</span> <span class="o">=</span> <span class="s1">&#39;1.1&#39;</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">BASEPATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="n">UPLOAD_FOLDER_RESULT</span> <span class="o">=</span> <span class="s2">&quot;translate_result&quot;</span>
<span class="n">MAX_CONTENT_LENGTH</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="n">FACEBOOK_APP_ID</span> <span class="o">=</span> <span class="mi">256525961180911</span>
<span class="n">FACEBOOK_APP_SECRET</span> <span class="o">=</span> <span class="s1">&#39;e382ac48932308c15641803022feca13&#39;</span>
<span class="n">JSON_SORT_KEYS</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">SESSION_TYPE</span> <span class="o">=</span> <span class="s1">&#39;redis&#39;</span>
<span class="n">SESSION_COOKIE_NAME</span> <span class="o">=</span> <span class="s2">&quot;CiceronCookie&quot;</span>
<span class="n">PERMANENT_SESSION_LIFETIME</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">ALLOWED_EXTENSIONS_PIC</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;tiff&#39;</span><span class="p">])</span>
<span class="n">ALLOWED_EXTENSIONS_DOC</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="s1">&#39;hwp&#39;</span><span class="p">,</span> <span class="s1">&#39;docx&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;ppt&#39;</span><span class="p">,</span> <span class="s1">&#39;pptx&#39;</span><span class="p">,</span> <span class="s1">&#39;rtf&#39;</span><span class="p">])</span>
<span class="n">ALLOWED_EXTENSIONS_WAV</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;wav&#39;</span><span class="p">,</span> <span class="s1">&#39;mp3&#39;</span><span class="p">,</span> <span class="s1">&#39;aac&#39;</span><span class="p">,</span> <span class="s1">&#39;ogg&#39;</span><span class="p">,</span> <span class="s1">&#39;oga&#39;</span><span class="p">,</span> <span class="s1">&#39;flac&#39;</span><span class="p">,</span> <span class="s1">&#39;3gp&#39;</span><span class="p">,</span> <span class="s1">&#39;m4a&#39;</span><span class="p">])</span>
<span class="n">VERSION</span> <span class="o">=</span> <span class="s2">&quot;2015.11.15&quot;</span>

<span class="c1"># CELERY_BROKER_URL = &#39;redis://localhost&#39;</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PURPOSE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;PROD&#39;</span><span class="p">:</span>
    <span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;http://ciceron.me&#39;</span>
    <span class="n">SESSION_COOKIE_DOMAIN</span> <span class="o">=</span> <span class="s2">&quot;.ciceron.me&quot;</span>
    
<span class="k">else</span><span class="p">:</span>
    <span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;http://ciceron.xyz&#39;</span>
    <span class="n">SESSION_COOKIE_DOMAIN</span> <span class="o">=</span> <span class="s2">&quot;.ciceron.xyz&quot;</span>

<span class="n">SESSION_COOKIE_PATH</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>

<span class="c1"># APP setting</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="s1">&#39;Yh1onQnWOJuc3OBQHhLFf5dZgogGlAnEJ83FacFv&#39;</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">project_number</span> <span class="o">=</span> <span class="mi">145456889576</span>

<span class="c1"># CORS</span>
<span class="n">cors</span> <span class="o">=</span> <span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="p">{</span><span class="s2">r&quot;/*&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;origins&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;supports_credentials&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">}})</span>

<span class="c1"># Flask-Session</span>
<span class="n">Session</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c1"># Flask-Cache</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;CACHE_TYPE&#39;</span><span class="p">:</span> <span class="s1">&#39;simple&#39;</span><span class="p">})</span>

<span class="n">LocalizerAPI</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c1"># Celery</span>
<span class="c1"># celery = Celery(app.name, broker=app.config[&#39;CELERY_BROKER_URL&#39;])</span>
<span class="c1"># celery.conf.update(app.config)</span>

<span class="c1"># Flask-OAuth for facebook</span>
<span class="c1">#oauth = OAuth()</span>
<span class="c1">#facebook = oauth.remote_app(&#39;facebook&#39;,</span>
<span class="c1">#                            base_url=&#39;https://graph.facebook.com/&#39;,</span>
<span class="c1">#                            request_token_url=None,</span>
<span class="c1">#                            access_token_url=&#39;/oauth/access_token&#39;,</span>
<span class="c1">#                            authorize_url=&#39;https://www.facebook.com/dialog/oauth&#39;,</span>
<span class="c1">#                            consumer_key=FACEBOOK_APP_ID,</span>
<span class="c1">#                            consumer_secret=FACEBOOK_APP_SECRET,</span>
<span class="c1">#                            request_token_params={&#39;scope&#39;: &#39;email&#39;}</span>
<span class="c1">#                            )</span>
<span class="n">date_format</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span>
<span class="n">super_user</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pjh0308@gmail.com&quot;</span><span class="p">,</span> <span class="s2">&quot;admin@ciceron.me&quot;</span><span class="p">,</span> <span class="s2">&quot;yysyhk@naver.com&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="pic_allowed_file"><a class="viewcode-back" href="../../docs/app.application.html#app.application.pic_allowed_file">[문서]</a><span class="k">def</span> <span class="nf">pic_allowed_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    확장자를 보고 사진(그림)인지 아닌지 판별</span>
<span class="sd">    :param string filename: 파일 이름</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ALLOWED_EXTENSIONS_PIC&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="doc_allowed_file"><a class="viewcode-back" href="../../docs/app.application.html#app.application.doc_allowed_file">[문서]</a><span class="k">def</span> <span class="nf">doc_allowed_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    확장자를 보고 문서인지 아닌지 판별</span>
<span class="sd">    :param string filename: 파일 이름</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ALLOWED_EXTENSIONS_DOC&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="sound_allowed_file"><a class="viewcode-back" href="../../docs/app.application.html#app.application.sound_allowed_file">[문서]</a><span class="k">def</span> <span class="nf">sound_allowed_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    확장자를 보고 음성인지 아닌지 판별</span>
<span class="sd">    :param string filename: 파일 이름</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ALLOWED_EXTENSIONS_WAV&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="connect_db"><a class="viewcode-back" href="../../docs/app.application.html#app.application.connect_db">[문서]</a><span class="k">def</span> <span class="nf">connect_db</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DB connector 함수</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;DATABASE&#39;</span><span class="p">])</span></div>

<span class="c1">################################################################################</span>
<span class="c1">#########                     MAIN APPLICATION                         #########</span>
<span class="c1">################################################################################</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<div class="viewcode-block" id="before_request"><a class="viewcode-back" href="../../docs/app.application.html#app.application.before_request">[문서]</a><span class="k">def</span> <span class="nf">before_request</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    모든 API 실행 전 실행하는 부분. 여기서는 DB 연결.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">g</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">connect_db</span><span class="p">()</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">teardown_request</span>
<div class="viewcode-block" id="teardown_request"><a class="viewcode-back" href="../../docs/app.application.html#app.application.teardown_request">[문서]</a><span class="k">def</span> <span class="nf">teardown_request</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    모든 API 실행 후 실행하는 부분. 여기서는 DB 연결종료.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">#@facebook.tokengetter</span>
<span class="c1">#def get_facebook_token():</span>
<span class="c1">#    return session.get(&#39;facebook_token&#39;)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@cache</span><span class="o">.</span><span class="n">cached</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">key_prefix</span><span class="o">=</span><span class="s1">&#39;loginStatusCheck&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="loginCheck"><a class="viewcode-back" href="../../docs/app.application.html#app.application.loginCheck">[문서]</a><span class="k">def</span> <span class="nf">loginCheck</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    해당 세션의 상태를 보여준다.</span>
<span class="sd">    아래 return값은 session[var_name]으로 접근 가능하다</span>

<span class="sd">    :returns JSON response</span>
<span class="sd">        useremail: 로그인한 유저의 이메일주소. 로그인 상태 아니면 null</span>
<span class="sd">        isLoggedIn: 로그인 여부 True/False</span>
<span class="sd">        isTranslator: 로그인한 유저의 번역가여부 True/False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;useremail&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">client_os</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;client_os&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">isTranslator</span> <span class="o">=</span> <span class="n">translator_checker_plain</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="c1">#if client_os is not None and registration_id is not None:</span>
        <span class="c1">#    check_and_update_reg_key(g.db, client_os, registration_id)</span>
        <span class="c1">#    g.db.coomit()</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">useremail</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span>
            <span class="n">isLoggedIn</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">isTranslator</span><span class="o">=</span><span class="n">isTranslator</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;User </span><span class="si">%s</span><span class="s2"> is logged in&quot;</span> <span class="o">%</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
            <span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">useremail</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">isLoggedIn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">isTranslator</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No user is logged in&quot;</span><span class="p">)</span>
            <span class="p">,</span> <span class="mi">403</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/ping&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="ping"><a class="viewcode-back" href="../../docs/app.application.html#app.application.ping">[문서]</a><span class="k">def</span> <span class="nf">ping</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM CICERON.F_REQUESTS WHERE id = 1&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;OK&quot;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Disorder&quot;</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="login"><a class="viewcode-back" href="../../docs/app.application.html#app.application.login">[문서]</a><span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    로그인 함수</span>

<span class="sd">    로그인 로직</span>
<span class="sd">        1. GET /api/login에 접속</span>
<span class="sd">        2. 로그인 Salt를 받는다.</span>
<span class="sd">        3. 클라이언트에서는 sha256(salt + sha256(password) + salt) 값을 만들어 서버에 전송한다.</span>
<span class="sd">        4. Password 테이블 값과 비교하여 일치하면 session 값들을 고쳐준다.</span>

<span class="sd">    GET</span>
<span class="sd">        No parameter</span>

<span class="sd">    POST</span>
<span class="sd">        :param string email: 유저 email 주소 (ciceron_lib.get_user_id를 통하여 email에서 user_id를 추출할 수 있다.)</span>
<span class="sd">        :param string password: 3번 참조</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="c1"># Parameter</span>
        <span class="c1">#     email:        E-mail ID</span>
        <span class="c1">#     password:     password</span>
        <span class="c1">#     client_os:    := Android, iPhone, Blackberry, web.. (OPTIONAL)</span>
        <span class="c1">#     machine_id:   machine_id of client phone device (OPTIONAL)</span>

        <span class="c1"># Get parameters</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
        <span class="n">hashed_password</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
        <span class="c1">#machine_id = parameters.get(&#39;machine_id&#39;, None)</span>
        <span class="c1">#client_os = parameters.get(&#39;client_os&#39;, None)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>

        <span class="c1"># Get hashed_password using user_id for comparing</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT hashed_pass FROM CICERON.PASSWORDS WHERE user_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Status code 500 (ERROR)</span>
            <span class="c1"># Description: Same e-mail address tried to be inserted into DB</span>
            <span class="k">return</span> <span class="n">make_response</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;Constraint violation error!&#39;</span><span class="p">),</span> <span class="mi">501</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Status code 403 (ERROR)</span>
            <span class="c1"># Description: Not registered</span>
            <span class="k">return</span> <span class="n">make_response</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;Not registered </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">email</span><span class="p">),</span> <span class="mi">403</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">get_hashed_password</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;salt&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">hashed_password</span><span class="p">:</span>
            <span class="c1"># Status code 200 (OK)</span>
            <span class="c1"># Description: Success to log in</span>
            <span class="n">isTranslator</span> <span class="o">=</span> <span class="n">translator_checker_plain</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;logged_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email</span>
            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;isTranslator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isTranslator</span>
            <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;salt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
            <span class="c1">#if client_os is not None and registration_id is not None:</span>
            <span class="c1">#    check_and_update_reg_key(g.db, client_os, registration_id)</span>
        
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Logged in&#39;</span><span class="p">,</span>
                <span class="n">isTranslator</span><span class="o">=</span><span class="n">isTranslator</span><span class="p">,</span>
                <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
                <span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Status code 406 (ERROR)</span>
            <span class="c1"># Description: Password incorrect</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Please check the password&#39;</span>
                <span class="p">),</span> <span class="mi">403</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">salt</span> <span class="o">=</span> <span class="n">random_string_gen</span><span class="p">()</span>
        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;salt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">salt</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="n">salt</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="c1">#@app.route(&quot;/api/facebook_login&quot;)</span>
<span class="c1">#def facebook_auth():</span>
<span class="c1">#    return facebook.authorize(callback=url_for(&#39;facebook_authorized&#39;, is_signUp=&#39;N&#39;, _external=True))</span>
<span class="c1">#</span>
<span class="c1">#@app.route(&quot;/api/facebook_signUpCheck&quot;)</span>
<span class="c1">#def facebook_signUpCheck():</span>
<span class="c1">#    return facebook.authorize(callback=url_for(&#39;facebook_authorized&#39;, is_signUp=&#39;Y&#39;, _external=True))</span>
<span class="c1">#</span>
<span class="c1">#@app.route(&quot;/api/facebook_authorized&quot;)</span>
<span class="c1">#@facebook.authorized_handler</span>
<span class="c1">#def facebook_authorized(resp):</span>
<span class="c1">#    if resp is None or &#39;access_token&#39; not in resp:</span>
<span class="c1">#        return make_response(json.jsonify(</span>
<span class="c1">#            message=&quot;No access token from facebook&quot;), 403)</span>
<span class="c1">#</span>
<span class="c1">#    session[&#39;facebook_token&#39;] = (resp[&#39;access_token&#39;], &#39;&#39;)</span>
<span class="c1">#    user_data = facebook.get(&#39;/me&#39;).data</span>
<span class="c1">#</span>
<span class="c1">#    # Login with facebook</span>
<span class="c1">#    if request.args.get(&#39;is_signUp&#39;) == &#39;N&#39;:</span>
<span class="c1">#        facebook_id, user_id = get_facebook_user_id(g.db, user_data[&#39;email&#39;])</span>
<span class="c1">#        if facebook_id == -1:</span>
<span class="c1">#            return make_response(json.jsonify(</span>
<span class="c1">#                message=&#39;No user signed up with %s&#39; % user_data[&#39;email&#39;]</span>
<span class="c1">#                ), 403)</span>
<span class="c1">#</span>
<span class="c1">#        session[&#39;logged_in&#39;] = True</span>
<span class="c1">#        session[&#39;useremail&#39;] = get_user_email(g.db, user_id[1])</span>
<span class="c1">#</span>
<span class="c1">#        return make_response(json.jsonify(</span>
<span class="c1">#            show_signUpView=False,</span>
<span class="c1">#            is_alreadySignedUp=None,</span>
<span class="c1">#            email=None,</span>
<span class="c1">#            user_name=None), 200)</span>
<span class="c1">#</span>
<span class="c1">#    # SignUp with facebook</span>
<span class="c1">#    elif request.args.get(&#39;is_signUp&#39;) == &#39;Y&#39;:</span>
<span class="c1">#        facebook_id, _ = get_facebook_user_id(g.db, user_data[&#39;email&#39;])</span>
<span class="c1">#        # Defence duplicated facebook ID signing up</span>
<span class="c1">#        if facebook_id != -1:</span>
<span class="c1">#            return make_repsonse(json.jsonify(</span>
<span class="c1">#                message=&quot;You already signed up on facebook&quot;), 403)</span>
<span class="c1">#</span>
<span class="c1">#        user_id = get_user_id(g.db, user_data[&#39;email&#39;])</span>
<span class="c1">#        if user_id == -1:</span>
<span class="c1">#            return make_response(json.jsonify(</span>
<span class="c1">#                show_signUpView=True,</span>
<span class="c1">#                is_alreadySignedUp=False,</span>
<span class="c1">#                email=user_data[&#39;email&#39;],</span>
<span class="c1">#                user_name=user_data[&#39;name&#39;]), 200)</span>
<span class="c1">#        else:</span>
<span class="c1">#            new_facebook_id = get_new_id(g.db, &quot;D_FACEBOOK_USERS&quot;)</span>
<span class="c1">#            g.db.execute(&quot;INSERT INTO CICERON.D_FACEBOOK_USERS VALUES (%s,%s,%s) &quot;,</span>
<span class="c1">#                    (new_facebook_id, user_data[&#39;email&#39;], user_id))</span>
<span class="c1">#            g.db.commit()</span>
<span class="c1">#            return make_response(json.jsonify(</span>
<span class="c1">#                show_signUpView=True,</span>
<span class="c1">#                is_alreadySignedUp=True,</span>
<span class="c1">#                email=user_data[&#39;email&#39;],</span>
<span class="c1">#                user_name=user_data[&#39;name&#39;]), 200)</span>
<span class="c1">#</span>
<span class="c1">#@app.route(&quot;/api/facebook_connectUser&quot;, methods=[&quot;GET&quot;])</span>
<span class="c1">#@facebook.authorized_handler</span>
<span class="c1">#def facebook_connectUser(resp):</span>
<span class="c1">#    parameters = parse_request(request)</span>
<span class="c1">#    email = parameters[&#39;email&#39;]</span>
<span class="c1">#    user_id = get_user_id(g.db, email)</span>
<span class="c1">#</span>
<span class="c1">#    if facebook.get(&#39;/me&#39;).data[&#39;email&#39;] != email:</span>
<span class="c1">#        return make_response(json.jsonify(</span>
<span class="c1">#            message=&quot;DO NOT HACK!!!!&quot;), 403)</span>
<span class="c1">#</span>
<span class="c1">#    if user_id == -1:</span>
<span class="c1">#        return make_response(json.jsonify(</span>
<span class="c1">#            message=&quot;Not registered as normal user&quot;), 403)</span>
<span class="c1">#</span>
<span class="c1">#    new_facebook_id = get_new_id(g.db, &quot;D_FACEBOOK_USERS&quot;)</span>
<span class="c1">#    g.db.execute(&quot;INSERT INTO CICERON.D_FACEBOOK_USERS VALUES (%s,%s,%s) &quot;,</span>
<span class="c1">#            (new_facebook_id, email, user_id))</span>
<span class="c1">#    g.db.commit()</span>
<span class="c1">#</span>
<span class="c1">#    return make_response(json.jsonify(</span>
<span class="c1">#        message=&quot;Successfully connected with facebook ID&quot;), 200)</span>
<span class="c1">#</span>
<span class="c1">#@app.route(&quot;/api/facebook_signUp&quot;, methods=[&quot;POST&quot;])</span>
<span class="c1">#@facebook.authorized_handler</span>
<span class="c1">#def facebook_signUp(resp):</span>
<span class="c1">#    parameters = parse_request(request)</span>
<span class="c1">#    email = parameters[&#39;email&#39;]</span>
<span class="c1">#    # OAuth hacking check</span>
<span class="c1">#    if facebook.get(&#39;/me&#39;).data[&#39;email&#39;] != email:</span>
<span class="c1">#        return make_response(json.jsonify(</span>
<span class="c1">#            message=&quot;DO NOT HACK!!!!&quot;), 403)</span>
<span class="c1">#</span>
<span class="c1">#    hashed_password = parameters[&#39;password&#39;]</span>
<span class="c1">#    name = (parameters[&#39;name&#39;]).encode(&#39;utf-8&#39;)</span>
<span class="c1">#    mother_language_id = int(parameters[&#39;mother_language_id&#39;])</span>
<span class="c1">#    nationality_id = int(parameters[&#39;nationality_id&#39;])</span>
<span class="c1">#    residence_id = int(parameters[&#39;residence_id&#39;])</span>
<span class="c1">#    result = signUpQuick(g.db, email, hashed_password, name, mother_language_id, nationality_id, residence_id, external__service_provider=[&quot;facebook&quot;])</span>
<span class="c1">#</span>
<span class="c1">#    if result == 200:</span>
<span class="c1">#        return make_response(json.jsonify(message=&quot;Registration %s: successful&quot; % email), 200)</span>
<span class="c1">#    elif result == 412:</span>
<span class="c1">#        return make_response(json.jsonify(</span>
<span class="c1">#            message=&quot;ID %s is duplicated. Please check the email.&quot; % email), 412)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/logout&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="logout"><a class="viewcode-back" href="../../docs/app.application.html#app.application.logout">[문서]</a><span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    로그아웃 함수</span>
<span class="sd">        - session에 들어있는 모든 키 제거</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># No parameter needed</span>
    <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;logged_in&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">username_temp</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span>
        <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;logged_in&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;useremail&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Status code 200 (OK)</span>
        <span class="c1"># Logout success</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                   <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Logged out&quot;</span><span class="p">,</span>
                   <span class="n">email</span><span class="o">=</span><span class="n">username_temp</span>
               <span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Status code 403 (ERROR)</span>
        <span class="c1"># Description: Not logged in yet</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                   <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;You&#39;ve never logged in&quot;</span>
               <span class="p">),</span> <span class="mi">403</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/signup&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="signup"><a class="viewcode-back" href="../../docs/app.application.html#app.application.signup">[문서]</a><span class="k">def</span> <span class="nf">signup</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    회원가입 함수</span>
<span class="sd">    </span>
<span class="sd">    :param string email: 회원 email</span>
<span class="sd">    :param string password: sha256(password) 전송. Salt 없음</span>
<span class="sd">    :param string name: 이름</span>
<span class="sd">    :param int mother_tongue_id: 모국어 ID. ID-언어 대응은 원노트 참고</span>

<span class="sd">    핵심 동작 함수: ciceron_lib.signUpQuick()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c1"># Get parameter values</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
        <span class="n">hashed_password</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;mother_language_id&#39;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
            <span class="n">mother_language_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;mother_language_id&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Some parameters are missing&quot;</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span>

        <span class="n">nationality_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nationality_id&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nationality_id&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">residence_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;residence_id&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;residence_id&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">signUpQuick</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mother_language_id</span><span class="p">,</span> <span class="n">nationality_id</span><span class="p">,</span> <span class="n">residence_id</span><span class="p">)</span>

        <span class="c1"># Status code 200 (OK)</span>
        <span class="c1"># Description: Signed up successfully</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Registration successful&quot;</span><span class="p">,</span>
                <span class="n">email</span><span class="o">=</span><span class="n">email</span>
                <span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">412</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Duplicate email: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">email</span><span class="p">),</span> <span class="mi">412</span><span class="p">)</span>
    
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">417</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not email&quot;</span> <span class="o">%</span> <span class="n">email</span><span class="p">,</span>
                <span class="n">email</span><span class="o">=</span><span class="n">email</span>
                <span class="p">),</span> <span class="mi">417</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        &lt;!doctype html&gt;</span>
<span class="s1">        &lt;title&gt;Sign up&lt;/title&gt;</span>
<span class="s1">        &lt;h1&gt;Sign up&lt;/h1&gt;</span>
<span class="s1">        &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span>
<span class="s1">      &lt;p&gt;ID: &lt;input type=text name=&quot;email&quot;&gt;&lt;/p&gt;</span>
<span class="s1">      &lt;p&gt;Pass: &lt;input type=password name=&quot;password&quot;&gt;&lt;/p&gt;</span>
<span class="s1">      &lt;p&gt;Name: &lt;input type=text name=&quot;name&quot;&gt;&lt;/p&gt;</span>
<span class="s1">      &lt;p&gt;Mother language setting: &lt;input type=text name=&quot;mother_language_id&quot;&gt;&lt;/p&gt;</span>
<span class="s1">          &lt;p&gt;&lt;input type=submit value=&quot;Sign up!&quot;&gt;&lt;/p&gt;</span>
<span class="s1">        &lt;/form&gt;</span>
<span class="s1">        &#39;&#39;&#39;</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/idCheck&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="idChecker"><a class="viewcode-back" href="../../docs/app.application.html#app.application.idChecker">[문서]</a><span class="k">def</span> <span class="nf">idChecker</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ID 중복조회</span>

<span class="sd">        CICERON.D_USERS에 중복된 이메일주소가 있는지 살펴본다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Method: GET</span>
    <span class="c1"># Parameter: String id</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;email_id: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">email</span><span class="p">))</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select id from CICERON.D_USERS where email = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">check_data</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Status code 200 (OK)</span>
        <span class="c1"># Description: Inputted e-mail ID is available</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You may use the ID </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">email</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Status code 400 (BAD)</span>
        <span class="c1"># Description: Inputted e-mail ID is duplicated with other&#39;s one</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Duplicated ID &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">email</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/create_recovery_code&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="create_recovery_code"><a class="viewcode-back" href="../../docs/app.application.html#app.application.create_recovery_code">[문서]</a><span class="k">def</span> <span class="nf">create_recovery_code</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    패스워드 잊어버렸을 때 가입한 이메일로 복구 코드 전송</span>
<span class="sd">    담당하는 테이블: CICERON.EMERGENCY_CODE</span>
<span class="sd">    로직</span>
<span class="sd">        1. 유저 이름 받아옴 (핵심은 아니고, 이메일 보낼 때, Dear xx할 때 넣을 이름 조회 목적..)</span>
<span class="sd">        2. ciceron_lib.random_string_gen을 이용하여 랜덤 스트링 12자리로 이루어진 복구 코드를 받아옴</span>
<span class="sd">        3. UPDATE OR INSERT 복구코드</span>
<span class="sd">        4. 복구코드 이메일로 전송</span>

<span class="sd">    1 유저당 1레코드만 허용</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No user exists: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">email</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM CICERON.D_USERS WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">user_name</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">recovery_code</span> <span class="o">=</span> <span class="n">random_string_gen</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">hashed_code</span> <span class="o">=</span> <span class="n">get_hashed_password</span><span class="p">(</span><span class="n">recovery_code</span><span class="p">)</span>
    <span class="n">query_insert_emergency</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        WITH &quot;RECOV_UPDATE&quot; AS (</span>
<span class="s2">            UPDATE CICERON.EMERGENCY_CODE SET code = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                WHERE user_id = </span><span class="si">%s</span><span class="s2"> RETURNING *</span>
<span class="s2">        )</span>
<span class="s2">        INSERT INTO CICERON.EMERGENCY_CODE (user_id, code)</span>
<span class="s2">        SELECT </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2"> WHERE NOT EXISTS (SELECT * FROM &quot;RECOV_UPDATE&quot;)</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_insert_emergency</span><span class="p">,</span> <span class="p">(</span><span class="n">hashed_code</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">hashed_code</span><span class="p">))</span>
    <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Here is your temporary password&quot;</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;&lt;img src=&#39;</span><span class="si">%(host)s</span><span class="s2">/api/mail_img/img/logo.png&#39;&gt;&lt;br&gt;</span>
<span class="s2">                 &lt;span style=&#39;color:#5F9EA0&#39;&gt;&lt;h1&gt;Dear </span><span class="si">%(user)s</span><span class="s2">,&lt;/h1&gt;&lt;/span&gt;&lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 Here is your recovery code:&lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 &lt;h2&gt;&lt;b&gt;</span><span class="si">%(password)s</span><span class="s2">&lt;/b&gt;&lt;/h2&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 Please input the code above to &lt;a href=&quot;</span><span class="si">%(page)s</span><span class="s2">&quot;&gt;this page.&lt;/a&gt;&lt;br&gt;</span>
<span class="s2">                 Have a secure day! :)&lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 Best regards,&lt;br&gt;</span>
<span class="s2">                 Ciceron team&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span>
                         <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user_name</span><span class="p">,</span>
                         <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">recovery_code</span><span class="p">,</span>
                         <span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="n">HOST</span><span class="p">,</span>
                         <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="n">HOST</span> <span class="o">+</span> <span class="s1">&#39;:5000&#39;</span>
                         <span class="p">}</span>

    <span class="n">send_mail</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Password recovery code is issued for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">email</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/recover_password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="recover_password"><a class="viewcode-back" href="../../docs/app.application.html#app.application.recover_password">[문서]</a><span class="k">def</span> <span class="nf">recover_password</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    복구 코드를 받아 패스워드 재설정하는 부분</span>

<span class="sd">    로직</span>
<span class="sd">        1. 해당 ID의 복구코드 조회</span>
<span class="sd">        2. 새 패스워드 중 패스워드가 아무것도 없는 빈 스트링인 경우 막기 위하여 elif에서 빈 스트링에 대한 hash값은 빠꾸처리</span>
<span class="sd">        3. 패스워드 변경 후 복구 코드는 비움.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
    <span class="n">hashed_code</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
    <span class="n">hashed_new_password</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;new_password&#39;</span><span class="p">]</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>

    <span class="c1"># Get hashed_password using user_id for comparing</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT code FROM CICERON.EMERGENCY_CODE where user_id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Status code 500 (ERROR)</span>
        <span class="c1"># Description: Same e-mail address tried to be inserted into DB</span>
        <span class="k">return</span> <span class="n">make_response</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;Constraint violation error!&#39;</span><span class="p">),</span> <span class="mi">501</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">hashed_new_password</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;Need password&#39;</span><span class="p">),</span> <span class="mi">405</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">hashed_code</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.PASSWORDS SET hashed_pass = </span><span class="si">%s</span><span class="s2"> WHERE user_id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">hashed_new_password</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.EMERGENCY_CODE SET code = null WHERE user_id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;Password successfully changed for user </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">email</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;Security code incorrect!&#39;</span><span class="p">),</span> <span class="mi">403</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/change_password&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="change_password"><a class="viewcode-back" href="../../docs/app.application.html#app.application.change_password">[문서]</a><span class="k">def</span> <span class="nf">change_password</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    패스워드 변경</span>

<span class="sd">    로직</span>
<span class="sd">        1. 현재 패스워드의 sha256 값 불러와서 비교</span>
<span class="sd">        2. 일치하면 새로운 패스워드의 sha256값 엎어치기</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span>
    <span class="n">hashed_old_password</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;old_password&#39;</span><span class="p">]</span>
    <span class="n">hashed_new_password</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;new_password&#39;</span><span class="p">]</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>

    <span class="c1"># Get hashed_password using user_id for comparing</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT hashed_pass FROM CICERON.PASSWORDS where user_id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Status code 500 (ERROR)</span>
        <span class="c1"># Description: Same e-mail address tried to be inserted into DB</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;Constraint violation error!&#39;</span><span class="p">),</span> <span class="mi">501</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">hashed_new_password</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;Need password&#39;</span><span class="p">),</span> <span class="mi">405</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">hashed_old_password</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.PASSWORDS SET hashed_pass = </span><span class="si">%s</span><span class="s2"> WHERE user_id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">hashed_new_password</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;Password successfully changed for user </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">email</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;Old password of user </span><span class="si">%s</span><span class="s1"> is incorrect!&#39;</span> <span class="o">%</span> <span class="n">email</span><span class="p">),</span> <span class="mi">403</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/profile&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="user_profile"><a class="viewcode-back" href="../../docs/app.application.html#app.application.user_profile">[문서]</a><span class="k">def</span> <span class="nf">user_profile</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    프로파일 조회 API (GET), 정보 업데이트 API (POST)</span>

<span class="sd">    1) GET</span>
<span class="sd">        응답 정보는 원노트 조회 요망</span>

<span class="sd">        엥간한 유저 정보: CICERON.D_USERS</span>
<span class="sd">        일반 유저의 적립금 정보: CICERON.REVENUE  (뜻은 안 맞지만... 이전 설계때문에 이리 되었으니 참아주세요 ㅜㅜ)</span>
<span class="sd">        번역가 유저의 수당 정보: CICERON.RETURN_POINT</span>

<span class="sd">        GET으로 불러올 때 ?user_email=&lt;other_user_email&gt; 파라미터로 다른 유저 정보를 조회해올 수 있음</span>
<span class="sd">        이 때에는, 다른 유저의 포인트 및 적립금은 -65535로 마스킹됨.</span>

<span class="sd">    2) POST</span>
<span class="sd">        프로필 소개글이나 프로필 사진 변경가능</span>
<span class="sd">        프로필 사진 올릴 때에는 Content-Type을 JSON이나 www-urlencode말고, multipart/form-data로 업로드하기 바람</span>

<span class="sd">        프로파일 사진 바이너리는 CICERON.F_USER_PROFILE_PIC 에 저장됨. 서버에 물리 파일로 저장하지 않음에 유의.</span>
<span class="sd">        API 경로랍시고 profile_pic_path에 스트링 넣긴 하지만, 의미없음.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="c1"># Method: GET</span>
        <span class="c1"># Parameters</span>
        <span class="c1">#     user_email: String, text</span>
        <span class="c1"># Get value</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_email&#39;</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>

        <span class="c1"># Start logic</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM CICERON.D_USERS WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">userinfo</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c1"># Unique constraint check</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">userinfo</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;More than 2 records for one ID! Internal server error!&quot;</span><span class="p">),</span>
                <span class="mi">500</span><span class="p">)</span>

        <span class="c1"># Filter if there is no information with the given ID</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">userinfo</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Please check the input ID: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">email</span><span class="p">),</span>
                <span class="mi">400</span><span class="p">)</span>

        <span class="c1"># ID check: Are you requesting yours, or others?</span>
        <span class="c1">#     Yours -&gt; show including points</span>
        <span class="c1">#     Others-&gt; show except points</span>
        <span class="n">is_your_profile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">email</span> <span class="o">==</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]:</span> <span class="n">is_your_profile</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>                             <span class="n">is_your_profile</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Update statistics</span>
        <span class="n">update_user_record</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">translator_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>

        <span class="n">profile</span> <span class="o">=</span> <span class="n">getProfile</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_your_profile</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;user_isTranslator&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT amount FROM CICERON.REVENUE WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;user_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">is_your_profile</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;user_isTranslator&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT amount FROM CICERON.RETURN_POINT WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;user_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;user_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">65535</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">profile</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="c1"># Method: GET</span>
        <span class="c1"># Parameters</span>
        <span class="c1">#     user_email: String, text</span>
        <span class="c1">#     user_profilePic: binary</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># Get parameter value</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">profileText</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_profileText&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">profile_pic</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_profilePic&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">pic_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Start logic</span>
        <span class="c1"># Get user number</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

        <span class="c1"># Profile text update</span>
        <span class="k">if</span> <span class="n">profileText</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.D_USERS SET profile_text = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">profileText</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>

        <span class="c1"># Profile photo update</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">profile_pic</span> <span class="ow">and</span> <span class="n">pic_allowed_file</span><span class="p">(</span><span class="n">profile_pic</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="n">profile_pic</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">extension</span>
            <span class="n">pic_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;profile_pic&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>

            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.D_USERS SET profile_pic_path = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pic_path</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
            <span class="n">profile_pic_bin</span> <span class="o">=</span> <span class="n">profile_pic</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">query_insert</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                WITH &quot;UPDATE_PROFILE_PIC&quot; AS (</span>
<span class="s2">                    UPDATE CICERON.F_USER_PROFILE_PIC SET filename = </span><span class="si">%s</span><span class="s2">, bin = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                        WHERE user_id = </span><span class="si">%s</span><span class="s2"> RETURNING *</span>
<span class="s2">                )</span>
<span class="s2">                INSERT INTO CICERON.F_USER_PROFILE_PIC (user_id, filename, bin)</span>
<span class="s2">                SELECT </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2"> WHERE NOT EXISTS (SELECT * FROM &quot;UPDATE_PROFILE_PIC&quot;)</span>
<span class="s2">                &quot;&quot;&quot;</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_insert</span><span class="p">,</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">profile_pic_bin</span><span class="p">),</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">profile_pic_bin</span><span class="p">)))</span>

        <span class="c1">#if is_translator:</span>
        <span class="c1">#    g.db.execute(&quot;UPDATE D_USERS SET is_translator = ? WHERE email = ?&quot;, [is_translator, buffer(session[&#39;useremail&#39;])])</span>

        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Your profile is susccessfully updated!&quot;</span><span class="p">,</span>
            <span class="n">user_profileText</span><span class="o">=</span><span class="n">profileText</span><span class="p">,</span>
            <span class="n">user_profilePicPath</span><span class="o">=</span><span class="n">pic_path</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/profile/keywords/&lt;keyword&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="user_keywords_control"><a class="viewcode-back" href="../../docs/app.application.html#app.application.user_keywords_control">[문서]</a><span class="k">def</span> <span class="nf">user_keywords_control</span><span class="p">(</span><span class="n">keyword</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    프로파일에서 자신을 표현할 수 있는 키워드 기 입력된 키워드에서 검색(GET), 추가(POST), 및 삭제(DELETE)</span>
<span class="sd">    1) GET</span>
<span class="sd">        &lt;keyword&gt;에 집어 넣은 글자를 처음으로 하는, 기 입력된 키워드를 조회하여 후보를 보여준다.</span>
<span class="sd">        키워드 입력시, 연관검색어를 제공하고자 함이다.</span>

<span class="sd">    2) POST</span>
<span class="sd">        &lt;keyword&gt;를 입력한다.</span>
<span class="sd">        Keyword Dimension table: CICERON.D_KEYWORDS</span>
<span class="sd">        Keyword Fact table: CICERON.D_USER_KEYWORDS</span>

<span class="sd">        기 입력된 키워드면 키워드ID를 찾아서 유저별로 Mapping한다.</span>
<span class="sd">        기존에 입력된 키워드가 아니라면 Dimension table에 INSERT한다.</span>

<span class="sd">    3) DELETE</span>
<span class="sd">        해당 유저의 키워드에서 입력된 &lt;keyword&gt;를 삭제한다.</span>
<span class="sd">        Dimension table의 레코드는 건드리지 않고, Fact table에 적혀있는 mapping만 지운다.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;</span><span class="si">%%</span><span class="s2">2C&quot;</span> <span class="ow">in</span> <span class="n">keyword</span> <span class="ow">or</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">keyword</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No commna(&#39;,&#39;) in keyword&quot;</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span>

        <span class="n">keyword_id</span> <span class="o">=</span> <span class="n">get_id_from_text</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="s2">&quot;D_KEYWORDS&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyword_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">keyword_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;D_KEYWORDS&quot;</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.D_KEYWORDS VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">keyword_id</span><span class="p">,</span> <span class="n">keyword</span><span class="p">)</span> <span class="p">)</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.D_USER_KEYWORDS VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">keyword_id</span><span class="p">))</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Keyword &#39;</span><span class="si">%s</span><span class="s2">&#39; is inserted into user </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])),</span>
            <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">keyword_id</span> <span class="o">=</span> <span class="n">get_id_from_text</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="s2">&quot;D_KEYWORDS&quot;</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM CICERON.D_USER_KEYWORDS WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND keyword_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">keyword_id</span><span class="p">))</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Keyword &#39;</span><span class="si">%s</span><span class="s2">&#39; is deleted from user </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])),</span>
            <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT id, text FROM CICERON.D_KEYWORDS WHERE text like &#39;</span><span class="si">%s%%</span><span class="s2">&#39; &quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">keyword</span><span class="p">)</span>
        <span class="n">similar_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Similarity search results&quot;</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="n">similar_keywords</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/requests&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="requests"><a class="viewcode-back" href="../../docs/app.application.html#app.application.requests">[문서]</a><span class="k">def</span> <span class="nf">requests</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    번역물 의뢰 API</span>

<span class="sd">    로직</span>
<span class="sd">        1. 로그인 판별</span>
<span class="sd">        2. CICERON.F_REQUEST의 새로운 ID따기 (ciceron_lib.get_new_id() 사용)</span>
<span class="sd">        3. 여러 파라미터 받아옴 (원노트 API 문서 참고)</span>
<span class="sd">        4. 텍스트, 사진, 음성, 문서, i18n 등등의 형식에 따라 후처리</span>
<span class="sd">        5. 단문 번역의 경우, isSos = True, 이 경우에는 결제와 상관없이 is_paid = True</span>
<span class="sd">        6. 일반 의뢰의 경우, isSos = False, 이 경우에는 결제 진행해야 리스트에 보이게 해야 하므로, is_paid = False</span>
<span class="sd">        7. splitTrans는 번역 공동구매 여부 선택. is_sound, is_text, is_doc 의 true/false와는 독립적이다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;useremail&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;useremail&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="mi">403</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Not logged in&quot;</span><span class="p">),</span> <span class="mi">403</span><span class="p">)</span>

        <span class="c1"># Method: POST</span>
        <span class="c1"># Parameters -&gt; Please check code</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">request_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;F_REQUESTS&quot;</span><span class="p">)</span>
        <span class="n">client_user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;request_clientId&#39;</span><span class="p">])</span>
        <span class="n">original_lang_id</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;request_originalLang&#39;</span><span class="p">]</span>
        <span class="n">target_lang_id</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;request_targetLang&#39;</span><span class="p">]</span>
        <span class="n">isSos</span> <span class="o">=</span> <span class="n">parameter_to_bool</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;request_isSos&#39;</span><span class="p">])</span>
        <span class="n">format_id</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_format&#39;</span><span class="p">)</span>
        <span class="n">subject_id</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_subject&#39;</span><span class="p">)</span>
        <span class="n">is_text</span> <span class="o">=</span> <span class="n">parameter_to_bool</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_isText&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_text&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">text_string</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_text&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text_string</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">is_photo</span> <span class="o">=</span> <span class="n">parameter_to_bool</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_isPhoto&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">is_sound</span> <span class="o">=</span> <span class="n">parameter_to_bool</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_isSound&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">is_file</span> <span class="o">=</span> <span class="n">parameter_to_bool</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_isFile&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">is_docx</span> <span class="o">=</span> <span class="n">parameter_to_bool</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_isDocx&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">is_i18n</span> <span class="o">=</span> <span class="n">parameter_to_bool</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_isI18n&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">is_movie</span> <span class="o">=</span> <span class="n">parameter_to_bool</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_isMovie&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">is_groupRequest</span> <span class="o">=</span> <span class="n">parameter_to_bool</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_isGroupRequest&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">is_public</span> <span class="o">=</span> <span class="n">parameter_to_bool</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_isPublic&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">isSos</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">delta_from_due</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;request_deltaFromDue&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delta_from_due</span> <span class="o">=</span> <span class="mi">360</span> <span class="o">*</span> <span class="mi">60</span>

        <span class="n">point</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_points&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">isSos</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_context&#39;</span><span class="p">)</span>

        <span class="n">new_photo_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">new_sound_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">new_file_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">new_text_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">new_translation_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">new_context_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;D_CONTEXTS&quot;</span><span class="p">)</span>
        <span class="n">is_paid</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">isSos</span> <span class="o">==</span> <span class="kc">True</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">resell_price</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">number_of_member_in_group</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">is_public</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">resell_price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_resellPrice&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">is_groupRequest</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">number_of_member_in_group</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_numberOfMemberInGroup&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">isSos</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="p">(</span><span class="n">original_lang_id</span> <span class="o">==</span> <span class="mi">500</span> <span class="ow">or</span> <span class="n">target_lang_id</span> <span class="o">==</span> <span class="mi">500</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;The language you requested is not yet registered. SOS request only&quot;</span>
                <span class="p">),</span> <span class="mi">204</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">isSos</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_string</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">140</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Too long text for sos request&quot;</span><span class="p">,</span>
                <span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">text_string</span><span class="p">)</span>
                <span class="p">),</span> <span class="mi">417</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_file</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">new_file_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;D_REQUEST_FILES&quot;</span><span class="p">)</span>
            <span class="n">new_translated_file_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;D_TRANSLATED_FILES&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">text_string</span> <span class="ow">and</span> <span class="n">is_i18n</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">is_movie</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">new_text_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;D_REQUEST_TEXTS&quot;</span><span class="p">)</span>
            <span class="n">new_translation_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;D_TRANSLATED_TEXT&quot;</span><span class="p">)</span>

        <span class="c1"># Upload binaries into file and update each dimension table</span>
        <span class="c1">#if (request.files.get(&#39;request_photo&#39;) != None):</span>
        <span class="c1">#    binary = request.files[&#39;request_photo&#39;]</span>
        <span class="c1">#    filename = &quot;&quot;</span>
        <span class="c1">#    path = &quot;&quot;</span>
        <span class="c1">#    new_photo_id = get_new_id(g.db, &quot;D_REQUEST_PHOTOS&quot;)</span>
        <span class="c1">#    if pic_allowed_file(binary.filename):</span>
        <span class="c1">#        extension = binary.filename.split(&#39;.&#39;)[-1]</span>
        <span class="c1">#        filename = str(datetime.today().strftime(&#39;%Y%m%d%H%M%S%f&#39;)) + &#39;.&#39; + extension</span>
        <span class="c1">#        path = os.path.join(&quot;request_pic&quot;, str(new_photo_id), filename)</span>

        <span class="c1">#    photo_bin = binary.read()</span>
        <span class="c1">#    cursor.execute(&quot;INSERT INTO CICERON.D_REQUEST_PHOTOS (id, path, bin) VALUES (%s,%s,%s)&quot;, (new_photo_id, path, bytearray(photo_bin) ) )</span>

        <span class="c1">#if (request.files.get(&#39;request_sound&#39;) != None):</span>
        <span class="c1">#    binary = request.files[&#39;request_sound&#39;]</span>
        <span class="c1">#    filename = &quot;&quot;</span>
        <span class="c1">#    path = &quot;&quot;</span>
        <span class="c1">#    new_sound_id = get_new_id(g.db, &quot;D_REQUEST_SOUNDS&quot;)</span>
        <span class="c1">#    if sound_allowed_file(binary.filename):</span>
        <span class="c1">#        extension = binary.filename.split(&#39;.&#39;)[-1]</span>
        <span class="c1">#        filename = str(datetime.today().strftime(&#39;%Y%m%d%H%M%S%f&#39;)) + &#39;.&#39; + extension</span>
        <span class="c1">#        path = os.path.join(&quot;request_sounds&quot;, str(new_sound_id), filename)</span>

        <span class="c1">#    sound_bin = binary.read()</span>
        <span class="c1">#    cursor.execute(&quot;INSERT INTO CICERON.D_REQUEST_SOUNDS (id, path, bin) VALUES (%s,%s,%s)&quot;, (new_sound_id, path, bytearray(sound_bin) ) )</span>
        
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;INSERT INTO CICERON.F_REQUESTS</span>
<span class="s2">            (id, client_user_id, original_lang_id, target_lang_id, isSOS,</span>
<span class="s2">            status_id, format_id, subject_id, queue_id, ongoing_worker_id,</span>
<span class="s2">            is_text, text_id, is_photo, photo_id, is_file,</span>
<span class="s2">            file_id, is_sound, sound_id, client_completed_group_id, translator_completed_group_id,</span>
<span class="s2">            client_title_id, translator_title_id, registered_time, due_time, points,</span>
<span class="s2">            context_id, comment_id, tone_id, translatedText_id, is_paid,</span>
<span class="s2">            is_need_additional_points, is_i18n, is_movie, is_groupRequest, is_docx,</span>
<span class="s2">            is_public, resell_price, number_of_member_in_group</span>
<span class="s2">            )</span>
<span class="s2">                VALUES</span>
<span class="s2">                (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                 </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                 </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                 </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                 </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP + interval &#39;</span><span class="si">%s</span><span class="s2"> seconds&#39;, </span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                 </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                 </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                 </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;&quot;&quot;</span><span class="p">,</span> 
            <span class="p">(</span>
                    <span class="n">request_id</span><span class="p">,</span>                       <span class="c1"># id</span>
                    <span class="n">client_user_id</span><span class="p">,</span>                   <span class="c1"># client_user_id</span>
                    <span class="n">original_lang_id</span><span class="p">,</span>                 <span class="c1"># original_lang_id</span>
                    <span class="n">target_lang_id</span><span class="p">,</span>                   <span class="c1"># target_lang_id</span>
                    <span class="n">isSos</span><span class="p">,</span>                            <span class="c1"># isSOS</span>

                    <span class="mi">0</span><span class="p">,</span>                    <span class="c1"># status_id</span>
                    <span class="n">format_id</span><span class="p">,</span>            <span class="c1"># format_id</span>
                    <span class="n">subject_id</span><span class="p">,</span>           <span class="c1"># subject_id</span>
                    <span class="kc">None</span><span class="p">,</span>                 <span class="c1"># queue_id</span>
                    <span class="kc">None</span><span class="p">,</span>                 <span class="c1"># ongoing_worker_id</span>

                    <span class="n">is_text</span><span class="p">,</span>     <span class="c1"># is_text</span>
                    <span class="n">new_text_id</span><span class="p">,</span>          <span class="c1"># text_id</span>
                    <span class="n">is_photo</span><span class="p">,</span>             <span class="c1"># is_photo</span>
                    <span class="n">new_photo_id</span><span class="p">,</span>         <span class="c1"># photo_id</span>
                    <span class="n">is_file</span><span class="p">,</span>              <span class="c1"># is_file</span>

                    <span class="n">new_file_id</span><span class="p">,</span>          <span class="c1"># file_id</span>
                    <span class="n">is_sound</span><span class="p">,</span>             <span class="c1"># is_sound</span>
                    <span class="n">new_sound_id</span><span class="p">,</span>         <span class="c1"># sound_id</span>
                    <span class="kc">None</span><span class="p">,</span>                 <span class="c1"># client_completed_group_id</span>
                    <span class="kc">None</span><span class="p">,</span>                 <span class="c1"># translator_completed_group_id</span>

                    <span class="kc">None</span><span class="p">,</span>                 <span class="c1"># client_title_id</span>
                    <span class="kc">None</span><span class="p">,</span>                 <span class="c1"># translator_title_id</span>
                    <span class="n">delta_from_due</span><span class="p">,</span>       <span class="c1"># due_time</span>
                    <span class="n">point</span><span class="p">,</span>                <span class="c1"># points</span>

                    <span class="n">new_context_id</span><span class="p">,</span>       <span class="c1"># context_id</span>
                    <span class="kc">None</span><span class="p">,</span>                 <span class="c1"># comment_id</span>
                    <span class="kc">None</span><span class="p">,</span>                 <span class="c1"># tone_id</span>
                    <span class="n">new_translation_id</span><span class="p">,</span>                 <span class="c1"># translatedText_id</span>
                    <span class="n">is_paid</span><span class="p">,</span>              <span class="c1"># is_paid</span>

                    <span class="kc">False</span><span class="p">,</span>                <span class="c1"># is_need_additional_points</span>
                    <span class="n">is_i18n</span><span class="p">,</span>
                    <span class="n">is_movie</span><span class="p">,</span>
                    <span class="n">is_groupRequest</span><span class="p">,</span>
                    <span class="n">is_docx</span><span class="p">,</span>

                    <span class="n">is_public</span><span class="p">,</span>
                    <span class="n">resell_price</span><span class="p">,</span>
                    <span class="n">number_of_member_in_group</span><span class="p">,</span>
             <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">text_string</span> <span class="ow">and</span> <span class="n">is_i18n</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">is_movie</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;request_text&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_text_id</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>
            <span class="c1">#cursor.execute(&quot;INSERT INTO CICERON.D_REQUEST_TEXTS (id, path, text) VALUES (%s,%s,%s)&quot;, (new_text_id, path, text_string))</span>
            <span class="n">warehousing</span> <span class="o">=</span> <span class="n">Warehousing</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
            <span class="n">warehousing</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">new_text_id</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">text_string</span><span class="p">,</span> <span class="n">new_translation_id</span><span class="p">,</span> <span class="n">original_lang_id</span><span class="p">,</span> <span class="n">target_lang_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_file</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">binary</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;request_file&#39;</span><span class="p">]</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">extension</span>
            <span class="n">request_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;request_doc&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_file_id</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">translate_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;translated_doc&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_translated_file_id</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>

            <span class="n">file_bin</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.D_REQUEST_FILES (id, path, bin) VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">new_file_id</span><span class="p">,</span> <span class="n">request_path</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">file_bin</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.D_TRANSLATED_FILES (id, request_id, path, bin) VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,null)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">new_translated_file_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">translate_path</span><span class="p">,</span> <span class="p">))</span>

        <span class="k">if</span> <span class="n">is_i18n</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">i18nObj</span> <span class="o">=</span> <span class="n">I18nHandler</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
            <span class="n">i18n_file_format</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_i18nFileFormat&#39;</span><span class="p">)</span>
            <span class="n">i18n_binary</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;request_i18nFileBinary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">i18n_langKey</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_i18nLangKey&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i18n_file_format</span> <span class="o">==</span> <span class="s1">&#39;android&#39;</span><span class="p">:</span>
                    <span class="n">i18nObj</span><span class="o">.</span><span class="n">androidToDb</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">original_lang_id</span><span class="p">,</span> <span class="n">target_lang_id</span><span class="p">,</span> <span class="n">i18n_binary</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i18n_file_format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                    <span class="n">i18nObj</span><span class="o">.</span><span class="n">jsonToDb</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">i18n_langKey</span><span class="p">,</span> <span class="n">original_lang_id</span><span class="p">,</span> <span class="n">target_lang_id</span><span class="p">,</span> <span class="n">i18n_binary</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i18n_file_format</span> <span class="o">==</span> <span class="s1">&#39;iOS&#39;</span><span class="p">:</span>
                    <span class="n">i18nObj</span><span class="o">.</span><span class="n">iosToDb</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">original_lang_id</span><span class="p">,</span> <span class="n">target_lang_id</span><span class="p">,</span> <span class="n">i18n_binary</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i18n_file_format</span> <span class="o">==</span> <span class="s1">&#39;xamarin&#39;</span><span class="p">:</span>
                    <span class="n">i18nObj</span><span class="o">.</span><span class="n">xamarinToDb</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">original_lang_id</span><span class="p">,</span> <span class="n">target_lang_id</span><span class="p">,</span> <span class="n">i18n_binary</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i18n_file_format</span> <span class="o">==</span> <span class="s1">&#39;unity&#39;</span><span class="p">:</span>
                    <span class="n">i18nObj</span><span class="o">.</span><span class="n">unityToDb</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">i18n_langKey</span><span class="p">,</span> <span class="n">original_lang_id</span><span class="p">,</span> <span class="n">target_lang_id</span><span class="p">,</span> <span class="n">i18n_binary</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Something wrong in your file&quot;</span><span class="p">),</span> <span class="mi">413</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_groupRequest</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># 번역 공동구매 정보 입력</span>
            <span class="c1"># Execute own SQL in another module</span>
            <span class="n">groupRequestObj</span> <span class="o">=</span> <span class="n">GroupRequest</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
            <span class="n">groupRequestObj</span><span class="o">.</span><span class="n">addUserToGroup</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">client_user_id</span><span class="p">)</span>

        <span class="c1"># Input context text into dimension table</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.D_CONTEXTS VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">new_context_id</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>

        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">update_user_record</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="n">client_user_id</span><span class="p">)</span>

        <span class="c1"># Notification for SOS request</span>
        <span class="k">if</span> <span class="n">isSos</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">pick_random_translator</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">original_lang_id</span><span class="p">,</span> <span class="n">target_lang_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">:</span>
                <span class="n">store_notiTable</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
                <span class="c1">#regKeys_oneuser = get_device_id(g.db, item[0])</span>

                <span class="c1">#message_dict = get_noti_data(g.db, 1, item[0], request_id)</span>
                <span class="c1">#if len(regKeys_oneuser) &gt; 0:</span>
                <span class="c1">#    gcm_noti = gcm_server.send(regKeys_oneuser, message_dict)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Request has been posted!&quot;</span><span class="p">,</span>
            <span class="n">user_email</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;request_clientId&#39;</span><span class="p">],</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/stoa&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="translator_stoa"><a class="viewcode-back" href="../../docs/app.application.html#app.application.translator_stoa">[문서]</a><span class="k">def</span> <span class="nf">translator_stoa</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    번역가의 스토아 보여주기</span>

<span class="sd">    Store 아니다. Stoa다. 상점 아니다. 기둥 사이, 토론 공간이다.</span>

<span class="sd">    로직</span>
<span class="sd">        1. 일반 번역인 경우 (isSos = False) 작업중인 번역가가 없으며, (ongoing_worker_id = null) 번역 진행 상태가 pending이고, (status_id = 0) 번역비 결제가 된 경우 (is_paid = True)</span>
<span class="sd">        2. 단문 번역인 경우 (isSos = True) 모든 상태를 다 보여줌.</span>
<span class="sd">        3. 쿼리 후 결과를 ciceron_lib.json_form_V_REQUESTS()를 이용하여 Response를 parsing한다.</span>
<span class="sd">        4. ciceron_lib.json_form_V_REQUESTS()이 하는 일은, 각 의뢰에 필요한 정보를 추려 JSON 꼴로 만들어 주는 라이브러리 함수다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="c1"># Request method: GET</span>
        <span class="c1"># Parameters</span>
        <span class="c1">#     since(optional): Timestamp, take recent 20 post before the timestamp.</span>
        <span class="c1">#                  If this parameter is not provided, recent 20 posts from now are returned</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pager_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;useremail&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM CICERON.V_REQUESTS WHERE</span>
<span class="s2">                (((ongoing_worker_id is null AND status_id = 0 AND isSos = false) OR (isSos = true AND status_id IN (0, 1, 2) ))) AND due_time &gt; CURRENT_TIMESTAMP &quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM CICERON.V_REQUESTS WHERE</span>
<span class="s2">                (((ongoing_worker_id is null AND status_id = 0 AND isSos = false AND is_paid = true) OR (isSos = true AND status_id IN (0, 1, 2) ))) AND due_time &gt; CURRENT_TIMESTAMP &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND registered_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY registered_time DESC LIMIT 20 &quot;</span>

        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">pager_date</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s1">&#39;stoa_translator&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/pending&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<div class="viewcode-block" id="show_queue"><a class="viewcode-back" href="../../docs/app.application.html#app.application.show_queue">[문서]</a><span class="k">def</span> <span class="nf">show_queue</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    [현재는 사용 안함, 기획 후 사용할수도]</span>
<span class="sd">    번역가가 가격 네고를 건 티켓 보여주기 (GET), 가격제시하기 (POST)</span>
<span class="sd">    티켓 단가가 너무 낮아서 번역가들이 작업을 기피하고 있을 때, 번역가들이 티켓 가격을 좀만 올려주면 작업을 하겠다고 말해주는 가격제시 API</span>

<span class="sd">    GET 로직</span>
<span class="sd">        1. 장바구니 관리 테이블: CICERON.D_QUEUE_LISTS</span>
<span class="sd">        2. CICERON.D_QUEUE_LISTS에 있는 티켓 중 내 의뢰인 티켓 번호를 찾아 뿌려줌. 결제 완료 의뢰여야 함 (is_paid = True)</span>

<span class="sd">    POST 로직</span>
<span class="sd">        1. 기본적으로, 의뢰인 API에서는 의뢰인 입장에서 지불한 금액을 보여주고, 번역가 API에서는 번역가 입장에서 받을 수 있는 금액을 보여준다. 예를 들어, USD 5로 의뢰한 금액을 의뢰인한데는 USD 5로 보여주지만, 번역가에게는 USD 3.5로 보여준다. 번역가 입장에서는 5를 벌고 나중에 가져갈 때 1.5를 공제한다고 하는 것보단 아싸리 3.5 받는다고 하는게 여러모로 좋을 것이라 생각하기 때문이다.</span>
<span class="sd">        2. D_USERS 테이블을 보면 번역가의 등급에 따라 return_rate를 다르게 설정할 수 있다. 기본은 0.7이다. 즉, 의뢰금의 70%를 번역가가 가져간다.</span>
<span class="sd">        3. 이 원리를 거꾸로 생각하면, 번역가가 가격 제시를 할 때에는 return_rate를 고려하여 추가 결제금을 생각향 한다는 것이다. 예를 들어 0.7인 번역가가 7을 제시했으면 의뢰인한테 보여지는 금액은 10이 되어야 한다는 뜻이다.</span>
<span class="sd">        4. 나머지 짜글짜글한 exception의뜻들이 궁금하면 브라이언에게 문의..</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="c1"># Request method: GET</span>
        <span class="c1"># Parameters</span>
        <span class="c1">#     since(OPTIONAL): Timestamp integer, for paging</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">my_user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

        <span class="n">query_pending</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query_pending</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM CICERON.V_REQUESTS </span>
<span class="s2">                WHERE request_id IN (SELECT request_id FROM CICERON.D_QUEUE_LISTS WHERE user_id = </span><span class="si">%s</span><span class="s2">) &quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query_pending</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM CICERON.V_REQUESTS </span>
<span class="s2">                WHERE request_id IN (SELECT request_id FROM CICERON.D_QUEUE_LISTS WHERE user_id = </span><span class="si">%s</span><span class="s2">) AND is_paid = true &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">query_pending</span> <span class="o">+=</span> <span class="s2">&quot;AND registered_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
        <span class="n">query_pending</span> <span class="o">+=</span> <span class="s2">&quot;ORDER BY registered_time DESC LIMIT 20&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_pending</span><span class="p">,</span> <span class="p">(</span><span class="n">my_user_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="c1"># In POST, it should be changed into /user/translations/pending/&lt;request_id&gt;</span>
        <span class="c1"># But Error must be occurred because form data is not needed in the case of above.</span>

        <span class="c1"># Request method: POST</span>
        <span class="c1"># Parameters</span>
        <span class="c1">#     request_id: Integer</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># Translators in queue</span>
        <span class="c1"># Get request ID</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">])</span>
        <span class="n">translator_email</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;translator_email&#39;</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span> <span class="c1"># WILL USE FOR REQUESTING WITH TRANSLATOR SELECTING</span>
        <span class="n">translator_newPoint</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;translator_additionalPoint&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">translator_newPoint</span> <span class="o">&lt;</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Additional point should be bigger than USD 2.0&quot;</span>
                <span class="p">),</span> <span class="mi">417</span><span class="p">)</span>

        <span class="n">query_returnRate</span> <span class="o">=</span> <span class="s2">&quot;SELECT return_rate FROM CICERON.D_USERS WHERE email = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_returnRate</span><span class="p">,</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span> <span class="p">))</span>
        <span class="n">ret_returnRate</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">return_rate</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ret_returnRate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret_returnRate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">return_rate</span> <span class="o">=</span> <span class="n">ret_returnRate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">return_rate</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">translator_newPoint</span> <span class="o">=</span> <span class="n">translator_newPoint</span> <span class="o">/</span> <span class="n">return_rate</span>

        <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT queue_id, client_user_id, status_id, points, isSos FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT queue_id, client_user_id, status_id, points, isSos FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2"> AND is_paid = true &quot;</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;There is no request ID </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">translator_email</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>                        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">translator_email</span><span class="p">)</span>
        <span class="n">request_user_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">status_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">is_sos</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">is_sos</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&#39;Pending&#39; is not supported in SOS ticket&quot;</span>
                <span class="p">),</span> <span class="mi">409</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">strict_translator_checker</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                   <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;You have no translate permission of given language.&quot;</span>
                   <span class="p">),</span> <span class="mi">401</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="n">request_user_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;You cannot translate your request. Request ID: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">,</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span>
                <span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status_id</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Gone ticket. (Canceled or translated by others)&quot;</span>
                <span class="p">),</span> <span class="mi">410</span><span class="p">)</span>

        <span class="n">queue_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT user_id FROM CICERON.D_QUEUE_LISTS WHERE id = </span><span class="si">%s</span><span class="s2"> AND user_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">queue_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;You&#39;ve already stood in queue. Request ID: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request_id</span>
                <span class="p">),</span> <span class="mi">204</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">point</span> <span class="o">&gt;</span> <span class="n">translator_newPoint</span> <span class="o">-</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;New point should be bigger than the requested point&quot;</span>
                <span class="p">),</span> <span class="mi">417</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">queue_id</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">queue_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;D_QUEUE_LISTS&quot;</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET queue_id = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">queue_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>

        <span class="n">query</span><span class="o">=</span><span class="s2">&quot;INSERT INTO CICERON.D_QUEUE_LISTS VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">queue_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">translator_newPoint</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">update_user_record</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="n">request_user_id</span><span class="p">,</span> <span class="n">translator_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;You proposed a new price of request #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">,</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span>
            <span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/pending/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="nd">@translator_checker</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="work_in_queue"><a class="viewcode-back" href="../../docs/app.application.html#app.application.work_in_queue">[문서]</a><span class="k">def</span> <span class="nf">work_in_queue</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    네고를 걸었던 티켓 네고취소 (DELETE), 네고금액 수정 (PUT)</span>
<span class="sd">    네고 로직 돌아가는 원리는 바로 위 API의 설명 참고</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">my_user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT count(*) FROM CICERON.D_QUEUE_LISTS WHERE request_id = </span><span class="si">%s</span><span class="s2"> AND user_id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">my_user_id</span><span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span>
                       <span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;You are not in the queue of request ID #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">),</span>
                   <span class="mi">204</span><span class="p">)</span>
            
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM CICERON.D_QUEUE_LISTS WHERE request_id = </span><span class="si">%s</span><span class="s2"> AND user_id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">my_user_id</span><span class="p">))</span>
        <span class="n">update_user_record</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">translator_id</span><span class="o">=</span><span class="n">my_user_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You&#39;ve dequeued from request #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">,</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;PUT&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_request_id</span><span class="p">)</span>
        <span class="n">my_user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">translator_newPoint</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;translator_newPoint&#39;</span><span class="p">]</span>

        <span class="n">query_getQueueID</span> <span class="o">=</span> <span class="s2">&quot;SELECT queue_id, client_user_id, status_id, points FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_getQueueID</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You cannot update the point if you didn&#39;t join the nego&quot;</span><span class="p">),</span> <span class="mi">410</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">translator_newPoint</span> <span class="o">&lt;</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Additional point should be bigger than USD 2.0&quot;</span>
                <span class="p">),</span> <span class="mi">417</span><span class="p">)</span>

        <span class="n">queue_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">query_updateNego</span> <span class="o">=</span> <span class="s2">&quot;UPDATE CICERON.D_QUEUE_LISTS SET nego_price = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_updateNego</span><span class="p">,</span> <span class="p">(</span><span class="n">translator_newPoint</span><span class="p">,</span> <span class="n">queue_id</span><span class="p">,</span> <span class="p">))</span>

        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Point updated&quot;</span><span class="p">,</span>
            <span class="n">point</span><span class="o">=</span><span class="n">translator_newPoint</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/ongoing&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="nd">@translator_checker</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="pick_request"><a class="viewcode-back" href="../../docs/app.application.html#app.application.pick_request">[문서]</a><span class="k">def</span> <span class="nf">pick_request</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    내가 번역중인 티켓 리스트 보여주기 (GET), 내가 번역하기 (POST)</span>

<span class="sd">    POST 로직</span>
<span class="sd">        1. 혹시 다른 번역가가 작업중인지 체크</span>
<span class="sd">        2. 이미 내가 번역중인지 체크</span>
<span class="sd">        3. 내가 해당 언어쌍에 번역 권한이 있는지 체크 (ciceron_lib.strict_translator_checker() )</span>
<span class="sd">        4. 번역중 상태로 바꿈 (status_id = 1), 번역중인 번역가를 내 ID로 고침 (ongoing_worker_id = %s)</span>
<span class="sd">        5. 네고 중이었다면, 네고 테이블에서 삭제</span>
<span class="sd">        6. 이메일 알람 전송</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="c1"># Request method: POST</span>
        <span class="c1"># Parameters</span>
        <span class="c1">#    request_id: requested post id</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">])</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT queue_id, client_user_id FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2"> AND status_id = 0&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Request </span><span class="si">%d</span><span class="s2"> has already benn taken by other translator, or deleted.&quot;</span> <span class="o">%</span> <span class="n">request_id</span>
                    <span class="p">),</span> <span class="mi">410</span><span class="p">)</span>

        <span class="n">queue_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">request_user_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="n">request_user_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;You cannot translate your request. Request ID: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request_id</span>
                <span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">strict_translator_checker</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                   <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;You have no translate permission of given language.&quot;</span>
                   <span class="p">),</span> <span class="mi">401</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET status_id = 1, ongoing_worker_id = </span><span class="si">%s</span><span class="s2">, start_translating_time = CURRENT_TIMESTAMP WHERE id = </span><span class="si">%s</span><span class="s2"> AND status_id = 0&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">))</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM CICERON.D_QUEUE_LISTS WHERE id = </span><span class="si">%s</span><span class="s2"> and request_id = </span><span class="si">%s</span><span class="s2"> and user_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">queue_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">update_user_record</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="n">request_user_id</span><span class="p">,</span> <span class="n">translator_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># Notification</span>
        <span class="n">send_noti_lite</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">request_user_id</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span>
                <span class="n">optional_info</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hero&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">})</span>

        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;You are now tranlator of request #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">,</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span>
            <span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="c1"># Request method: GET</span>
        <span class="c1"># Parameters</span>
        <span class="c1">#     page (optional): Integer</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">query_ongoing</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query_ongoing</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM CICERON.V_REQUESTS WHERE status_id = 1 AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query_ongoing</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM CICERON.V_REQUESTS WHERE status_id = 1 AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            AND ( (is_paid = true AND is_need_additional_points = false) OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) ) &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">query_ongoing</span> <span class="o">+=</span> <span class="s2">&quot;AND start_translating_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
        <span class="n">query_ongoing</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY start_translating_time DESC LIMIT 20 &quot;</span>

        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">my_user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_ongoing</span><span class="p">,</span> <span class="p">(</span><span class="n">my_user_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;ongoing_translator&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/ongoing/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="working_translate_item"><a class="viewcode-back" href="../../docs/app.application.html#app.application.working_translate_item">[문서]</a><span class="k">def</span> <span class="nf">working_translate_item</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    번역중인 티켓 개별로 보기</span>

<span class="sd">    로직</span>
<span class="sd">        1. 기본적으로 위와 로직은 동일</span>
<span class="sd">        2. 그런데 웨어하우징된 티켓을 프론트에 맞게 재구성하여 보여줌</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT count(*) FROM CICERON.V_REQUESTS WHERE status_id = 1 AND request_id = </span><span class="si">%s</span><span class="s2"> AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You are not translator of the request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

        <span class="n">warehousing</span> <span class="o">=</span> <span class="n">Warehousing</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM CICERON.V_REQUESTS WHERE status_id = 1 AND request_id = </span><span class="si">%s</span><span class="s2"> &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM CICERON.V_REQUESTS WHERE status_id = 1 AND request_id = </span><span class="si">%s</span><span class="s2"> AND</span>
<span class="s2">            ( (is_paid = true AND is_need_additional_points = false) OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) ) &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND start_translating_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY start_translating_time desc LIMIT 20 &quot;</span>

        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>

        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;ongoing_translator&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
            <span class="n">realData</span><span class="o">=</span><span class="n">warehousing</span><span class="o">.</span><span class="n">restoreArray</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
            <span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/ongoing/&lt;int:request_id&gt;/paragraph/&lt;int:paragraph_id&gt;/sentence/&lt;int:sentence_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="reviseTranslatedItemByEachLine"><a class="viewcode-back" href="../../docs/app.application.html#app.application.reviseTranslatedItemByEachLine">[문서]</a><span class="k">def</span> <span class="nf">reviseTranslatedItemByEachLine</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">paragraph_id</span><span class="p">,</span> <span class="n">sentence_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    문장별 번역 업데이트(PUT), 문장별 원문/번역 살펴보기 (GET)</span>

<span class="sd">    로직</span>
<span class="sd">        1. 일단 자신이 번역하는 티켓인지 체크</span>
<span class="sd">        2. 그 다음 보여줄 지, 업데이트할지 하는거 함.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT count(*) FROM CICERON.V_REQUESTS WHERE status_id = 1 AND request_id = </span><span class="si">%s</span><span class="s2"> AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You are not translator of the request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;PUT&quot;</span><span class="p">:</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
        <span class="n">warehousing</span> <span class="o">=</span> <span class="n">Warehousing</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">is_ok</span> <span class="o">=</span> <span class="n">warehousing</span><span class="o">.</span><span class="n">updateTranslationOneLine</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">paragraph_id</span><span class="p">,</span> <span class="n">sentence_id</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">is_ok</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sentence saved.&quot;</span><span class="p">,</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span>
                <span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sentence save failure.&quot;</span><span class="p">,</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span>
                <span class="p">),</span> <span class="mi">401</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">warehousing</span> <span class="o">=</span> <span class="n">Warehousing</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">is_ok</span><span class="p">,</span> <span class="n">sentence</span> <span class="o">=</span> <span class="n">warehousing</span><span class="o">.</span><span class="n">getTranslationOneLine</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">paragraph_id</span><span class="p">,</span> <span class="n">sentence_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_ok</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">sentence</span><span class="o">=</span><span class="n">sentence</span>
                <span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Get sentence failure.&quot;</span>
                <span class="p">),</span> <span class="mi">401</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/comment/&lt;int:request_id&gt;/paragraph/&lt;int:paragraph_id&gt;/sentence/&lt;int:sentence_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PUT&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="updateSentenceComment"><a class="viewcode-back" href="../../docs/app.application.html#app.application.updateSentenceComment">[문서]</a><span class="k">def</span> <span class="nf">updateSentenceComment</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">paragraph_id</span><span class="p">,</span> <span class="n">sentence_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    문장별 주석 달기</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT count(*) FROM CICERON.V_REQUESTS WHERE status_id = 1 AND request_id = </span><span class="si">%s</span><span class="s2"> AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You are not translator of the request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;PUT&quot;</span><span class="p">:</span>
        <span class="n">warehousing</span> <span class="o">=</span> <span class="n">Warehousing</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">parameter</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">comment_string</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comment_string&#39;</span><span class="p">)</span>

        <span class="n">warehousing</span><span class="o">.</span><span class="n">updateSentenceComment</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">paragraph_id</span><span class="p">,</span> <span class="n">sentence_id</span><span class="p">,</span> <span class="n">comment_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Update success&#39;</span><span class="p">,</span>
                    <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
                    <span class="n">paragraph_seq</span><span class="o">=</span><span class="n">paragraph_id</span><span class="p">,</span>
                    <span class="n">sentence_seq</span><span class="o">=</span><span class="n">sentence_id</span><span class="p">,</span>
                    <span class="n">comment_string</span><span class="o">=</span><span class="n">comment_string</span>
                    <span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/comment/&lt;int:request_id&gt;/paragraph/&lt;int:paragraph_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PUT&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="updateParagraphComment"><a class="viewcode-back" href="../../docs/app.application.html#app.application.updateParagraphComment">[문서]</a><span class="k">def</span> <span class="nf">updateParagraphComment</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">paragraph_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    문단별 주석 달기 (혼동주의: 위는 문장별, 여기는 문단별)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT count(*) FROM CICERON.V_REQUESTS WHERE status_id = 1 AND request_id = </span><span class="si">%s</span><span class="s2"> AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You are not translator of the request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;PUT&quot;</span><span class="p">:</span>
        <span class="n">warehousing</span> <span class="o">=</span> <span class="n">Warehousing</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">parameter</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">comment_string</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comment_string&#39;</span><span class="p">)</span>

        <span class="n">warehousing</span><span class="o">.</span><span class="n">updateParagraphComment</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">paragraph_id</span><span class="p">,</span> <span class="n">comment_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Update success&#39;</span><span class="p">,</span>
                    <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
                    <span class="n">paragraph_seq</span><span class="o">=</span><span class="n">paragraph_id</span><span class="p">,</span>
                    <span class="n">comment_string</span><span class="o">=</span><span class="n">comment_string</span>
                    <span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/ongoing/i18n/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="i18n_checkSourceAndTranslation"><a class="viewcode-back" href="../../docs/app.application.html#app.application.i18n_checkSourceAndTranslation">[문서]</a><span class="k">def</span> <span class="nf">i18n_checkSourceAndTranslation</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    i18n 번역 불러오기</span>
<span class="sd">    i18nHandler.jsonResponse() 사용</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">has_translation_auth</span> <span class="o">=</span> <span class="n">translationAuthChecker</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_translation_auth</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You are not translator of the request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

        <span class="n">i18nObj</span> <span class="o">=</span> <span class="n">I18nHandler</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">i18nObj</span><span class="o">.</span><span class="n">jsonResponse</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">is_restricted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM CICERON.V_REQUESTS WHERE request_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;ongoing_translator&quot;</span><span class="p">),</span>
            <span class="n">realData</span><span class="o">=</span><span class="n">result</span>
            <span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/complete/i18n/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="i18n_completedCheckSourceAndTranslation"><a class="viewcode-back" href="../../docs/app.application.html#app.application.i18n_completedCheckSourceAndTranslation">[문서]</a><span class="k">def</span> <span class="nf">i18n_completedCheckSourceAndTranslation</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    i18n 번역 불러오기</span>
<span class="sd">    i18nHandler.jsonResponse() 사용</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">has_translation_auth</span> <span class="o">=</span> <span class="n">translationAuthChecker</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_translation_auth</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You are not translator of the request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

        <span class="n">i18nObj</span> <span class="o">=</span> <span class="n">I18nHandler</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">i18nObj</span><span class="o">.</span><span class="n">jsonResponse</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">is_restricted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM CICERON.V_REQUESTS WHERE request_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;complete_translator&quot;</span><span class="p">),</span>
            <span class="n">realData</span><span class="o">=</span><span class="n">result</span>
            <span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/ongoing/i18n/&lt;int:request_id&gt;/variable/&lt;int:variable_id&gt;/paragraph/&lt;int:paragraph_seq&gt;/sentence/&lt;int:sentence_seq&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PUT&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="i18n_updateSentence"><a class="viewcode-back" href="../../docs/app.application.html#app.application.i18n_updateSentence">[문서]</a><span class="k">def</span> <span class="nf">i18n_updateSentence</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">variable_id</span><span class="p">,</span> <span class="n">paragraph_seq</span><span class="p">,</span> <span class="n">sentence_seq</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    해당 Variable, 해당 문단의 해당 문장 번역 업데이트.</span>
<span class="sd">    i18nHandler.updateTranslation() 사용</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">has_translation_auth</span> <span class="o">=</span> <span class="n">translationAuthChecker</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_translation_auth</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You are not translator of the request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>

        <span class="n">i18nObj</span> <span class="o">=</span> <span class="n">I18nHandler</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">i18nObj</span><span class="o">.</span><span class="n">updateTranslation</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">variable_id</span><span class="p">,</span> <span class="n">paragraph_seq</span><span class="p">,</span> <span class="n">sentence_seq</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Update success&quot;</span><span class="p">,</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
                <span class="n">variable_id</span><span class="o">=</span><span class="n">variable_id</span><span class="p">,</span>
                <span class="n">paragraph_seq</span><span class="o">=</span><span class="n">paragraph_seq</span><span class="p">,</span>
                <span class="n">sentence_seq</span><span class="o">=</span><span class="n">sentence_seq</span>
            <span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/ongoing/i18n/&lt;int:request_id&gt;/variable/&lt;int:variable_id&gt;/comment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PUT&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="i18n_updateComment"><a class="viewcode-back" href="../../docs/app.application.html#app.application.i18n_updateComment">[문서]</a><span class="k">def</span> <span class="nf">i18n_updateComment</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">variable_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    각 Variable의 comment를 다는 API</span>
<span class="sd">    평문 번역과는 다르게 i18n 번역에서는 comment를 문장별로 달지 않고 variable 별로 단다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">has_translation_auth</span> <span class="o">=</span> <span class="n">translationAuthChecker</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_translation_auth</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You are not translator of the request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">comment_string</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;comment_string&#39;</span><span class="p">]</span>

        <span class="n">i18nObj</span> <span class="o">=</span> <span class="n">I18nHandler</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">i18nObj</span><span class="o">.</span><span class="n">updateComment</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">variable_id</span><span class="p">,</span> <span class="n">comment_string</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Update success&quot;</span><span class="p">,</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
                <span class="n">variable_id</span><span class="o">=</span><span class="n">variable_id</span>
            <span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/ongoing/&lt;int:request_id&gt;/file&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="getOrUpdateFile"><a class="viewcode-back" href="../../docs/app.application.html#app.application.getOrUpdateFile">[문서]</a><span class="k">def</span> <span class="nf">getOrUpdateFile</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    다중파일의뢰 파일 가져오기(GET) / 업데이트(PUT)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">does_have_auth</span> <span class="o">=</span> <span class="n">translationAuthChecker</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">does_have_auth</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You are not translator of the request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">query_getFile</span> <span class="o">=</span> <span class="s2">&quot;SELECT bin FROM CICERON.D_TRANSLATED_FILES WHERE request_id = </span><span class="si">%s</span><span class="s2"> and bin is not null&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_getFile</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">request_file</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">request_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;No request file&quot;</span><span class="p">),</span> <span class="mi">404</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">request_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">attachment_filename</span><span class="o">=</span><span class="s2">&quot;result.zip&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;PUT&quot;</span><span class="p">:</span>
        <span class="n">query_updateFile</span> <span class="o">=</span> <span class="s2">&quot;UPDATE CICERON.D_TRANSLATED_FILES SET bin = </span><span class="si">%s</span><span class="s2"> WHERE request_id = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">binary</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;translated_file&#39;</span><span class="p">]</span>
        <span class="n">file_bin</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_updateFile</span><span class="p">,</span> <span class="p">(</span><span class="n">file_bin</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Update success&quot;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/complete/&lt;int:request_id&gt;/insertPair&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="savePair"><a class="viewcode-back" href="../../docs/app.application.html#app.application.savePair">[문서]</a><span class="k">def</span> <span class="nf">savePair</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    다중 파일 Request를 완료하면서 결과물 텍스트 혹은 바이너리 입력</span>
<span class="sd">    바이너리인지 아닌지는 decode시 에러가 나는지 아닌지로 판단</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">translated_filename</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;translated_filenames&#39;</span><span class="p">])</span>
        <span class="n">translated_pair</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;translated_text&#39;</span><span class="p">])</span>

        <span class="n">new_text_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;D_UNORGANIZED_TRANSLATED_RESULT&quot;</span><span class="p">)</span>
        <span class="n">query_findFileId</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT file_id FROM CICERON.F_REQUESTS</span>
<span class="s2">            WHERE (client_user_id = </span><span class="si">%s</span><span class="s2"> OR ongoing_worker_id = </span><span class="si">%s</span><span class="s2">) AND id = </span><span class="si">%s</span><span class="s2"> AND is_file = true</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_findFileId</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid file request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

        <span class="n">file_id</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">query_insert</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            INSERT INTO CICERON.D_UNORGANIZED_TRANSLATED_RESULT</span>
<span class="s2">              (id, request_id, file_id, translated_text, translated_file)</span>
<span class="s2">            VALUES</span>
<span class="s2">              (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">text_or_bin</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">translated_filename</span><span class="p">,</span> <span class="n">translated_pair</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">text_or_bin</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_insert</span><span class="p">,</span> <span class="p">(</span><span class="n">new_text_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">file_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">text_or_bin</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_insert</span><span class="p">,</span> <span class="p">(</span><span class="n">new_text_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">file_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">text_or_bin</span><span class="p">,</span> <span class="p">))</span>

        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Insert success&quot;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/complete/&lt;int:request_id&gt;/file&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="getFileForClient"><a class="viewcode-back" href="../../docs/app.application.html#app.application.getFileForClient">[문서]</a><span class="k">def</span> <span class="nf">getFileForClient</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    다중파일의뢰 파일 가져오기(GET) / 업데이트(PUT)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">does_have_auth</span> <span class="o">=</span> <span class="n">clientAuthChecker</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">does_have_auth</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You are not client of the request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">query_getFile</span> <span class="o">=</span> <span class="s2">&quot;SELECT bin FROM CICERON.D_TRANSLATED_FILES WHERE request_id = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_getFile</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">request_file</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">request_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;No request file&quot;</span><span class="p">),</span> <span class="mi">404</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">request_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">attachment_filename</span><span class="o">=</span><span class="s2">&quot;result.zip&quot;</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/ongoing/&lt;int:request_id&gt;/expected&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="expected_time"><a class="viewcode-back" href="../../docs/app.application.html#app.application.expected_time">[문서]</a><span class="k">def</span> <span class="nf">expected_time</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    (현재 사용하지 않음)</span>
<span class="sd">    예상완료시간 보기 (GET), 입력(POST), 번역포기 (DELETE)</span>

<span class="sd">    번역가가 번역을 하겠다고 마킹을 하면 바로 번역을 진행하는 것이 아니라, 먼저 본문을 한 번 열람을 하고,</span>
<span class="sd">    언제까지 번역이 가능한지 예상 시간을 입력한다. (혹은 번역 포기를 한다.)</span>
<span class="sd">    만약 번역하겠다고 한 시간에서 1/3 시점까지 예상시간을 입력하지 않으면 자동으로 번역불가로 간주하고 도로 스토아로 되돌려놓는다.</span>
<span class="sd">    주가 되는 column은 CICERON.F_REQUESTS.expected_time이다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT expected_time, due_time FROM CICERON.F_REQUESTS WHERE status_id = 1 AND id = </span><span class="si">%s</span><span class="s2"> &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT expected_time, due_time FROM CICERON.F_REQUESTS WHERE status_id = 1 AND id = </span><span class="si">%s</span><span class="s2"> AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            AND ( (is_paid = true AND is_need_additional_points = false) OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) ) &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND start_translating_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY start_translating_time desc LIMIT 20 &quot;</span>
        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">currentExpectedTime</span><span class="o">=</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">currentDueTime</span><span class="o">=</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">200</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Outscoped (Completed, canceled, etc)&quot;</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

        <span class="n">deltaFromRegTime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;deltaFromNow&#39;</span><span class="p">])</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET expected_time = CURRENT_TIMESTAMP + interval &#39;</span><span class="si">%s</span><span class="s2"> seconds&#39; WHERE status_id = 1 AND id = </span><span class="si">%s</span><span class="s2"> AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">deltaFromRegTime</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


        <span class="c1"># Notification</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT client_user_id, expected_time FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">send_noti_lite</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">8</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">optional_info</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]})</span>

        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Thank you for responding!&quot;</span><span class="p">,</span>
            <span class="n">currentExpectedTime</span><span class="o">=</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET ongoing_worker_id = null, status_id = 0, points = points + additional_points, is_need_additional_points = false, is_additional_points_paid = null WHERE status_id = 1 AND id = </span><span class="si">%s</span><span class="s2"> AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT due_time FROM CICERON.F_REQUESTS WHERE status_id = 1 AND id = </span><span class="si">%s</span><span class="s2"> &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT due_time FROM CICERON.F_REQUESTS WHERE status_id = 1 AND id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                AND ( (is_paid = true AND is_need_additional_points = false) OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) ) &quot;&quot;&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>

        <span class="n">client_user_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">translator_user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

        <span class="n">update_user_record</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="n">client_user_id</span><span class="p">,</span> <span class="n">translator_id</span><span class="o">=</span><span class="n">translator_user_id</span><span class="p">)</span>

        <span class="c1"># Notification</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT client_user_id, ongoing_worker_id FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">send_noti_lite</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">9</span><span class="p">,</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">optional_info</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hero&quot;</span><span class="p">:</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]})</span>

        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Wish a better tomorrow!&quot;</span><span class="p">,</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/complete&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<span class="nd">@translator_checker</span>
<div class="viewcode-block" id="post_translate_item"><a class="viewcode-back" href="../../docs/app.application.html#app.application.post_translate_item">[문서]</a><span class="k">def</span> <span class="nf">post_translate_item</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    해당 의뢰 번역 완료 선언을 하는 곳이다.</span>
<span class="sd">    로직</span>
<span class="sd">        1. status_id = 1인 놈을 status_id = 2로 업데이트</span>
<span class="sd">        2. 작업 완료한 번역은 폴더 관리가 된다. 폴더 중 Incoming 폴더에 갖다 집어넣는다. 만약 없다면 만들어 준 다음 집어넣는다.</span>
<span class="sd">        3. 처음 가입할 때에는 작업 완료된 폴더가 없다. 처음 완료할 때 생성된다. 나중에 번역완료 탭에 가서 폴더를 옮길 수 있다.</span>
<span class="sd">        4. 해당 의뢰에 네고를 건 것들 모두 삭제한다.</span>
<span class="sd">        5. 공동구매인 경우, 공동구매한 모든 사람에게 완료 그룹 생성</span>
<span class="sd">        6. 이메일 노티 전송</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">])</span>

    <span class="c1"># Assign default group to requester and translator</span>
    <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT client_user_id, ongoing_worker_id, is_groupRequest FROM CICERON.V_REQUESTS WHERE request_id = </span><span class="si">%s</span><span class="s2"> AND status_id = 1 &quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT client_user_id, ongoing_worker_id, is_groupRequest FROM CICERON.V_REQUESTS WHERE request_id = </span><span class="si">%s</span><span class="s2"> AND status_id = 1 AND </span>
<span class="s2">        ( (is_paid = true AND is_need_additional_points = false) OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) )&quot;&quot;&quot;</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span>
            <span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Already completed request </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">,</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">),</span> <span class="mi">410</span><span class="p">)</span>

    <span class="n">requester_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">translator_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">is_groupRequest</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">translator_default_group_id</span> <span class="o">=</span>  <span class="n">get_group_id_from_user_and_text</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">translator_id</span><span class="p">,</span> <span class="s2">&quot;Incoming&quot;</span><span class="p">,</span> <span class="s2">&quot;D_TRANSLATOR_COMPLETED_GROUPS&quot;</span><span class="p">)</span>
    <span class="c1"># No default group. Insert new default group entry for user</span>
    <span class="k">if</span> <span class="n">translator_default_group_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">translator_default_group_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;D_TRANSLATOR_COMPLETED_GROUPS&quot;</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.D_TRANSLATOR_COMPLETED_GROUPS VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">translator_default_group_id</span><span class="p">,</span> <span class="n">translator_id</span><span class="p">,</span> <span class="s2">&quot;Incoming&quot;</span><span class="p">))</span>


    <span class="n">requester_default_group_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">is_groupRequest</span><span class="p">:</span>
        <span class="n">groupRequestObj</span> <span class="o">=</span> <span class="n">GroupRequest</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">groupMembers</span> <span class="o">=</span> <span class="n">groupRequestObj</span><span class="o">.</span><span class="n">checkGroupMembers</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">each_user_id</span><span class="p">,</span> <span class="n">is_paid</span><span class="p">,</span> <span class="n">payment_playform</span><span class="p">,</span> <span class="n">transaction_id</span> <span class="ow">in</span> <span class="n">groupMembers</span><span class="p">:</span>
            <span class="n">requester_default_group_id</span> <span class="o">=</span> <span class="n">get_group_id_from_user_and_text</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">each_user_id</span><span class="p">,</span> <span class="s2">&quot;Incoming&quot;</span><span class="p">,</span> <span class="s2">&quot;D_CLIENT_COMPLETED_GROUPS&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">requester_default_group_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">requester_default_group_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;D_CLIENT_COMPLETED_GROUPS&quot;</span><span class="p">)</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.D_CLIENT_COMPLETED_GROUPS VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">requester_default_group_id</span><span class="p">,</span> <span class="n">each_user_id</span><span class="p">,</span> <span class="s2">&quot;Incoming&quot;</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">requester_default_group_id</span> <span class="o">=</span> <span class="n">get_group_id_from_user_and_text</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">requester_id</span><span class="p">,</span> <span class="s2">&quot;Incoming&quot;</span><span class="p">,</span> <span class="s2">&quot;D_CLIENT_COMPLETED_GROUPS&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">requester_default_group_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">requester_default_group_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;D_CLIENT_COMPLETED_GROUPS&quot;</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.D_CLIENT_COMPLETED_GROUPS VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">requester_default_group_id</span><span class="p">,</span> <span class="n">requester_id</span><span class="p">,</span> <span class="s2">&quot;Incoming&quot;</span><span class="p">))</span>

    <span class="c1"># Change the state of the request</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET status_id = 2, client_completed_group_id = </span><span class="si">%s</span><span class="s2">, translator_completed_group_id = </span><span class="si">%s</span><span class="s2">, submitted_time = CURRENT_TIMESTAMP WHERE id = </span><span class="si">%s</span><span class="s2"> AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">requester_default_group_id</span><span class="p">,</span> <span class="n">translator_default_group_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">translator_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">update_user_record</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="n">requester_id</span><span class="p">,</span> <span class="n">translator_id</span><span class="o">=</span><span class="n">translator_id</span><span class="p">)</span>

    <span class="c1"># Delete users in queue</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM CICERON.D_QUEUE_LISTS WHERE request_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>

    <span class="c1"># Notification</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT client_user_id, ongoing_worker_id FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">send_noti_lite</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">11</span><span class="p">,</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">optional_info</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hero&quot;</span><span class="p">:</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]})</span>

    <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Request id </span><span class="si">%d</span><span class="s2"> is submitted.&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">,</span>
        <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span>
        <span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/complete/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<span class="nd">@translator_checker</span>
<div class="viewcode-block" id="translation_completed_items_detail"><a class="viewcode-back" href="../../docs/app.application.html#app.application.translation_completed_items_detail">[문서]</a><span class="k">def</span> <span class="nf">translation_completed_items_detail</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    특정 티켓 조회 + 토글뷰 지원</span>
<span class="sd">    warehousing.restoreArray() 사용</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT count(*) FROM CICERON.V_REQUESTS WHERE status_id = 2 AND request_id = </span><span class="si">%s</span><span class="s2"> AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You are not translator of the request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

    <span class="n">warehousing</span> <span class="o">=</span> <span class="n">Warehousing</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM CICERON.V_REQUESTS WHERE status_id = 2 AND request_id = </span><span class="si">%s</span><span class="s2"> AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> &quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM CICERON.V_REQUESTS WHERE status_id = 2 AND request_id = </span><span class="si">%s</span><span class="s2"> AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> AND </span>
<span class="s2">        ( (is_paid = true AND is_need_additional_points = false) OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) ) &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND submitted_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY submitted_time DESC LIMIT 20 &quot;</span>
    <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;complete_translator&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
        <span class="n">realData</span><span class="o">=</span><span class="n">warehousing</span><span class="o">.</span><span class="n">restoreArray</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
        <span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/complete&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<span class="nd">@translator_checker</span>
<div class="viewcode-block" id="translation_completed_items_all"><a class="viewcode-back" href="../../docs/app.application.html#app.application.translation_completed_items_all">[문서]</a><span class="k">def</span> <span class="nf">translation_completed_items_all</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    작업 완료한 티켓 전체조회</span>

<span class="sd">    status_id = 2 : 작업완료</span>
<span class="sd">    is_paid: 처음에 지불 완료</span>
<span class="sd">    is_need_additional_points: 만일, 해당 티켓에 네고가 있었고, 그것을 수락하여 추가 결제가 일어났을 때.</span>
<span class="sd">    is_additional_points_paid: 추가결제 완료?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">since</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

    <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM CICERON.V_REQUESTS WHERE status_id = 2 AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> &quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM CICERON.V_REQUESTS WHERE status_id = 2 AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> AND </span>
<span class="s2">       ( (is_paid = true AND is_need_additional_points = false) OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) ) &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND submitted_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY submitted_time DESC LIMIT 20&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;complete_translator&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/complete/&lt;str_request_id&gt;/title&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<span class="nd">@translator_checker</span>
<div class="viewcode-block" id="set_title_translator"><a class="viewcode-back" href="../../docs/app.application.html#app.application.set_title_translator">[문서]</a><span class="k">def</span> <span class="nf">set_title_translator</span><span class="p">(</span><span class="n">str_request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    작업 완료한 번역에 제목 달기</span>

<span class="sd">    작업 완료한 번역은 폴더식으로 관리한다.</span>
<span class="sd">    그리하여 원하는 때에 쉽게 꺼내 볼 수 있도록 지원해준다.</span>
<span class="sd">    여기서 하나 도움을 주는 것이 티켓에 제목달기이다.</span>

<span class="sd">    로직</span>
<span class="sd">        1. CICERON.D_TRANSLATOR_COMPLETED_REQUEST_TITLES 에 새 sequence를 딴다. 제목 관리하는 테이블이다. ciceron_lib.get_new_id()</span>
<span class="sd">        2. ciceron_lib.get_group_id_from_user_and_text()를 이용하여 Incoming 폴더의 ID를 찾는다.</span>
<span class="sd">        3. CICERON.F_REQUESTS 테이블에 업데이트한다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_request_id</span><span class="p">)</span>
        <span class="n">title_text</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;title_text&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">my_user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">default_group_id</span> <span class="o">=</span> <span class="n">get_group_id_from_user_and_text</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">my_user_id</span><span class="p">,</span> <span class="s2">&quot;Incoming&quot;</span><span class="p">,</span> <span class="s2">&quot;D_TRANSLATOR_COMPLETED_GROUPS&quot;</span><span class="p">)</span>

        <span class="c1"># No default group. Insert new default group entry for user</span>
        <span class="n">new_title_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;D_TRANSLATOR_COMPLETED_REQUEST_TITLES&quot;</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.D_TRANSLATOR_COMPLETED_REQUEST_TITLES VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">new_title_id</span><span class="p">,</span> <span class="n">title_text</span><span class="p">))</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET translator_title_id = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">new_title_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">))</span>

        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;The title is set as &#39;</span><span class="si">%s</span><span class="s2">&#39; to the request #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title_text</span><span class="p">,</span> <span class="n">request_id</span><span class="p">),</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">),</span>
            <span class="mi">200</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Inappropriate method of this request. POST only&quot;</span><span class="p">,</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">),</span>
            <span class="mi">405</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/complete/groups&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="translators_complete_groups"><a class="viewcode-back" href="../../docs/app.application.html#app.application.translators_complete_groups">[문서]</a><span class="k">def</span> <span class="nf">translators_complete_groups</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    해당 유저의 작업 완료 그룹 리스트를 불러온다.(GET), 새 그룹을 등록한다. (POST)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">since</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">since</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;since&#39;</span><span class="p">]</span>

        <span class="n">page</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">complete_groups</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;D_TRANSLATOR_COMPLETED_GROUPS&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="n">since</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="n">complete_groups</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="s2">&quot;D_TRANSLATOR_COMPLETED_GROUPS&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;&#39;Incoming&#39; is reserved name&quot;</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;New group </span><span class="si">%s</span><span class="s2"> has been created&quot;</span> <span class="o">%</span> <span class="n">group_name</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/complete/groups/&lt;str_group_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="modify_translators_complete_groups"><a class="viewcode-back" href="../../docs/app.application.html#app.application.modify_translators_complete_groups">[문서]</a><span class="k">def</span> <span class="nf">modify_translators_complete_groups</span><span class="p">(</span><span class="n">str_group_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    해당 그룹을 삭제한다. (DELETE) 해당 그룹 이름을 바꾼다. (PUT)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="n">complete_groups</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;D_TRANSLATOR_COMPLETED_GROUPS&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="n">url_group_id</span><span class="o">=</span><span class="n">str_group_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Group &#39;Incoming&#39; is default. You cannot delete it!&quot;</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Group </span><span class="si">%d</span><span class="s2"> is deleted. Requests are moved into default group&quot;</span> <span class="o">%</span> <span class="n">group_id</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;PUT&quot;</span><span class="p">:</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="n">complete_groups</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="s2">&quot;D_TRANSLATOR_COMPLETED_GROUPS&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;You cannot change the name of the group to &#39;Incoming&#39;. It is default group name&quot;</span> <span class="o">%</span> <span class="n">group_name</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Group name is changed to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">group_name</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/complete/groups/&lt;str_group_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="translation_completed_items_in_group"><a class="viewcode-back" href="../../docs/app.application.html#app.application.translation_completed_items_in_group">[문서]</a><span class="k">def</span> <span class="nf">translation_completed_items_in_group</span><span class="p">(</span><span class="n">str_group_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    해당 그룹에 속한 티켓을 보여준다. (GET) 해당 그룹으로 티켓을 이동한다. (POST)</span>

<span class="sd">    POST 로직</span>
<span class="sd">        1. CICERON.F_REQUESTS에서 translator_completed_group_id 값만 업데이트해주면 된다.</span>

<span class="sd">    GET 로직</span>
<span class="sd">        1. translator_completed_group_id로만 필터링하면 된다. 거기에 결제여부 체크 필터 넣어서 보여준다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">group_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_group_id</span><span class="p">)</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">])</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET translator_completed_group_id = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">))</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="n">get_text_from_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="s2">&quot;D_TRANSLATOR_COMPLETED_GROUPS&quot;</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Request #</span><span class="si">%d</span><span class="s2"> has been moved to the group &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">group_name</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_group_id</span><span class="p">)</span>
        <span class="n">my_user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

        <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM CICERON.V_REQUESTS WHERE ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> AND translator_completed_group_id = </span><span class="si">%s</span><span class="s2"> &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM CICERON.V_REQUESTS WHERE ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> AND translator_completed_group_id = </span><span class="si">%s</span><span class="s2"> AND </span>
<span class="s2">           ( (is_paid = true AND is_need_additional_points = false) OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) ) &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND submitted_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY submitted_time DESC LIMIT 20&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">my_user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;complete_translator&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/incomplete&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<span class="nd">@translator_checker</span>
<div class="viewcode-block" id="translation_incompleted_items_all"><a class="viewcode-back" href="../../docs/app.application.html#app.application.translation_incompleted_items_all">[문서]</a><span class="k">def</span> <span class="nf">translation_incompleted_items_all</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    미완료 리스트 불러오기</span>
<span class="sd">    내가 작업중이라서 완료가 되지 않았거나 (status_id = 1), 혹은 시간을 초과한 티켓 (status_id = -1)을 보여준다.</span>
<span class="sd">    결제여부 필터는 기본이다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">since</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

    <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM CICERON.V_REQUESTS WHERE ((status_id IN (-1,1) AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2">) OR (request_id IN (SELECT request_id FROM CICERON.D_QUEUE_LISTS WHERE user_id = </span><span class="si">%s</span><span class="s2">))) &quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">            WHERE (</span>
<span class="s2">                (status_id IN (-1,1) AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2">) </span>
<span class="s2">              OR</span>
<span class="s2">                (request_id IN (SELECT request_id FROM CICERON.D_QUEUE_LISTS WHERE user_id = </span><span class="si">%s</span><span class="s2">) )</span>
<span class="s2">            ) </span>
<span class="s2">              AND</span>
<span class="s2">             ( (is_paid = true AND is_need_additional_points = false) OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) ) &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND registered_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY request_id DESC LIMIT 20&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;pending_translator&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/incomplete/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<span class="nd">@translator_checker</span>
<div class="viewcode-block" id="translation_incompleted_items_each"><a class="viewcode-back" href="../../docs/app.application.html#app.application.translation_incompleted_items_each">[문서]</a><span class="k">def</span> <span class="nf">translation_incompleted_items_each</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    미완료 결제를 티켓 단위로 보는 API. 기본 로직은 위와 동일</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM CICERON.V_REQUESTS WHERE status_id IN (-1,1) AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> AND request_id = </span><span class="si">%s</span><span class="s2"> &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM CICERON.V_REQUESTS WHERE status_id IN (-1,1) AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> AND request_id = </span><span class="si">%s</span><span class="s2"> AND</span>
<span class="s2">           ( (is_paid = true AND is_need_additional_points = false) OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) )  &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND registered_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY registered_time DESC LIMIT 20&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;pending_translator&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/stoa&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="user_stoa"><a class="viewcode-back" href="../../docs/app.application.html#app.application.user_stoa">[문서]</a><span class="k">def</span> <span class="nf">user_stoa</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    의뢰인의 스토아.</span>
<span class="sd">    번역가 스토아와는 다르게, 일반 의뢰는 보여주지 않고, 대신 모든 사람의 단문번역 내역을 보여준다.</span>
<span class="sd">    일반의뢰는 나름 프라이버시로 취급한다.</span>
<span class="sd">    (단, 9월에 들고갈 번역 공동구매 시작하면 공동구매건은 스토아에 보이게 된다.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="c1"># Request method: GET</span>
        <span class="c1"># Parameters</span>
        <span class="c1">#     since(optional): Timestamp, take recent 20 post before the timestamp.</span>
        <span class="c1">#                  If this parameter is not provided, recent 20 posts from now are returned</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pager_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM CICERON.V_REQUESTS WHERE</span>
<span class="s2">                isSos = true AND status_id IN (0, 1, 2) AND due_time &gt; CURRENT_TIMESTAMP &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND registered_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY registered_time DESC LIMIT 20 &quot;</span>

        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">pager_date</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s1">&#39;stoa_client&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/pending&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="show_pending_list_client"><a class="viewcode-back" href="../../docs/app.application.html#app.application.show_pending_list_client">[문서]</a><span class="k">def</span> <span class="nf">show_pending_list_client</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    [현재 사용하지 않음]</span>

<span class="sd">    티켓을 스토아에 올려는 놓았는데 번역가가 아직 번역을 잡지 않은 경우. 해당 티켓 리스트 보기 (GET)</span>
<span class="sd">    번역가가 네고를 걸었을 때 수락하면서 차액 지불할 때 (POST)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM CICERON.V_REQUESTS WHERE client_user_id = </span><span class="si">%s</span><span class="s2"> AND status_id = 0 &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM CICERON.V_REQUESTS WHERE client_user_id = </span><span class="si">%s</span><span class="s2"> AND status_id = 0 AND </span>
<span class="s2">            ( (is_paid = true AND is_need_additional_points = false) OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) ) &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND registered_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY registered_time DESC LIMIT 20&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;pending_client&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">pay_by</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;pay_by&#39;</span><span class="p">]</span>
        <span class="n">pay_via</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;pay_via&#39;</span><span class="p">]</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">])</span>
        <span class="n">translator_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;translator_userEmail&#39;</span><span class="p">])</span>
        <span class="n">host_ip</span> <span class="o">=</span> <span class="n">HOST</span>
        <span class="n">use_point</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_point&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">promo_type</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;promo_type&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span>
        <span class="n">promo_code</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;promo_code&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span>

        <span class="n">payload_iamport</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">pay_via</span> <span class="o">==</span> <span class="s1">&#39;iamport&#39;</span><span class="p">:</span>
            <span class="c1"># &#39;merchant_uid&#39; =&gt; Create internally</span>
            <span class="n">payload_iamport</span><span class="p">[</span><span class="s1">&#39;card_number&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;card_number&#39;</span><span class="p">]</span>
            <span class="n">payload_iamport</span><span class="p">[</span><span class="s1">&#39;expiry&#39;</span><span class="p">]</span> <span class="o">=</span>       <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;expiry&#39;</span><span class="p">]</span>
            <span class="n">payload_iamport</span><span class="p">[</span><span class="s1">&#39;birth&#39;</span><span class="p">]</span> <span class="o">=</span>        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;birth&#39;</span><span class="p">]</span>
            <span class="n">payload_iamport</span><span class="p">[</span><span class="s1">&#39;pwd_2digit&#39;</span><span class="p">]</span> <span class="o">=</span>   <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;pwd_2digit&#39;</span><span class="p">]</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

        <span class="n">status_code</span> <span class="o">=</span> <span class="n">approve_negoPoint</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">translator_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">406</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Not valid hero email or ticket entry&#39;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">409</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Suggested point is smaller than original point&#39;</span><span class="p">),</span> <span class="mi">409</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">402</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Somebody already working on the ticket&quot;</span>
                <span class="p">),</span> <span class="mi">402</span><span class="p">)</span>

        <span class="c1"># status_code == 200: pass</span>

        <span class="n">diff_amount</span> <span class="o">=</span> <span class="n">get_total_amount</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">translator_id</span><span class="p">,</span> <span class="n">is_additional</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">diff_amount</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">diff_amount</span> <span class="o">==</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Something wrong in DB record&quot;</span>
                <span class="p">),</span> <span class="mi">500</span><span class="p">)</span>

        <span class="n">status_string</span><span class="p">,</span> <span class="n">provided_link</span><span class="p">,</span> <span class="n">current_point</span> <span class="o">=</span> <span class="n">payment_start</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">pay_by</span><span class="p">,</span> <span class="n">pay_via</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">diff_amount</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">host_ip</span><span class="p">,</span>
                <span class="n">use_point</span><span class="o">=</span><span class="n">use_point</span><span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="n">promo_type</span><span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="n">promo_code</span><span class="p">,</span> <span class="n">is_additional</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload_iamport</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status_string</span> <span class="o">==</span> <span class="s1">&#39;point_exceeded_than_you_have&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You requested to use your points more than what you have. Price: </span><span class="si">%.2f</span><span class="s2">, Your purse: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">use_point</span><span class="p">,</span> <span class="n">current_point</span><span class="p">)),</span> <span class="mi">401</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">status_string</span> <span class="o">==</span> <span class="s1">&#39;paypal_error&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Something wrong in paypal&quot;</span><span class="p">),</span> <span class="mi">410</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">status_string</span> <span class="o">==</span> <span class="s1">&#39;paypal_success&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Redirect link is provided!&quot;</span><span class="p">,</span>
                <span class="n">link</span><span class="o">=</span><span class="n">provided_link</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">status_string</span> <span class="o">==</span> <span class="s1">&#39;alipay_success&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Link to Alipay is provided.&quot;</span><span class="p">,</span>
                <span class="n">link</span><span class="o">=</span><span class="n">provided_link</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">status_string</span> <span class="o">==</span> <span class="s1">&#39;alipay_failure&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Error on alipay&quot;</span><span class="p">),</span> <span class="mi">411</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">status_string</span> <span class="o">==</span> <span class="s1">&#39;point_success&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Success&#39;</span><span class="p">,</span>
                <span class="n">link</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/stoa&#39;</span> <span class="o">%</span> <span class="n">HOST</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">status_string</span> <span class="o">==</span> <span class="s1">&#39;iamport_success&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Success&#39;</span><span class="p">,</span>
                <span class="n">link</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/stoa&#39;</span> <span class="o">%</span> <span class="n">HOST</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/pending/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="show_pending_item_client"><a class="viewcode-back" href="../../docs/app.application.html#app.application.show_pending_item_client">[문서]</a><span class="k">def</span> <span class="nf">show_pending_item_client</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    의뢰한 티켓 개별 정보 보기</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM CICERON.V_REQUESTS WHERE request_id = </span><span class="si">%s</span><span class="s2"> AND client_user_id = </span><span class="si">%s</span><span class="s2"> AND status_id = 0 &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM CICERON.V_REQUESTS WHERE request_id = </span><span class="si">%s</span><span class="s2"> AND client_user_id = </span><span class="si">%s</span><span class="s2"> AND status_id = 0 AND</span>
<span class="s2">           ( (is_paid = true AND is_need_additional_points = false) OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) )  &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND registered_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;pending_client&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/pending/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="delete_item_client"><a class="viewcode-back" href="../../docs/app.application.html#app.application.delete_item_client">[문서]</a><span class="k">def</span> <span class="nf">delete_item_client</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    의뢰한 티켓 삭제</span>

<span class="sd">    의미는 삭제지만, 실제 구동은 status_id = -2이다. status_id = -2의 의미는 삭제라는 뜻이다.</span>
<span class="sd">    로직</span>
<span class="sd">        1. 티켓 가격을 불러운다.</span>
<span class="sd">        2. 사용한 티켓값은 적립금으로 돌려준다.</span>
<span class="sd">        3. 티켓 status_id = -2 로 변경한다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT points FROM CICERON.V_REQUESTS WHERE request_id = </span><span class="si">%s</span><span class="s2"> AND client_user_id = </span><span class="si">%s</span><span class="s2"> AND status_id = 0 &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT points FROM CICERON.V_REQUESTS WHERE request_id = </span><span class="si">%s</span><span class="s2"> AND client_user_id = </span><span class="si">%s</span><span class="s2"> AND status_id = 0 AND</span>
<span class="s2">           ( (is_paid = true AND is_need_additional_points = false) OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) )  &quot;&quot;&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.REVENUE SET amount = amount + </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET status_id = -2 WHERE id = </span><span class="si">%s</span><span class="s2"> AND client_user_id = </span><span class="si">%s</span><span class="s2"> AND status_id = 0&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Request #</span><span class="si">%d</span><span class="s2"> is deleted. USD </span><span class="si">%.2f</span><span class="s2"> is returned as requester&#39;s points&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">points</span><span class="p">)),</span> <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/pending/group_request&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="get_groupRequest_list"><a class="viewcode-back" href="../../docs/app.application.html#app.application.get_groupRequest_list">[문서]</a><span class="k">def</span> <span class="nf">get_groupRequest_list</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    번역 공동구매원 모집 리스트</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">groupRequestObj</span> <span class="o">=</span> <span class="n">GroupRequest</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>

        <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">groupRequestObj</span><span class="o">.</span><span class="n">getGroupRequestList</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ciceron_lib</span><span class="o">.</span><span class="n">json_form_V_REQUESTS</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/pending/group_request/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="get_oneGroupRequest"><a class="viewcode-back" href="../../docs/app.application.html#app.application.get_oneGroupRequest">[문서]</a><span class="k">def</span> <span class="nf">get_oneGroupRequest</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    번역 공동구매원 모집 리스트 (개별티켓)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">groupRequestObj</span> <span class="o">=</span> <span class="n">GroupRequest</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">groupRequestObj</span><span class="o">.</span><span class="n">getOneGroupRequest</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json_form_V_REQUESTS</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/pending/group_request/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="addUser_groupRequest"><a class="viewcode-back" href="../../docs/app.application.html#app.application.addUser_groupRequest">[문서]</a><span class="k">def</span> <span class="nf">addUser_groupRequest</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    번역 공동구매 결제</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">groupRequestObj</span> <span class="o">=</span> <span class="n">GroupRequest</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">paymentObj</span> <span class="o">=</span> <span class="n">Payment</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>

        <span class="c1"># Get and set parameters</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">client_email</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;payment_clientEmail&#39;</span><span class="p">]</span>
        <span class="n">payment_platform</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;payment_platform&#39;</span><span class="p">]</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;payment_amount&#39;</span><span class="p">])</span>
        <span class="n">promo_type</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;promo_type&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span>
        <span class="n">promo_code</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;promo_code&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span>
        <span class="n">point_for_use</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;point_for_use&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">client_userId</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">client_email</span><span class="p">)</span>
        <span class="n">groupRequestObj</span><span class="o">.</span><span class="n">addUserToGroup</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">client_userId</span><span class="p">)</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">payment_platform</span> <span class="o">==</span> <span class="s1">&#39;iamport&#39;</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;card_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;card_number&#39;</span><span class="p">]</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;expiry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;expiry&#39;</span><span class="p">]</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;birth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;birth&#39;</span><span class="p">]</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;pwd_2digit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;pwd_2digit&#39;</span><span class="p">]</span>

        <span class="n">is_prod</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PURPOSE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;PROD&#39;</span><span class="p">:</span>
            <span class="n">is_prod</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Point test</span>
        <span class="n">cur_amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="k">if</span> <span class="n">point_for_use</span> <span class="o">&gt;</span> <span class="mf">0.00001</span><span class="p">:</span>
            <span class="n">is_point_usable</span><span class="p">,</span> <span class="n">cur_amount</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">checkPoint</span><span class="p">(</span><span class="n">client_userId</span><span class="p">,</span> <span class="n">point_for_use</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_point</span> <span class="o">-</span> <span class="n">use_point</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.00001</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Fail&quot;</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span>

        <span class="c1"># Promo code test</span>
        <span class="k">if</span> <span class="n">promo_type</span> <span class="o">!=</span> <span class="s1">&#39;null&#39;</span><span class="p">:</span>
            <span class="n">isCommonCode</span><span class="p">,</span> <span class="n">commonPoint</span><span class="p">,</span> <span class="n">commonMessage</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">commonPromotionCodeChecker</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">)</span>
            <span class="n">isIndivCode</span><span class="p">,</span> <span class="n">indivPoint</span><span class="p">,</span> <span class="n">indivMessage</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">individualPromotionCodeChecker</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isCommonCode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cur_amount</span> <span class="o">=</span> <span class="n">cur_amount</span> <span class="o">-</span> <span class="n">commonPoint</span>
            <span class="k">elif</span> <span class="n">isIndivCode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cur_amount</span> <span class="o">=</span> <span class="n">cur_amount</span> <span class="o">-</span> <span class="n">indivPoint</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Fail&quot;</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span>

        <span class="c1"># Send payment request</span>
        <span class="n">is_payment_ok</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">payment_platform</span> <span class="o">==</span> <span class="s1">&#39;alipay&#39;</span> <span class="ow">and</span> <span class="n">cur_amount</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="n">is_payment_ok</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">alipayPayment</span><span class="p">(</span><span class="n">is_prod</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span> <span class="n">cur_amount</span>
                    <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="n">point_for_use</span>
                    <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="n">promo_type</span>
                    <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="n">promo_code</span>
                    <span class="p">,</span> <span class="n">is_groupRequest</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

        <span class="k">elif</span> <span class="n">payment_platform</span> <span class="o">==</span> <span class="s1">&#39;paypal&#39;</span> <span class="ow">and</span> <span class="n">cur_amount</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="n">is_payment_ok</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">paypalPayment</span><span class="p">(</span><span class="n">is_prod</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span> <span class="n">cur_amount</span>
                    <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="n">point_for_use</span>
                    <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="n">promo_type</span>
                    <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="n">promo_code</span>
                    <span class="p">,</span> <span class="n">is_groupRequest</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

        <span class="k">elif</span> <span class="n">payment_platform</span> <span class="o">==</span> <span class="s1">&#39;iamport&#39;</span> <span class="ow">and</span> <span class="n">cur_amount</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="n">is_payment_ok</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">iamportPayment</span><span class="p">(</span><span class="n">is_prod</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span> <span class="n">cur_amount</span>
                    <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="n">point_for_use</span>
                    <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="n">promo_type</span>
                    <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="n">promo_code</span>
                    <span class="p">,</span> <span class="n">is_groupRequest</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">,</span> <span class="o">**</span><span class="n">payload</span>
                    <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_payment_ok</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">pointPayment</span><span class="p">(</span><span class="n">is_prod</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span> <span class="n">cur_amount</span>
                    <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="n">point_for_use</span>
                    <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="n">promo_type</span>
                    <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="n">promo_code</span>
                    <span class="p">,</span> <span class="n">is_groupRequest</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

        <span class="c1"># Return</span>
        <span class="k">if</span> <span class="n">is_payment_ok</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">link</span><span class="o">=</span><span class="n">link</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Fail&quot;</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/pending/group_request/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="deleteUser_groupRequest"><a class="viewcode-back" href="../../docs/app.application.html#app.application.deleteUser_groupRequest">[문서]</a><span class="k">def</span> <span class="nf">deleteUser_groupRequest</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">groupRequestObj</span> <span class="o">=</span> <span class="n">GroupRequest</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="n">paymentObj</span> <span class="o">=</span> <span class="n">Payment</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>

    <span class="n">is_delete_succeeded</span> <span class="o">=</span> <span class="n">groupRequestObj</span><span class="o">.</span><span class="n">deleteUserFromGroup</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="n">is_refund_succeeded</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">refundByPoint</span><span class="p">(</span><span class="n">order_no</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_delete_succeeded</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">is_refund_succeeded</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Complete&quot;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Failed&quot;</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/ongoing&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="show_ongoing_list_client"><a class="viewcode-back" href="../../docs/app.application.html#app.application.show_ongoing_list_client">[문서]</a><span class="k">def</span> <span class="nf">show_ongoing_list_client</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    자신이 의뢰한 티켓 중 번역 진행중인 것 표시 (status_id = 1)</span>
<span class="sd">    + 결제완료 여부 필터 첨가</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">                WHERE </span>
<span class="s2">                      (client_user_id = </span><span class="si">%s</span><span class="s2"> OR request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2">) )</span>
<span class="s2">                  AND status_id = 1 &quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">                WHERE</span>
<span class="s2">                      (client_user_id = </span><span class="si">%s</span><span class="s2"> OR request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND is_paid = true) )</span>
<span class="s2">                    AND status_id = 1</span>
<span class="s2">                    AND ( (is_paid = true AND is_need_additional_points = false) </span>
<span class="s2">                          OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) ) &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND start_translating_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY start_translating_time DESC LIMIT 20&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;ongoing_translator&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/ongoing/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="show_ongoing_item_client"><a class="viewcode-back" href="../../docs/app.application.html#app.application.show_ongoing_item_client">[문서]</a><span class="k">def</span> <span class="nf">show_ongoing_item_client</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    자신이 의뢰한 티켓 중 개별 티켓 확인</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">                WHERE request_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">                  AND (client_user_id = </span><span class="si">%s</span><span class="s2"> OR request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> ) )</span>
<span class="s2">                  AND status_id = 1</span>
<span class="s2">                &quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">                WHERE request_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                  AND (client_user_id = </span><span class="si">%s</span><span class="s2"> OR request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND is_paid = true) )</span>
<span class="s2">                  AND status_id = 1</span>
<span class="s2">                  AND ( (is_paid = true AND is_need_additional_points = false)</span>
<span class="s2">                       OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) )  &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND start_translating_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY start_translating_time DESC LIMIT 20&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;ongoing_translator&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/complete&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="client_completed_items"><a class="viewcode-back" href="../../docs/app.application.html#app.application.client_completed_items">[문서]</a><span class="k">def</span> <span class="nf">client_completed_items</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    완료한 번역 보여주기 (목록)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">            WHERE status_id = 2 </span>
<span class="s2">              AND (</span>
<span class="s2">                      client_user_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">                   OR request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> ) </span>
<span class="s2">                   OR request_id IN (SELECT request_id FROM CICERON.F_READ_PUBLIC_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )</span>
<span class="s2">                  )</span>
<span class="s2">              &quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">            WHERE status_id = 2</span>
<span class="s2">              AND (</span>
<span class="s2">                      client_user_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">                   OR request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND is_paid = true) </span>
<span class="s2">                   OR request_id IN (SELECT request_id FROM CICERON.F_READ_PUBLIC_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND is_paid = true) </span>
<span class="s2">                  )</span>
<span class="s2">              AND ( (is_paid = true AND is_need_additional_points = false) </span>
<span class="s2">                   OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) ) &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND submitted_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY submitted_time DESC LIMIT 20&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;complete_client&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/complete/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="client_completed_items_detail"><a class="viewcode-back" href="../../docs/app.application.html#app.application.client_completed_items_detail">[문서]</a><span class="k">def</span> <span class="nf">client_completed_items_detail</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    완료한 번역 보여주기 (개별)</span>
<span class="sd">    토글뷰 지원 ( warehousing.restoreArray() )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warehousing</span> <span class="o">=</span> <span class="n">Warehousing</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT count(*) FROM CICERON.V_REQUESTS</span>
<span class="s2">        WHERE status_id = 2</span>
<span class="s2">          AND request_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">          AND (</span>
<span class="s2">                  client_user_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">               OR request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> ) </span>
<span class="s2">               OR request_id IN (SELECT request_id FROM CICERON.F_READ_PUBLIC_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )</span>
<span class="s2">              )</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;You are not client of the request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>


    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">            WHERE status_id = 2</span>
<span class="s2">              AND request_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">              AND (</span>
<span class="s2">                      client_user_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">                   OR request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND is_paid = true) </span>
<span class="s2">                   OR request_id IN (SELECT request_id FROM CICERON.F_READ_PUBLIC_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND is_paid = true) </span>
<span class="s2">                  )</span>
<span class="s2">              &quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">            WHERE status_id = 2</span>
<span class="s2">              AND request_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">              AND (</span>
<span class="s2">                      client_user_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">                   OR request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND is_paid = true) </span>
<span class="s2">                   OR request_id IN (SELECT request_id FROM CICERON.F_READ_PUBLIC_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND is_paid = true) </span>
<span class="s2">                  )</span>
<span class="s2">              AND ( (is_paid = true AND is_need_additional_points = false) </span>
<span class="s2">                    OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) )  &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND submitted_time &lt; datetime(</span><span class="si">%s</span><span class="s2">, &#39;unixepoch&#39;) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY submitted_time DESC LIMIT 20&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;complete_client&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
        <span class="n">realData</span><span class="o">=</span><span class="n">warehousing</span><span class="o">.</span><span class="n">restoreArray</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
        <span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/complete/&lt;int:request_id&gt;/rate&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="client_rate_request"><a class="viewcode-back" href="../../docs/app.application.html#app.application.client_rate_request">[문서]</a><span class="k">def</span> <span class="nf">client_rate_request</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    완료한 번역 유저평가</span>
<span class="sd">    CICERON.F_REQUESTS.feedback_score에 0~2점 입력</span>

<span class="sd">    + Rating 전에는 번역가에게 대금이 들어가지 않도록 설계 (추후, 1주일동안 평가 없으면 돈 들어가도록 수정)</span>
<span class="sd">    + 해당 거래에 대금 지급 완료되었는지도 CICERON.PAYMENT_INFO에 마킹</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">feedback_score</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;request_feedbackScore&#39;</span><span class="p">])</span>

    <span class="c1"># Pay back part</span>
    <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
        <span class="n">query_getTranslator</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT ongoing_worker_id, points, feedback_score, is_need_additional_points, additional_points</span>
<span class="s2">            FROM CICERON.F_REQUESTS</span>
<span class="s2">            WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query_getTranslator</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT ongoing_worker_id, points, feedback_score, is_need_additional_points, additional_points</span>
<span class="s2">            FROM CICERON.F_REQUESTS</span>
<span class="s2">            WHERE id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">              AND ( (is_paid = true AND is_need_additional_points = false) </span>
<span class="s2">                  OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) ) &quot;&quot;&quot;</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_getTranslator</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="n">formal_feedback_score</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># If the request is rated, another rate should be blocked</span>
    <span class="k">if</span> <span class="n">formal_feedback_score</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;The request is already rated!&quot;</span><span class="p">,</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">),</span>
            <span class="mi">403</span><span class="p">)</span>

    <span class="n">translator_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pay_amount</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">pay_amount</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pay_amount</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="c1"># Input feedback score</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET feedback_score = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2"> AND client_user_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">feedback_score</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>

    <span class="n">query_getCounts</span> <span class="o">=</span> <span class="s2">&quot;SELECT return_rate FROM CICERON.D_USERS WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_getRate</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="n">return_rate</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Record payment record</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.PAYMENT_INFO SET translator_id = </span><span class="si">%s</span><span class="s2">, is_payed_back = </span><span class="si">%s</span><span class="s2">, back_amount = </span><span class="si">%s</span><span class="s2"> WHERE request_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">translator_id</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">return_rate</span><span class="o">*</span><span class="n">pay_amount</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span> <span class="p">)</span>

    <span class="c1"># Update the translator&#39;s purse</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.REVENUE SET amount = amount + </span><span class="si">%s</span><span class="s2"> * </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">return_rate</span><span class="p">,</span> <span class="n">pay_amount</span><span class="p">,</span> <span class="n">translator_id</span><span class="p">)</span> <span class="p">)</span>

    <span class="c1"># Notification</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT ongoing_worker_id, client_user_id FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2"> AND client_user_id = </span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="n">send_noti_lite</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">request_id</span><span class="p">)</span>

    <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;The requester rated to request #</span><span class="si">%d</span><span class="s2"> as </span><span class="si">%d</span><span class="s2"> points (in 0~2). And translator has been earned USD </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">feedback_score</span><span class="p">,</span> <span class="n">pay_amount</span><span class="o">*</span><span class="n">return_rate</span><span class="p">),</span>
        <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">),</span>
        <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/complete/&lt;int:request_id&gt;/title&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="set_title_client"><a class="viewcode-back" href="../../docs/app.application.html#app.application.set_title_client">[문서]</a><span class="k">def</span> <span class="nf">set_title_client</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    완료한 번역에 제목달기</span>
<span class="sd">    위부터 읽어왔으면 우리는 완료한 번역을 폴더로 관리하는 것은 알 것이리라 믿음</span>
<span class="sd">    폴더별로 관리하는 티켓에 제목을 달아주는 일임</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">groupRequestObj</span> <span class="o">=</span> <span class="n">GroupRequest</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">requestResellObj</span> <span class="o">=</span> <span class="n">RequestResell</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>

        <span class="n">title_text</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;title_text&#39;</span><span class="p">]</span>

        <span class="n">my_user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">default_group_id</span> <span class="o">=</span> <span class="n">get_group_id_from_user_and_text</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">my_user_id</span><span class="p">,</span> <span class="s2">&quot;Incoming&quot;</span><span class="p">,</span> <span class="s2">&quot;D_CLIENT_COMPLETED_GROUPS&quot;</span><span class="p">)</span>

        <span class="c1"># No default group. Insert new default group entry for user</span>
        <span class="n">new_title_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;D_CLIENT_COMPLETED_REQUEST_TITLES&quot;</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.D_CLIENT_COMPLETED_REQUEST_TITLES VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">new_title_id</span><span class="p">,</span> <span class="n">title_text</span><span class="p">)</span> <span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET client_title_id = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2"> AND client_user_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">new_title_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">my_user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">groupRequestObj</span><span class="o">.</span><span class="n">insertTitle</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">my_user_id</span><span class="p">,</span> <span class="n">new_title_id</span><span class="p">)</span>
        <span class="n">requestResellObj</span><span class="o">.</span><span class="n">insertTitle</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">my_user_id</span><span class="p">,</span> <span class="n">new_title_id</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;The title is set as &#39;</span><span class="si">%s</span><span class="s2">&#39; to the request #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title_text</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)),</span>
            <span class="mi">200</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Inappropriate method of this request. POST only&quot;</span><span class="p">),</span>
            <span class="mi">405</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/complete/groups&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="client_complete_groups"><a class="viewcode-back" href="../../docs/app.application.html#app.application.client_complete_groups">[문서]</a><span class="k">def</span> <span class="nf">client_complete_groups</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    의뢰인기준 완료한 티켓 그룹관리.</span>
<span class="sd">    그룹목목 보기 (GET), 그룹 생성 (POST)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">since</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">since</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;since&#39;</span><span class="p">]</span>

        <span class="n">page</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">complete_groups</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;D_CLIENT_COMPLETED_GROUPS&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">since</span><span class="o">=</span><span class="n">since</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">group_name</span> <span class="o">=</span> <span class="n">complete_groups</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="s2">&quot;D_CLIENT_COMPLETED_GROUPS&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;New group </span><span class="si">%s</span><span class="s2"> has been created&quot;</span> <span class="o">%</span> <span class="n">group_name</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;&#39;Incoming&#39; is default group name&quot;</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/complete/groups/&lt;str_group_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="modify_client_completed_groups"><a class="viewcode-back" href="../../docs/app.application.html#app.application.modify_client_completed_groups">[문서]</a><span class="k">def</span> <span class="nf">modify_client_completed_groups</span><span class="p">(</span><span class="n">str_group_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    그룹명수정 (PUT), 그룹 지우기 (DELETE)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;PUT&quot;</span><span class="p">:</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="n">complete_groups</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="s2">&quot;D_CLIENT_COMPLETED_GROUPS&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="n">url_group_id</span><span class="o">=</span><span class="n">str_group_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Group name is changed to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">group_name</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;&#39;Incoming&#39; is default group name&quot;</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="n">complete_groups</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;D_CLIENT_COMPLETED_GROUPS&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="n">url_group_id</span><span class="o">=</span><span class="n">str_group_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;You cannot delete &#39;Incoming&#39; group&quot;</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">group_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Already deleted group&quot;</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Group </span><span class="si">%d</span><span class="s2"> is deleted.&quot;</span> <span class="o">%</span> <span class="n">group_id</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/complete/groups/&lt;int:group_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="client_completed_items_in_group"><a class="viewcode-back" href="../../docs/app.application.html#app.application.client_completed_items_in_group">[문서]</a><span class="k">def</span> <span class="nf">client_completed_items_in_group</span><span class="p">(</span><span class="n">group_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    해당 그룹에 속한 티켓 보기 (GET), 해당 그룹으로 티켓 옮기기 (POST)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">])</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">groupRequestObj</span> <span class="o">=</span> <span class="n">GroupRequest</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">requestResellObj</span> <span class="o">=</span> <span class="n">RequestResell</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            UPDATE CICERON.F_REQUESTS </span>
<span class="s2">            SET client_completed_group_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">            WHERE id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">              AND client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">groupRequestObj</span><span class="o">.</span><span class="n">assignToGroup</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">)</span>
        <span class="n">requestResellObj</span><span class="o">.</span><span class="n">assignToGroup</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">)</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="n">get_text_from_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="s2">&quot;D_CLIENT_COMPLETED_GROUPS&quot;</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Request #</span><span class="si">%d</span><span class="s2"> has moved to the group &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">group_name</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">my_user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">                WHERE (client_user_id = </span><span class="si">%s</span><span class="s2"> AND client_completed_group_id = </span><span class="si">%s</span><span class="s2">) </span>
<span class="s2">                    OR request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND complete_client_group_id = </span><span class="si">%s</span><span class="s2"> )</span>
<span class="s2">                   OR request_id IN (SELECT request_id FROM CICERON.F_READ_PUBLIC_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND complete_client_group_id = </span><span class="si">%s</span><span class="s2"> ) </span>
<span class="s2">                    &quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">                WHERE (</span>
<span class="s2">                           (client_user_id = </span><span class="si">%s</span><span class="s2"> AND client_completed_group_id = </span><span class="si">%s</span><span class="s2"> ) </span>
<span class="s2">                        OR request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND complete_client_group_id = </span><span class="si">%s</span><span class="s2"> AND is_paid = true)</span>
<span class="s2">                        OR request_id IN (SELECT request_id FROM CICERON.F_READ_PUBLIC_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND complete_client_group_id = </span><span class="si">%s</span><span class="s2"> AND is_paid = true)</span>
<span class="s2">                      )</span>
<span class="s2">                  AND ( (is_paid = true AND is_need_additional_points = false) </span>
<span class="s2">                      OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) )</span>
<span class="s2">                &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND submitted_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;ORDER BY submitted_time DESC&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">my_user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">my_user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">my_user_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;complete_client&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/incomplete&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="client_incompleted_items"><a class="viewcode-back" href="../../docs/app.application.html#app.application.client_incompleted_items">[문서]</a><span class="k">def</span> <span class="nf">client_incompleted_items</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    자신이 의뢰한 티켓 중 미완료 리스트 ( status_id in (-1, 0, 1) ) &lt;- 마감시간초과, 의뢰했으나 번역가 미 매칭, 작업진행중</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">            WHERE status_id IN (-1,0,1) </span>
<span class="s2">              AND (client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                  OR (request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )))</span>
<span class="s2">            &quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">            WHERE status_id IN (-1,0,1)</span>
<span class="s2">              AND (client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                  OR (request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )))</span>
<span class="s2">              AND ( (is_paid = true AND is_need_additional_points = false) </span>
<span class="s2">                  OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) )</span>
<span class="s2">              &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND registered_time &lt; to-timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY registered_time DESC LIMIT 20&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;pending_client&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/incomplete/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="client_incompleted_item_control"><a class="viewcode-back" href="../../docs/app.application.html#app.application.client_incompleted_item_control">[문서]</a><span class="k">def</span> <span class="nf">client_incompleted_item_control</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    자신이 의뢰한 티켓 처리</span>
<span class="sd">    조회 (GET),</span>
<span class="sd">    번역하다가 마감시간 초과시 번역가 변경 없이 마감시간 및 금액 수정(PUT),</span>
<span class="sd">    번역하다가 마감시간 초과시 번역가 변경하고 스토아로 보낸 후 마감시간 및 금액 수정 (POST),</span>
<span class="sd">    마감시간 경과한 티켓 삭제 (DELETE)</span>

<span class="sd">    결제가 필요하면 결제로 이어지는 API 주소 제공, is_paid = false로 마킹</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">                WHERE status_id IN (-1,0,1) </span>
<span class="s2">                  AND request_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                  AND (client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                      OR (request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )))</span>
<span class="s2">                &quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">                WHERE status_id IN (-1,0,1)</span>
<span class="s2">                  AND request_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                  AND (client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                      OR (request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )))</span>
<span class="s2">                  AND ( (is_paid = true AND is_need_additional_points = false) </span>
<span class="s2">                      OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) )</span>
<span class="s2">                  &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND registered_time &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY registered_time DESC LIMIT 20&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;pending_client&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;PUT&quot;</span><span class="p">:</span>
        <span class="c1"># Only update due_time and price</span>

        <span class="c1"># It can be used in:</span>
        <span class="c1">#    1) Non-selected request</span>
        <span class="c1">#    2) Give more chance to the trusted translator</span>

        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># Addional time: unit is second, counted from NOW</span>
        <span class="n">additional_time_in_sec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;user_additionalTime&#39;</span><span class="p">])</span>
        <span class="n">additional_price</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_additionalPrice&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">additional_price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;user_additionalPrice&#39;</span><span class="p">])</span>

        <span class="c1"># Notification</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT ongoing_worker_id, client_user_id FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">send_noti_lite</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">request_id</span><span class="p">,</span>
                <span class="n">optional_info</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hero&quot;</span><span class="p">:</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]})</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="c1"># Change due date w/o addtional money</span>
        <span class="k">if</span> <span class="n">additional_price</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    UPDATE CICERON.F_REQUESTS</span>
<span class="s2">                    SET   due_time = CURRENT_TIMESTAMP + interval &#39;+</span><span class="si">%s</span><span class="s2"> seconds&#39;</span>
<span class="s2">                        , status_id = 0</span>
<span class="s2">                        , registered_time = CURRENT_TIMESTAMP</span>
<span class="s2">                    WHERE id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                      AND status_id = -1</span>
<span class="s2">                      AND (client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                          OR (request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )))</span>
<span class="s2">                      AND ongoing_worker_id is null</span>
<span class="s2">                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">additional_time_in_sec</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    UPDATE CICERON.F_REQUESTS</span>
<span class="s2">                    SET   due_time = CURRENT_TIMESTAMP + interval &#39;+</span><span class="si">%s</span><span class="s2"> seconds&#39;</span>
<span class="s2">                        , status_id = 1</span>
<span class="s2">                        , registered_time = CURRENT_TIMESTAMP</span>
<span class="s2">                    WHERE id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                      AND status_id = -1</span>
<span class="s2">                      AND (client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                          OR (request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )))</span>
<span class="s2">                      AND ongoing_worker_id is not null</span>
<span class="s2">                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">additional_time_in_sec</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT registered_time, due_time, points FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="n">request_registeredTime</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">request_dueTime</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">request_points</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Request #</span><span class="si">%d</span><span class="s2"> is renewed&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">,</span>
                <span class="n">api</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
                <span class="n">request_registeredTime</span><span class="o">=</span><span class="n">request_registeredTime</span><span class="p">,</span>
                <span class="n">request_dueTime</span><span class="o">=</span><span class="n">request_dueTime</span><span class="p">,</span>
                <span class="n">request_points</span><span class="o">=</span><span class="n">request_points</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

        <span class="c1"># Change due date w/additional money</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    UPDATE CICERON.F_REQUESTS</span>
<span class="s2">                    SET   due_time = CURRENT_TIMESTAMP + interval &#39;+</span><span class="si">%s</span><span class="s2"> seconds&#39;</span>
<span class="s2">                        , status_id = 0</span>
<span class="s2">                        , registered_time = CURRENT_TIMESTAMP</span>
<span class="s2">                        , is_paid = false</span>
<span class="s2">                        , points = points + </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                    WHERE id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                      AND status_id = -1</span>
<span class="s2">                      AND (client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                          OR (request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )))</span>
<span class="s2">                      AND ongoing_worker_id is null</span>
<span class="s2">                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">additional_time_in_sec</span><span class="p">,</span> <span class="n">additional_price</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    UPDATE CICERON.F_REQUESTS</span>
<span class="s2">                    SET   due_time = CURRENT_TIMESTAMP + interval &#39;+</span><span class="si">%s</span><span class="s2"> seconds&#39;</span>
<span class="s2">                        , status_id = 1</span>
<span class="s2">                        , registered_time = CURRENT_TIMESTAMP</span>
<span class="s2">                        , is_paid = false</span>
<span class="s2">                        , points = points + </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                    WHERE id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                      AND status_id = -1</span>
<span class="s2">                      AND (client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                          OR (request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )))</span>
<span class="s2">                      AND ongoing_worker_id is not null</span>
<span class="s2">                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">additional_time_in_sec</span><span class="p">,</span> <span class="n">additional_price</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT registered_time, due_time, points FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="n">request_registeredTime</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">request_dueTime</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">request_points</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Request #</span><span class="si">%d</span><span class="s2"> is renewed. Please execute the API provided with POST method&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">,</span>
                <span class="n">api</span><span class="o">=</span><span class="s2">&quot;/api/user/requests/</span><span class="si">%d</span><span class="s2">/payment/start&quot;</span><span class="o">%</span><span class="n">request_id</span><span class="p">,</span>
                <span class="n">additional_price</span><span class="o">=</span><span class="n">additional_price</span><span class="p">,</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
                <span class="n">request_registeredTime</span><span class="o">=</span><span class="n">request_registeredTime</span><span class="p">,</span>
                <span class="n">request_dueTime</span><span class="o">=</span><span class="n">request_dueTime</span><span class="p">,</span>
                <span class="n">request_points</span><span class="o">=</span><span class="n">request_points</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="c1"># It can be used in:</span>
        <span class="c1">#    1) Say goodbye to translator, back to stoa</span>

        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># Addional time: unit is second, counted from NOW</span>
        <span class="n">additional_time_in_sec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;user_additionalTime&#39;</span><span class="p">])</span>
        <span class="n">additional_price</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_additionalPrice&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">additional_price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;user_additionalPrice&#39;</span><span class="p">])</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="c1"># Change due date w/o addtional money</span>
        <span class="k">if</span> <span class="n">additional_price</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    UPDATE CICERON.F_REQUESTS</span>
<span class="s2">                    SET   due_time = CURRENT_TIMESTAMP + interval &#39;+</span><span class="si">%s</span><span class="s2"> seconds&#39;</span>
<span class="s2">                        , status_id = 0</span>
<span class="s2">                        , ongoing_worker_id = null</span>
<span class="s2">                        , registered_time = CURRENT_TIMESTAMP</span>
<span class="s2">                    WHERE id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">                      AND status_id = -1 </span>
<span class="s2">                      AND (client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                          OR (request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )))</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">additional_time_in_sec</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT registered_time, due_time, points FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="n">request_registeredTime</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">request_dueTime</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">request_points</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Request #</span><span class="si">%d</span><span class="s2"> is posted back to stoa.&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">,</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
                <span class="n">api</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">request_registeredTime</span><span class="o">=</span><span class="n">request_registeredTime</span><span class="p">,</span>
                <span class="n">request_dueTime</span><span class="o">=</span><span class="n">request_dueTime</span><span class="p">,</span>
                <span class="n">request_points</span><span class="o">=</span><span class="n">request_points</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span> 

        <span class="c1"># Change due date w/additional money</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    UPDATE CICERON.F_REQUESTS </span>
<span class="s2">                    SET   due_time = CURRENT_TIMESTAMP + interval &#39;+</span><span class="si">%s</span><span class="s2"> seconds&#39;</span>
<span class="s2">                        , status_id = 0</span>
<span class="s2">                        , is_paid = false</span>
<span class="s2">                        , points = points + </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                        , ongoing_worker_id = null</span>
<span class="s2">                        , registered_time = CURRENT_TIMESTAMP </span>
<span class="s2">                    WHERE id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">                      AND status_id = -1 </span>
<span class="s2">                      AND (client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                          OR (request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )))</span>
<span class="s2">                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">additional_time_in_sec</span><span class="p">,</span> <span class="n">additional_price</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT registered_time, due_time, points FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="n">request_registeredTime</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">request_dueTime</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">request_points</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Request #</span><span class="si">%d</span><span class="s2"> is renewed. Please execute the API provided with POST methid&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">,</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
                <span class="n">additional_price</span><span class="o">=</span><span class="n">additional_price</span><span class="p">,</span>
                <span class="n">api</span><span class="o">=</span><span class="s2">&quot;/api/user/requests/</span><span class="si">%d</span><span class="s2">/payment/start&quot;</span><span class="o">%</span><span class="n">request_id</span><span class="p">,</span>
                <span class="n">request_registeredTime</span><span class="o">=</span><span class="n">request_registeredTime</span><span class="p">,</span>
                <span class="n">request_dueTime</span><span class="o">=</span><span class="n">request_dueTime</span><span class="p">,</span>
                <span class="n">request_points</span><span class="o">=</span><span class="n">request_points</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
        <span class="c1"># It can be used in:</span>
        <span class="c1">#    1) Say goodbye to translator. And he/she don&#39;t want to leave his/her request</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT points </span>
<span class="s2">                FROM CICERON.F_REQUESTS </span>
<span class="s2">                WHERE id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">                  AND status_id IN (-1,0) </span>
<span class="s2">                  AND (client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                      OR (request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )))</span>
<span class="s2">                  AND is_paid = true &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">points</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#return make_response(json.jsonify(</span>
            <span class="c1">#    message=&quot;The point has already refunded about this request.&quot;,</span>
            <span class="c1">#    request_id=request_id), 402)</span>
            <span class="n">points</span> <span class="o">=</span> <span class="mf">0.0</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.REVENUE SET amount = amount + </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE CICERON.F_REQUESTS </span>
<span class="s2">                SET   is_paid = false</span>
<span class="s2">                    , status_id = -2 </span>
<span class="s2">                WHERE id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">                  AND status_id IN (-1,0) </span>
<span class="s2">                  AND (client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                      OR (request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )))</span>
<span class="s2">                  &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>

        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Notification</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT ongoing_worker_id, client_user_id FROM CICERON.F_REQUESTS WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">send_noti_lite</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">request_id</span><span class="p">)</span>
            <span class="n">update_user_record</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">translator_id</span><span class="o">=</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">update_user_record</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Your request #</span><span class="si">%d</span><span class="s2"> is deleted. Your points USD </span><span class="si">%.2f</span><span class="s2"> is backed in your account&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">points</span><span class="p">),</span>
            <span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="p">,</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/&lt;int:request_id&gt;/payment/checkPromoCode&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="check_promotionCode"><a class="viewcode-back" href="../../docs/app.application.html#app.application.check_promotionCode">[문서]</a><span class="k">def</span> <span class="nf">check_promotionCode</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    프로모션 코드 유효성 체크</span>
<span class="sd">    적용은 결제 API에서 이루어짐</span>

<span class="sd">    promoCode = common -&gt; 누구나 적용하는 캠페인</span>
<span class="sd">    promoCode = indiv -&gt; 개인한테만 제공</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">paymentObj</span> <span class="o">=</span> <span class="n">Payment</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>

    <span class="n">code</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;promoCode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="n">isCommonCode</span><span class="p">,</span> <span class="n">commonPoint</span><span class="p">,</span> <span class="n">commonMessage</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">commonPromotionCodeChecker</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
    <span class="n">isIndivCode</span><span class="p">,</span> <span class="n">indivPoint</span><span class="p">,</span> <span class="n">indivMessage</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">individualPromotionCodeChecker</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">isCommonCode</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">promoType</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">commonMessage</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">isCommonCode</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">402</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">isIndivCode</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">promoType</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">indivMessage</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">isIndivCode</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">402</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">isCommonCode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">promoType</span><span class="o">=</span><span class="s1">&#39;common&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">commonMessage</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="n">commonPoint</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">isIndivCode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">promoType</span><span class="o">=</span><span class="s1">&#39;indiv&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">indivMessage</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="n">indivPoint</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">promoType</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;There is no promo code matched,&quot;</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">405</span><span class="p">)</span></div>
        
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/&lt;int:request_id&gt;/payment/start&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="pay_for_request"><a class="viewcode-back" href="../../docs/app.application.html#app.application.pay_for_request">[문서]</a><span class="k">def</span> <span class="nf">pay_for_request</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    결제 API</span>
<span class="sd">    /api/requests에서 의뢰한 후 이곳으로 연결해야 is_paid = true로 바꿀 수 있음</span>

<span class="sd">    pay_by := [web, mobile] 플랫폼을 의미</span>
<span class="sd">    pay_via := [alipay, paypal, iamport] 결제 플랫폼</span>
<span class="sd">    promo_type := [common, indiv] 프로모션 코드 있으면 전 회원 캠페인인지, 개인인지 구분</span>
<span class="sd">    promo_code =&gt; 프로모션 코드</span>
<span class="sd">    use_point =&gt; 적립금이 있다면, 사용함. 적립금이 있는지 검사하는 로직 수반함</span>
<span class="sd">    is_additional := [&#39;true&#39;, &#39;false&#39;] 티켓 등록하면서 일어난 결제인지 (false) 티켓 등록 후 네고, 혹은 티켓 재등록 때문에 생기는 결제인지 (true) 구별</span>
<span class="sd">    payload =&gt; (iamport 결제에서만 사용) 카드정보, 유효기간 등 입력</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">paymentObj</span> <span class="o">=</span> <span class="n">Payment</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="n">requestResellObj</span> <span class="o">=</span> <span class="n">RequestResell</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="n">groupRequestObj</span> <span class="o">=</span> <span class="n">GroupRequest</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="n">client_email</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span>
    <span class="n">payment_platform</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;payment_platform&#39;</span><span class="p">]</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;payment_amount&#39;</span><span class="p">])</span>
    <span class="n">promo_type</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;promo_type&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span>
    <span class="n">promo_code</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;promo_code&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span>
    <span class="n">point_for_use</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;point_for_use&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="n">client_userId</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">client_email</span><span class="p">)</span>
    <span class="n">groupRequestObj</span><span class="o">.</span><span class="n">addUserToGroup</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">client_userId</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">payment_platform</span> <span class="o">==</span> <span class="s1">&#39;iamport&#39;</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;card_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;card_number&#39;</span><span class="p">]</span>
        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;expiry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;expiry&#39;</span><span class="p">]</span>
        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;birth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;birth&#39;</span><span class="p">]</span>
        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;pwd_2digit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;pwd_2digit&#39;</span><span class="p">]</span>

    <span class="n">is_prod</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PURPOSE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;PROD&#39;</span><span class="p">:</span>
        <span class="n">is_prod</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Point test</span>
    <span class="n">cur_amount</span> <span class="o">=</span> <span class="n">amount</span>
    <span class="k">if</span> <span class="n">point_for_use</span> <span class="o">&gt;</span> <span class="mf">0.00001</span><span class="p">:</span>
        <span class="n">is_point_usable</span><span class="p">,</span> <span class="n">cur_amount</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">checkPoint</span><span class="p">(</span><span class="n">client_userId</span><span class="p">,</span> <span class="n">point_for_use</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cur_amount</span> <span class="o">-</span> <span class="n">point_for_use</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.00001</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Fail&quot;</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span>

    <span class="c1"># Promo code test</span>
    <span class="k">if</span> <span class="n">promo_type</span> <span class="o">!=</span> <span class="s1">&#39;null&#39;</span><span class="p">:</span>
        <span class="n">isCommonCode</span><span class="p">,</span> <span class="n">commonPoint</span><span class="p">,</span> <span class="n">commonMessage</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">commonPromotionCodeChecker</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">)</span>
        <span class="n">isIndivCode</span><span class="p">,</span> <span class="n">indivPoint</span><span class="p">,</span> <span class="n">indivMessage</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">individualPromotionCodeChecker</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isCommonCode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cur_amount</span> <span class="o">=</span> <span class="n">cur_amount</span> <span class="o">-</span> <span class="n">commonPoint</span>
        <span class="k">elif</span> <span class="n">isIndivCode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cur_amount</span> <span class="o">=</span> <span class="n">cur_amount</span> <span class="o">-</span> <span class="n">indivPoint</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Fail&quot;</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span>

    <span class="c1"># Send payment request</span>
    <span class="n">is_payment_ok</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">payment_platform</span> <span class="o">==</span> <span class="s1">&#39;alipay&#39;</span> <span class="ow">and</span> <span class="n">cur_amount</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
        <span class="n">is_payment_ok</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">alipayPayment</span><span class="p">(</span><span class="n">is_prod</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">client_email</span><span class="p">,</span> <span class="n">cur_amount</span>
                <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="n">point_for_use</span>
                <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="n">promo_type</span>
                <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="n">promo_code</span>
                <span class="p">)</span>

    <span class="k">elif</span> <span class="n">payment_platform</span> <span class="o">==</span> <span class="s1">&#39;paypal&#39;</span> <span class="ow">and</span> <span class="n">cur_amount</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
        <span class="n">is_payment_ok</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">paypalPayment</span><span class="p">(</span><span class="n">is_prod</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">client_email</span><span class="p">,</span> <span class="n">cur_amount</span>
                <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="n">point_for_use</span>
                <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="n">promo_type</span>
                <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="n">promo_code</span>
                <span class="p">)</span>

    <span class="k">elif</span> <span class="n">payment_platform</span> <span class="o">==</span> <span class="s1">&#39;iamport&#39;</span> <span class="ow">and</span> <span class="n">cur_amount</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
        <span class="n">is_payment_ok</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">iamportPayment</span><span class="p">(</span><span class="n">is_prod</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">client_email</span><span class="p">,</span> <span class="n">cur_amount</span>
                <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="n">point_for_use</span>
                <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="n">promo_type</span>
                <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="n">promo_code</span>
                <span class="p">,</span> <span class="o">**</span><span class="n">payload</span>
                <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">is_payment_ok</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">pointPayment</span><span class="p">(</span><span class="n">is_prod</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">client_email</span><span class="p">,</span> <span class="n">cur_amount</span>
                <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="n">point_for_use</span>
                <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="n">promo_type</span>
                <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="n">promo_code</span>
                <span class="p">)</span>

    <span class="c1"># Return</span>
    <span class="k">if</span> <span class="n">is_payment_ok</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">link</span><span class="o">=</span><span class="n">link</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Fail&quot;</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/&lt;int:request_id&gt;/payment/postprocess&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="pay_for_request_process"><a class="viewcode-back" href="../../docs/app.application.html#app.application.pay_for_request_process">[문서]</a><span class="k">def</span> <span class="nf">pay_for_request_process</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    결제 후처리 API. Callback API</span>
<span class="sd">    우리가 직접 부를 일 없음. Alipay, Paypal 등에 결제 후, 성공하면 그 쪽에서 부르는 API</span>
<span class="sd">    결제정보 DB에 입력하고 is_paid = true로, 혹은 is_addional_point_paid = true로 바꿔주는 일을 한다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">paymentObj</span> <span class="o">=</span> <span class="n">Payment</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s1">&#39;user_email&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>
        <span class="p">,</span> <span class="s1">&#39;request_id&#39;</span><span class="p">:</span> <span class="n">request_id</span>
        <span class="p">,</span> <span class="s1">&#39;pay_via&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;pay_via&#39;</span><span class="p">]</span>
        <span class="p">,</span> <span class="s1">&#39;pay_by&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;pay_by&#39;</span><span class="p">]</span>
        <span class="p">,</span> <span class="s1">&#39;is_succeeded&#39;</span><span class="p">:</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="p">,</span> <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pay_amt&#39;</span><span class="p">))</span>
        <span class="p">,</span> <span class="s1">&#39;use_point&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_point&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="p">,</span> <span class="s1">&#39;promo_type&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;promo_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;promo_code&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;promo_code&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;is_additional&#39;</span><span class="p">:</span> <span class="n">parameter_to_bool</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_additional&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="p">,</span> <span class="s1">&#39;is_groupRequest&#39;</span><span class="p">:</span> <span class="n">parameter_to_bool</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_groupRequest&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="p">,</span> <span class="s1">&#39;is_public&#39;</span><span class="p">:</span> <span class="n">parameter_to_bool</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_public&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="p">,</span> <span class="s1">&#39;paymentId&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;paymentId&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;PayerID&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PayerID&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">,</span> <span class="s1">&#39;ciceron_order_id&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ciceron_order_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">is_succeeded</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">postProcess</span><span class="p">(</span><span class="o">**</span><span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_succeeded</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/status&#39;</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/stoa&#39;</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/translations/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@translator_checker</span>
<div class="viewcode-block" id="getOneTicketOfHero"><a class="viewcode-back" href="../../docs/app.application.html#app.application.getOneTicketOfHero">[문서]</a><span class="k">def</span> <span class="nf">getOneTicketOfHero</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    request_id만 입력받으면 알아서 status_id 감지하여 상황에 맞게 API를 포워딩해주고 상황에 맞는 데이터를 제공해주는 API</span>
<span class="sd">    번역가 전용</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="c1"># Request method: GET</span>
        <span class="c1"># Parameters</span>
        <span class="c1">#     since(optional): Timestamp, take recent 20 post before the timestamp.</span>
        <span class="c1">#                  If this parameter is not provided, recent 20 posts from now are returned</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT status_id FROM CICERON.V_REQUESTS WHERE request_id = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">rs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid request&quot;</span><span class="p">),</span> <span class="mi">404</span><span class="p">)</span>
        <span class="n">status_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">status_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;translation_incompleted_items_each&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">status_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;working_translate_item&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">status_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;translation_completed_items_detail&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid request&quot;</span><span class="p">),</span> <span class="mi">404</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="getOneTicketOfClient"><a class="viewcode-back" href="../../docs/app.application.html#app.application.getOneTicketOfClient">[문서]</a><span class="k">def</span> <span class="nf">getOneTicketOfClient</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    request_id만 입력받으면 알아서 status_id 감지하여 상황에 맞게 API를 포워딩해주고 상황에 맞는 데이터를 제공해주는 API</span>
<span class="sd">    의뢰인 전용</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="c1"># Request method: GET</span>
        <span class="c1"># Parameters</span>
        <span class="c1">#     since(optional): Timestamp, take recent 20 post before the timestamp.</span>
        <span class="c1">#                  If this parameter is not provided, recent 20 posts from now are returned</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT status_id FROM CICERON.V_REQUESTS WHERE request_id = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">rs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid request&quot;</span><span class="p">),</span> <span class="mi">404</span><span class="p">)</span>
        <span class="n">status_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">status_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;client_incompleted_item_control&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">status_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;show_ongoing_item_client&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">status_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;client_completed_items_detail&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid request&quot;</span><span class="p">),</span> <span class="mi">404</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/ongoing/i18n/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="i18n_getData_ongoing"><a class="viewcode-back" href="../../docs/app.application.html#app.application.i18n_getData_ongoing">[문서]</a><span class="k">def</span> <span class="nf">i18n_getData_ongoing</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    번역 진행중인 i18n 의뢰 열람</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

    <span class="n">is_user_request</span> <span class="o">=</span> <span class="n">clientAuthChecker</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_user_request</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Not your request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT * FROM CICERON.V_REQUESTS</span>
<span class="s2">            WHERE status_id = 1 </span>
<span class="s2">              AND (client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                  OR (request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )))</span>
<span class="s2">              AND request_id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT * FROM CICERON.V_REQUESTS </span>
<span class="s2">            WHERE status_id = 1 </span>
<span class="s2">              AND (client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                  OR (request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )))</span>
<span class="s2">              AND request_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">              AND ( (is_paid = true AND is_need_additional_points = false) </span>
<span class="s2">                  OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) )  &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND submitted_time &lt; datetime(</span><span class="si">%s</span><span class="s2">, &#39;unixepoch&#39;) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY submitted_time DESC LIMIT 20&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;complete_client&quot;</span><span class="p">)</span>

    <span class="n">i18nObj</span> <span class="o">=</span> <span class="n">I18nHandler</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
        <span class="n">realData</span><span class="o">=</span><span class="n">i18nObj</span><span class="o">.</span><span class="n">jsonResponse</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">is_restricted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/complete/i18n/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="i18n_getData_complete"><a class="viewcode-back" href="../../docs/app.application.html#app.application.i18n_getData_complete">[문서]</a><span class="k">def</span> <span class="nf">i18n_getData_complete</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    번역 완료한 i18n 의뢰 열람</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

    <span class="n">is_user_request</span> <span class="o">=</span> <span class="n">clientAuthChecker</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_user_request</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Not your request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">super_user</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT * FROM CICERON.V_REQUESTS </span>
<span class="s2">            WHERE status_id = 2 </span>
<span class="s2">              AND (</span>
<span class="s2">                     client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                  OR request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )</span>
<span class="s2">                  OR request_id IN (SELECT request_id FROM CICERON.F_READ_PUBLIC_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )</span>
<span class="s2">                  )</span>
<span class="s2">              AND request_id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT * FROM CICERON.V_REQUESTS </span>
<span class="s2">            WHERE status_id = 2 </span>
<span class="s2">              AND (</span>
<span class="s2">                      client_user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                  OR request_id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )</span>
<span class="s2">                  OR request_id IN (SELECT request_id FROM CICERON.F_READ_PUBLIC_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND is_paid = true) </span>
<span class="s2">                  )</span>
<span class="s2">              AND request_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">              AND ( (is_paid = true AND is_need_additional_points = false) </span>
<span class="s2">                  OR (is_paid = true AND is_need_additional_points = true AND is_additional_points_paid = true) )  &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND submitted_time &lt; datetime(</span><span class="si">%s</span><span class="s2">, &#39;unixepoch&#39;) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; ORDER BY submitted_time DESC LIMIT 20&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">json_from_V_REQUESTS</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;complete_client&quot;</span><span class="p">)</span>

    <span class="n">i18nObj</span> <span class="o">=</span> <span class="n">I18nHandler</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
        <span class="n">realData</span><span class="o">=</span><span class="n">i18nObj</span><span class="o">.</span><span class="n">jsonResponse</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">is_restricted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/requests/complete/i18n/&lt;int:request_id&gt;/download&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="i18n_download"><a class="viewcode-back" href="../../docs/app.application.html#app.application.i18n_download">[문서]</a><span class="k">def</span> <span class="nf">i18n_download</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    번역 완료된 i18n 의뢰 포멧별로 다운로드</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">is_user_request</span> <span class="o">=</span> <span class="n">clientAuthChecker</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_user_request</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Not your request&quot;</span><span class="p">),</span> <span class="mi">406</span><span class="p">)</span>

    <span class="n">i18nObj</span> <span class="o">=</span> <span class="n">I18nHandler</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="n">download_format</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">)</span>
    <span class="n">download_binary</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span>   <span class="n">download_format</span> <span class="o">==</span> <span class="s1">&#39;android&#39;</span><span class="p">:</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">download_binary</span> <span class="o">=</span> <span class="n">i18nObj</span><span class="o">.</span><span class="n">exportAndroid</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">download_format</span> <span class="o">==</span> <span class="s1">&#39;iOS&#39;</span><span class="p">:</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">download_binary</span> <span class="o">=</span> <span class="n">i18nObj</span><span class="o">.</span><span class="n">exportIOs</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">download_format</span> <span class="o">==</span> <span class="s1">&#39;unity&#39;</span><span class="p">:</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">download_binary</span> <span class="o">=</span> <span class="n">i18nObj</span><span class="o">.</span><span class="n">exportUnity</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">download_format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">download_binary</span> <span class="o">=</span> <span class="n">i18nObj</span><span class="o">.</span><span class="n">exportJson</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">download_format</span> <span class="o">==</span> <span class="s1">&#39;xamarin&#39;</span><span class="p">:</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">download_binary</span> <span class="o">=</span> <span class="n">i18nObj</span><span class="o">.</span><span class="n">exportXamarin</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">download_binary</span><span class="p">),</span> <span class="n">attachment_filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/public/random&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="public_list_random"><a class="viewcode-back" href="../../docs/app.application.html#app.application.public_list_random">[문서]</a><span class="k">def</span> <span class="nf">public_list_random</span><span class="p">():</span>
    <span class="n">requestResellObj</span> <span class="o">=</span> <span class="n">RequestResell</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="n">result_random</span> <span class="o">=</span> <span class="n">requestResellObj</span><span class="o">.</span><span class="n">getListRandomPick</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json_form_V_REQUESTS</span><span class="p">(</span><span class="n">result_random</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/public&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="public_list"><a class="viewcode-back" href="../../docs/app.application.html#app.application.public_list">[문서]</a><span class="k">def</span> <span class="nf">public_list</span><span class="p">():</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">requestResellObj</span> <span class="o">=</span> <span class="n">RequestResell</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">requestResellObj</span><span class="o">.</span><span class="n">getList</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json_form_V_REQUESTS</span><span class="p">(</span><span class="n">result</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/public/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="public_oneTicket"><a class="viewcode-back" href="../../docs/app.application.html#app.application.public_oneTicket">[문서]</a><span class="k">def</span> <span class="nf">public_oneTicket</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="n">requestResellObj</span> <span class="o">=</span> <span class="n">RequestResell</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">requestResellObj</span><span class="o">.</span><span class="n">getOneTicket</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json_form_V_REQUESTS</span><span class="p">(</span><span class="n">result</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/public/&lt;int:request_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="public_payment"><a class="viewcode-back" href="../../docs/app.application.html#app.application.public_payment">[문서]</a><span class="k">def</span> <span class="nf">public_payment</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>

        <span class="n">paymentObj</span> <span class="o">=</span> <span class="n">Payment</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">requestResellObj</span> <span class="o">=</span> <span class="n">RequestResell</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">client_email</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;payment_clientEmail&#39;</span><span class="p">]</span>
        <span class="n">payment_platform</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;payment_platform&#39;</span><span class="p">]</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;payment_amount&#39;</span><span class="p">])</span>
        <span class="n">promo_type</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;promo_type&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span>
        <span class="n">promo_code</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;promo_code&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">)</span>
        <span class="n">point_for_use</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;point_for_use&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">client_userId</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">client_email</span><span class="p">)</span>
        <span class="n">requestResellObj</span><span class="o">.</span><span class="n">setReadPermission</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">client_userId</span><span class="p">)</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">payment_platform</span> <span class="o">==</span> <span class="s1">&#39;iamport&#39;</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;card_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;card_number&#39;</span><span class="p">]</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;expiry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;expiry&#39;</span><span class="p">]</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;birth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;birth&#39;</span><span class="p">]</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;pwd_2digit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;pwd_2digit&#39;</span><span class="p">]</span>

        <span class="n">is_prod</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PURPOSE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;PROD&#39;</span><span class="p">:</span>
            <span class="n">is_prod</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Point test</span>
        <span class="n">cur_amount</span> <span class="o">=</span> <span class="n">amount</span>
        <span class="k">if</span> <span class="n">point_for_use</span> <span class="o">&gt;</span> <span class="mf">0.00001</span><span class="p">:</span>
            <span class="n">is_point_usable</span><span class="p">,</span> <span class="n">cur_amount</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">checkPoint</span><span class="p">(</span><span class="n">client_userId</span><span class="p">,</span> <span class="n">point_for_use</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_point</span> <span class="o">-</span> <span class="n">use_point</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.00001</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Fail&quot;</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span>

        <span class="c1"># Promo code test</span>
        <span class="k">if</span> <span class="n">promo_type</span> <span class="o">!=</span> <span class="s1">&#39;null&#39;</span><span class="p">:</span>
            <span class="n">isCommonCode</span><span class="p">,</span> <span class="n">commonPoint</span><span class="p">,</span> <span class="n">commonMessage</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">commonPromotionCodeChecker</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">)</span>
            <span class="n">isIndivCode</span><span class="p">,</span> <span class="n">indivPoint</span><span class="p">,</span> <span class="n">indivMessage</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">individualPromotionCodeChecker</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isCommonCode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cur_amount</span> <span class="o">=</span> <span class="n">cur_amount</span> <span class="o">-</span> <span class="n">commonPoint</span>
            <span class="k">elif</span> <span class="n">isIndivCode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cur_amount</span> <span class="o">=</span> <span class="n">cur_amount</span> <span class="o">-</span> <span class="n">indivPoint</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Fail&quot;</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span>

        <span class="c1"># Send payment request</span>
        <span class="n">is_payment_ok</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">payment_platform</span> <span class="o">==</span> <span class="s1">&#39;alipay&#39;</span> <span class="ow">and</span> <span class="n">cur_amount</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="n">is_payment_ok</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">alipayPayment</span><span class="p">(</span><span class="n">is_prod</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span> <span class="n">cur_amount</span>
                    <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="n">point_for_use</span>
                    <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="n">promo_type</span>
                    <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="n">promo_code</span>
                    <span class="p">,</span> <span class="n">is_public</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

        <span class="k">elif</span> <span class="n">payment_platform</span> <span class="o">==</span> <span class="s1">&#39;paypal&#39;</span> <span class="ow">and</span> <span class="n">cur_amount</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="n">is_payment_ok</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">paypalPayment</span><span class="p">(</span><span class="n">is_prod</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span> <span class="n">cur_amount</span>
                    <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="n">point_for_use</span>
                    <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="n">promo_type</span>
                    <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="n">promo_code</span>
                    <span class="p">,</span> <span class="n">is_pubic</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

        <span class="k">elif</span> <span class="n">payment_platform</span> <span class="o">==</span> <span class="s1">&#39;iamport&#39;</span> <span class="ow">and</span> <span class="n">cur_amount</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="n">is_payment_ok</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">iamportPayment</span><span class="p">(</span><span class="n">is_prod</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span> <span class="n">cur_amount</span>
                    <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="n">point_for_use</span>
                    <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="n">promo_type</span>
                    <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="n">promo_code</span>
                    <span class="p">,</span> <span class="n">is_public</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">,</span> <span class="o">**</span><span class="n">payload</span>
                    <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_payment_ok</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">paymentObj</span><span class="o">.</span><span class="n">pointPayment</span><span class="p">(</span><span class="n">is_prod</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">],</span> <span class="n">cur_amount</span>
                    <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="n">point_for_use</span>
                    <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="n">promo_type</span>
                    <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="n">promo_code</span>
                    <span class="p">,</span> <span class="n">is_public</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

        <span class="c1"># Return</span>
        <span class="k">if</span> <span class="n">is_payment_ok</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">link</span><span class="o">=</span><span class="n">link</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Fail&quot;</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/device&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="register_or_update_register_id"><a class="viewcode-back" href="../../docs/app.application.html#app.application.register_or_update_register_id">[문서]</a><span class="k">def</span> <span class="nf">register_or_update_register_id</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    푸시 알림을 위한 기기등록</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="n">device_os</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;user_deviceOS&#39;</span><span class="p">]</span>
    <span class="n">reg_key</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;user_regKey&#39;</span><span class="p">]</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

    <span class="n">record_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;D_MACHINES&quot;</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT count(*) FROM CICERON.D_MACHINES WHERE os_id = (SELECT id FROM CICERON.D_MACHINE_OSS WHERE text = </span><span class="si">%s</span><span class="s2">) AND user_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">device_os</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.D_MACHINES VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, (SELECT id FROM CICERON.D_MACHINE_OSS WHERE text = </span><span class="si">%s</span><span class="s2">), </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">record_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">device_os</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">reg_key</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.D_MACHINES SET reg_key = </span><span class="si">%s</span><span class="s2"> WHERE os_id = (SELECT id FROM CICERON.D_MACHINE_OSS WHERE text = </span><span class="si">%s</span><span class="s2">) AND user_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">reg_key</span><span class="p">,</span> <span class="n">device_os</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>

    <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Succefully updated/inserted&quot;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/access_file/profile_pic/&lt;user_id&gt;/&lt;fake_filename&gt;&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="access_profile_pic"><a class="viewcode-back" href="../../docs/app.application.html#app.application.access_profile_pic">[문서]</a><span class="k">def</span> <span class="nf">access_profile_pic</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">fake_filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    프로파일 사진 access를 위한 API.</span>
<span class="sd">    파라미터 중 하나 이름이 fake_filename인 이유는, 이거 별로 중요하지 않아서</span>
<span class="sd">    아무렇게나 입력해도 파일은 받아진다. 근데 확장자 잘못 넣으면 파일 안 열릴수도.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">query_getPic</span> <span class="o">=</span> <span class="s2">&quot;SELECT bin FROM CICERON.F_USER_PROFILE_PIC WHERE user_id = </span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_getPic</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">profile_pic</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">profile_pic</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;No profile pic&quot;</span><span class="p">),</span> <span class="mi">404</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">profile_pic</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">attachment_filename</span><span class="o">=</span><span class="n">fake_filename</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/access_file/request_pic/&lt;photo_id&gt;/&lt;fake_filename&gt;&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="access_request_pic"><a class="viewcode-back" href="../../docs/app.application.html#app.application.access_request_pic">[문서]</a><span class="k">def</span> <span class="nf">access_request_pic</span><span class="p">(</span><span class="n">photo_id</span><span class="p">,</span> <span class="n">fake_filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    사진 의뢰 access를 위한 API</span>
<span class="sd">    file을 직접 access하는 것이 아닌, DB에 저장된 Bianry를 파일로 만들어서 준다.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">query_checkAuth</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT photo_id FROM CICERON.F_REQUESTS</span>
<span class="s2">        WHERE (</span>
<span class="s2">               client_user_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">            OR ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">            OR id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )</span>
<span class="s2">            OR id IN (SELECT request_id FROM CICERON.F_READ_PUBLIC_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )</span>
<span class="s2">            )</span>
<span class="s2">          AND photo_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_checkAuth</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">photo_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">checkAuth</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">checkAuth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Only requester or translator can see the file&quot;</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span>

    <span class="n">query_getPic</span> <span class="o">=</span> <span class="s2">&quot;SELECT bin FROM CICERON.D_REQUEST_PHOTOS  WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_getPic</span><span class="p">,</span> <span class="p">(</span><span class="n">photo_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">request_pic</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">request_pic</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;No request pic&quot;</span><span class="p">),</span> <span class="mi">404</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">request_pic</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">attachment_filename</span><span class="o">=</span><span class="n">fake_filename</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/access_file/request_sounds/&lt;sound_id&gt;/&lt;fake_filename&gt;&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="access_request_sound"><a class="viewcode-back" href="../../docs/app.application.html#app.application.access_request_sound">[문서]</a><span class="k">def</span> <span class="nf">access_request_sound</span><span class="p">(</span><span class="n">sound_id</span><span class="p">,</span> <span class="n">fake_filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    음성 의뢰 파일 access를 위한 API</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">query_checkAuth</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT sound_id FROM CICERON.F_REQUESTS</span>
<span class="s2">        WHERE (</span>
<span class="s2">               client_user_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">            OR ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">            OR id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )</span>
<span class="s2">            OR id IN (SELECT request_id FROM CICERON.F_READ_PUBLIC_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )</span>
<span class="s2">            )</span>
<span class="s2">          AND sound_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_checkAuth</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">sound_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">checkAuth</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">checkAuth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Only requester or translator can see the file&quot;</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span>

    <span class="n">query_getSound</span> <span class="o">=</span> <span class="s2">&quot;SELECT bin FROM CICERON.D_REQUEST_SOUNDS  WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_getSound</span><span class="p">,</span> <span class="p">(</span><span class="n">sound_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">request_sound</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">request_sound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;No request sound&quot;</span><span class="p">),</span> <span class="mi">404</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">request_sound</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">attachment_filename</span><span class="o">=</span><span class="n">fake_filename</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/access_file/request_doc/&lt;doc_id&gt;/&lt;fake_filename&gt;&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<div class="viewcode-block" id="access_request_file"><a class="viewcode-back" href="../../docs/app.application.html#app.application.access_request_file">[문서]</a><span class="k">def</span> <span class="nf">access_request_file</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">fake_filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    문서 의뢰 파일 access를 위한 API</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">query_checkAuth</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT file_id FROM CICERON.F_REQUESTS</span>
<span class="s2">        WHERE (</span>
<span class="s2">               client_user_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">            OR ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">            OR id IN (SELECT request_id FROM CICERON.F_GROUP_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )</span>
<span class="s2">            OR id IN (SELECT request_id FROM CICERON.F_READ_PUBLIC_REQUESTS_USERS WHERE user_id = </span><span class="si">%s</span><span class="s2"> )</span>
<span class="s2">            )</span>
<span class="s2">          AND file_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_checkAuth</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">doc_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">checkAuth</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">checkAuth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Only requester or translator can see the file&quot;</span><span class="p">),</span> <span class="mi">401</span><span class="p">)</span>

    <span class="n">query_getFile</span> <span class="o">=</span> <span class="s2">&quot;SELECT bin FROM CICERON.D_REQUEST_FILES WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_getFile</span><span class="p">,</span> <span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">request_file</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">request_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;No request file&quot;</span><span class="p">),</span> <span class="mi">404</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">request_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">attachment_filename</span><span class="o">=</span><span class="n">fake_filename</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/access_file/img/&lt;filename&gt;&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="mail_img"><a class="viewcode-back" href="../../docs/app.application.html#app.application.mail_img">[문서]</a><span class="k">def</span> <span class="nf">mail_img</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    img 폴더의 이미지들을 access하기 위한 API</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/action_record&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="record_user_location"><a class="viewcode-back" href="../../docs/app.application.html#app.application.record_user_location">[문서]</a><span class="k">def</span> <span class="nf">record_user_location</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    사용안함. 지워도 됨.</span>
<span class="sd">    API call logging에 사용. 지금은 아예 내장시킴</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">lati</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">)</span>
    <span class="n">longi</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;long&#39;</span><span class="p">)</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">)</span>
    <span class="n">api</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;api&#39;</span><span class="p">)</span>
    <span class="n">request_id</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_id&#39;</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.USER_ACTIONS VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,CURRENT_TIMESTAMP)&quot;</span><span class="p">,</span> 
            <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">lati</span><span class="p">,</span> <span class="n">longi</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">request_id</span><span class="p">))</span>
    <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonnify</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Logged successfully&quot;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/notification&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="get_notification"><a class="viewcode-back" href="../../docs/app.application.html#app.application.get_notification">[문서]</a><span class="k">def</span> <span class="nf">get_notification</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    알림 내역 조회</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

    <span class="c1"># Count whole unread noti</span>
    <span class="n">query_noti</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT count(*) FROM CICERON.V_NOTIFICATION WHERE user_id = </span><span class="si">%s</span><span class="s2"> and is_read = false &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_noti</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">numberOfNoti</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT noti.user_name,</span>
<span class="s2">                      noti.user_profile_pic_path,</span>
<span class="s2">                      noti.noti_type_id,</span>
<span class="s2">                      noti.request_id,</span>
<span class="s2">                      noti.target_user_name,</span>
<span class="s2">                      noti.ts,</span>
<span class="s2">                      noti.is_read,</span>
<span class="s2">                      noti.target_profile_pic_path,</span>
<span class="s2">                      CASE WHEN noti.expected_time is not null THEN (noti.expected_time - CURRENT_TIMESTAMP) ELSE null END as expectedDue,</span>
<span class="s2">                      noti.context,</span>
<span class="s2">                      noti.status_id,</span>
<span class="s2">                      CASE WHEN noti.expected_time is null THEN false ELSE true END as expectedDue_replied,</span>
<span class="s2">                      noti.id</span>
<span class="s2">            FROM CICERON.V_NOTIFICATION noti LEFT OUTER JOIN CICERON.F_REQUESTS req ON noti.request_id = req.id</span>
<span class="s2">            WHERE noti.user_id = </span><span class="si">%s</span><span class="s2"> AND req.status_id != -2 &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;since&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;AND ts &lt; to_timestamp(</span><span class="si">%s</span><span class="s2">) &quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;since&#39;</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;ORDER BY ts DESC LIMIT 10 &quot;</span>

    <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">isAlert</span><span class="p">,</span> <span class="n">alertType</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="n">getRoutingAddressAndAlertType</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;profilePic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;noti_typeId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;target_username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;target_userProfilePic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;is_read&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_to_bool</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;isAlert&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isAlert</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;alertType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alertType</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;abstract&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;request_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>

        <span class="c1">#row[&#39;expectedDue&#39;] = (string2Date(item[8])-datetime.now()).total_seconds() if item[8] != None else None</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;expectedDue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;expectedDue_replied&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;noti_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>

        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
        <span class="n">numberOfNoti</span><span class="o">=</span><span class="n">numberOfNoti</span><span class="p">,</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Notifications&quot;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/notification/read&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="read_notification"><a class="viewcode-back" href="../../docs/app.application.html#app.application.read_notification">[문서]</a><span class="k">def</span> <span class="nf">read_notification</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    조회한 노티 읽음으로 처리</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span> 
    <span class="k">if</span> <span class="s1">&#39;noti_id&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE CICERON.F_NOTIFICATION SET is_read = true WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
        <span class="n">noti_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;noti_id&#39;</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">noti_id</span><span class="p">,</span> <span class="p">))</span>

    <span class="c1">#else:</span>
    <span class="c1">#    query = &quot;&quot;&quot;UPDATE CICERON.F_NOTIFICATION SET is_read = true WHERE id IN (SELECT id FROM CICERON.F_NOTIFICATION WHERE user_id = %s ORDER BY ts DESC) &quot;&quot;&quot;</span>
    <span class="c1">#    cursor.execute(query, (user_id, ))</span>

    <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Notis are marked as read&quot;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/payback&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="register_payback"><a class="viewcode-back" href="../../docs/app.application.html#app.application.register_payback">[문서]</a><span class="k">def</span> <span class="nf">register_payback</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    적립금 환불신청 넣는 API</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="c1"># GET payback list</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT id, order_no, bank_name, account_no, request_time, amount, is_returned</span>
<span class="s2">            FROM CICERON.RETURN_MONEY_BANK_ACCOUNT</span>
<span class="s2">            WHERE user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            ORDER BY id DESC&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>

        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;orderNo&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s1">&#39;bankName&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="s1">&#39;accountNo&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                    <span class="s1">&#39;requestTime&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                    <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                    <span class="s1">&#39;isReturned&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                    <span class="p">}</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="c1"># POST new payback request</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">bank_name</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;bankName&#39;</span><span class="p">]</span>
        <span class="n">account_no</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;accountNo&#39;</span><span class="p">]</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">])</span>

        <span class="c1"># Test whether requested amount is exceeded the money in user&#39;s account</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT amount FROM CICERON.REVENUE WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">revenue_amount</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">revenue_amount</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;User cannot request paid back. Revenue: </span><span class="si">%f</span><span class="s2">, Requested amount: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">revenue_amount</span><span class="p">,</span> <span class="n">amount</span><span class="p">)),</span> <span class="mi">402</span><span class="p">)</span>

        <span class="n">new_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;RETURN_MONEY_BANK_ACCOUNT&quot;</span><span class="p">)</span>
        <span class="n">order_no</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">random_string_gen</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.RETURN_MONEY_BANK_ACCOUNT VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,CURRENT_TIMESTAMP,</span><span class="si">%s</span><span class="s2">,false,null)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">new_id</span><span class="p">,</span> <span class="n">order_no</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">bank_name</span><span class="p">,</span> <span class="n">account_no</span><span class="p">,</span> <span class="n">amount</span><span class="p">))</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Payback request is successfully received&quot;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>
        
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/point_detail&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="point_detail"><a class="viewcode-back" href="../../docs/app.application.html#app.application.point_detail">[문서]</a><span class="k">def</span> <span class="nf">point_detail</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    적립금 / 포인트 사용 및 적립내역 보여줌</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT * FROM (</span>
<span class="s2">    SELECT 2 as message_id, request_time, -1 * amount as points, is_returned, return_time FROM CICERON.RETURN_MONEY_BANK_ACCOUNT WHERE user_id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">    UNION</span>
<span class="s2">    SELECT 1 as message_id, registered_time as request_time, points, null as is_returned, null as return_time</span>
<span class="s2">    FROM CICERON.F_REQUESTS WHERE status_id = 2 AND is_paid = true AND ongoing_worker_id = </span><span class="si">%s</span><span class="s2"> AND points &gt; 0</span>
<span class="s2">    UNION</span>
<span class="s2">    SELECT 0 as message_id, registered_time as request_time, points, null as is_returned, null as return_time</span>
<span class="s2">    FROM CICERON.F_REQUESTS WHERE status_id = -2 AND is_paid = false AND client_user_id = </span><span class="si">%s</span><span class="s2">) total</span>
<span class="s2">    order by request_time desc LIMIT 20 &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">((</span> <span class="nb">int</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">requested_time</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">is_returned</span><span class="p">,</span> <span class="n">return_time</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;message_id&#39;</span><span class="p">:</span> <span class="n">message_id</span><span class="p">,</span>
            <span class="s1">&#39;requested_time&#39;</span><span class="p">:</span> <span class="n">requested_time</span><span class="p">,</span>
            <span class="s1">&#39;points&#39;</span><span class="p">:</span> <span class="n">points</span><span class="p">,</span>
            <span class="s1">&#39;is_returned&#39;</span><span class="p">:</span> <span class="n">is_returned</span><span class="p">,</span>
            <span class="s1">&#39;return_time&#39;</span><span class="p">:</span> <span class="n">return_time</span>
        <span class="p">}</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/payback_email&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="register_payback_email"><a class="viewcode-back" href="../../docs/app.application.html#app.application.register_payback_email">[문서]</a><span class="k">def</span> <span class="nf">register_payback_email</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    페이백 신청 보내는 이메일.</span>
<span class="sd">    /api/user/payback과 기능이 겹치는데 왜 구닥닥리 API를 만드느냐?</span>
<span class="sd">      -&gt; 위의건 혹시 개발이 어려울 수 있어서...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">mail_to</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">]</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">mail_to</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM CICERON.D_USERS WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">subject</span> <span class="o">=</span> <span class="s1">&#39;Please reply for your refund request&#39;</span>

    <span class="n">doc_no</span> <span class="o">=</span> <span class="n">random_string_gen</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;&lt;img src=&#39;</span><span class="si">%(host)s</span><span class="s2">/api/access_file/img/logo.png&#39;&gt;&lt;br&gt;</span>
<span class="s2">                 &lt;span style=&#39;color:#5F9EA0&#39;&gt;&lt;h1&gt;Dear </span><span class="si">%(name)s</span><span class="s2">,&lt;/h1&gt;&lt;/span&gt;&lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 Thank you for being with Ciceron!&lt;br&gt;</span>
<span class="s2">                 Is it fun to work with us? We wish that it had been, and would be good time!&lt;br&gt;</span>
<span class="s2">                 If there is any problem with our system, don&#39;y hesitate to contact us by &lt;a href=&quot;mailto:contact@ciceron.me&quot;&gt;this mail!&lt;/a&gt;&lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 For your refund request, please fill out the information below and reply to us!&lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 &lt;b&gt;Name of the bank&lt;/b&gt;:&lt;br&gt;</span>
<span class="s2">                 &lt;b&gt;Account no.&lt;/b&gt;:&lt;br&gt;</span>
<span class="s2">                 &lt;b&gt;Amount&lt;/b&gt;:&lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 Have a wonderful day! :)&lt;br&gt;</span>
<span class="s2">                 We are looking for your reply!&lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 Best regards,&lt;br&gt;</span>
<span class="s2">                 Ciceron team&lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 ##### PLEASE DO NOT DELETE THE TEXT BELOW #####&lt;br&gt;</span>
<span class="s2">                 </span><span class="si">%(doc_no)s</span><span class="s2">&lt;br&gt;</span>
<span class="s2">                 ##### PLEASE DO NOT DELETE THE TEXT ABOVE #####&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;doc_no&#39;</span><span class="p">:</span> <span class="n">doc_no</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">HOST</span><span class="p">}</span>

    <span class="n">send_mail</span><span class="p">(</span><span class="n">mail_to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">mail_from</span><span class="o">=</span><span class="s1">&#39;contact@ciceron.me&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Request mail is sent!&#39;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>
                
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/payback/&lt;str_id&gt;/&lt;order_no&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="revise_payback"><a class="viewcode-back" href="../../docs/app.application.html#app.application.revise_payback">[문서]</a><span class="k">def</span> <span class="nf">revise_payback</span><span class="p">(</span><span class="n">str_id</span><span class="p">,</span> <span class="n">order_no</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    환급 신청 수정 (PUT), 삭제 (DELETE)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;PUT&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">bank_name</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bankName&#39;</span><span class="p">)</span>
        <span class="n">account_no</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accountNo&#39;</span><span class="p">)</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">bank_name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.RETURN_MONEY_BANK_ACCOUNT SET bank_name = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2"> AND order_no = </span><span class="si">%s</span><span class="s2"> AND user_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">bank_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_id</span><span class="p">),</span> <span class="n">order_no</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">account_no</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.RETURN_MONEY_BANK_ACCOUNT SET account_no = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2"> AND order_no = </span><span class="si">%s</span><span class="s2"> AND user_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">account_no</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_id</span><span class="p">),</span> <span class="n">order_no</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">amount</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Test whether requested amount is exceeded the money in user&#39;s account</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT amount FROM CICERON.REVENUE WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">revenue_amount</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">revenue_amount</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;User cannot paid back. Revenue: </span><span class="si">%f</span><span class="s2">, Requested amount: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">revenue_amount</span><span class="p">,</span> <span class="n">amount</span><span class="p">)),</span> <span class="mi">402</span><span class="p">)</span>

            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.RETURN_MONEY_BANK_ACCOUNT SET amount = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2"> AND order_no = </span><span class="si">%s</span><span class="s2"> AND user_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_id</span><span class="p">),</span> <span class="n">order_no</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span> <span class="p">)</span>
            
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Payback request is updated&quot;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM CICERON.RETURN_MONEY_BANK_ACCOUNT WHERE id = </span><span class="si">%s</span><span class="s2"> AND order_no = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">str_id</span><span class="p">),</span> <span class="n">order_no</span><span class="p">))</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Payback request has just been deleted.&quot;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/be_hero&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="be_hero"><a class="viewcode-back" href="../../docs/app.application.html#app.application.be_hero">[문서]</a><span class="k">def</span> <span class="nf">be_hero</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    번역가 권한 신청</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">school</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;school&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">major</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">]</span>
    <span class="n">residence</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;residence&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">doc_no</span> <span class="o">=</span> <span class="n">random_string_gen</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Welcome to Ciceron, hero candidate </span><span class="si">%s</span><span class="s2">!&quot;</span> <span class="o">%</span> <span class="n">name</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;&lt;img src=&#39;</span><span class="si">%(host)s</span><span class="s2">/api/access_file/img/logo.png&#39;&gt;&lt;br&gt;</span>
<span class="s2">                 &lt;span style=&#39;color:#5F9EA0&#39;&gt;&lt;h1&gt;Dear </span><span class="si">%(name)s</span><span class="s2">,&lt;/h1&gt;&lt;/span&gt;&lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 Thank you for applying to the hero!&lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 Please reply this mail with the form below and supporting documents.&lt;br&gt;</span>
<span class="s2">                 &lt;b&gt;Name&lt;/b&gt;: </span><span class="si">%(name)s</span><span class="s2">&lt;br&gt;</span>
<span class="s2">                 &lt;b&gt;&lt;u&gt;(Supporting document needed)&lt;/u&gt; Education and school(or occupation)&lt;/b&gt;: </span><span class="si">%(school)s</span><span class="s2">&lt;br&gt;</span>
<span class="s2">                 &lt;b&gt;&lt;u&gt;(Supporting document needed)&lt;/u&gt; Major&lt;/b&gt;: </span><span class="si">%(major)s</span><span class="s2">&lt;br&gt;</span>
<span class="s2">                 &lt;b&gt;Applying language&lt;/b&gt;: </span><span class="si">%(language)s</span><span class="s2">&lt;br&gt;</span>
<span class="s2">                 &lt;b&gt;Residence&lt;/b&gt;: </span><span class="si">%(residence)s</span><span class="s2">&lt;br&gt;</span>
<span class="s2">                 &lt;b&gt;&lt;u&gt;(Supporting document needed)&lt;/u&gt; Qualifications, score, or supporting experience(optional)&lt;/b&gt;: </span><span class="si">%(score)s</span><span class="s2">&lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 Have a wonderful day! :)&lt;br&gt;</span>
<span class="s2">                 We are looking for your reply!&lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 Best regards,&lt;br&gt;</span>
<span class="s2">                 Ciceron team&lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 &lt;br&gt;</span>
<span class="s2">                 ##### PLEASE DO NOT DELETE THE TEXT BELOW #####&lt;br&gt;</span>
<span class="s2">                 </span><span class="si">%(doc_no)s</span><span class="s2">&lt;br&gt;</span>
<span class="s2">                 ##### PLEASE DO NOT DELETE THE TEXT ABOVE #####&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span>
                         <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                         <span class="s1">&#39;school&#39;</span><span class="p">:</span> <span class="n">school</span><span class="p">,</span>
                         <span class="s1">&#39;major&#39;</span><span class="p">:</span> <span class="n">major</span><span class="p">,</span>
                         <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="n">language</span><span class="p">,</span>
                         <span class="s1">&#39;residence&#39;</span><span class="p">:</span> <span class="n">residence</span><span class="p">,</span>
                         <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
                         <span class="s1">&#39;doc_no&#39;</span><span class="p">:</span> <span class="n">doc_no</span><span class="p">,</span>
                         <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="n">HOST</span> <span class="o">+</span> <span class="s1">&#39;:5000&#39;</span>
                         <span class="p">}</span>

    <span class="n">send_mail</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">mail_from</span><span class="o">=</span><span class="s1">&#39;hero@ciceron.me&#39;</span><span class="p">)</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;useremail&#39;</span><span class="p">])</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.D_USERS SET trans_request_state = 1 WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Application mail has just sent to </span><span class="si">%s</span><span class="s2">!&quot;</span> <span class="o">%</span> <span class="n">email</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/tool/initial_translate&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="initial_translate"><a class="viewcode-back" href="../../docs/app.application.html#app.application.initial_translate">[문서]</a><span class="k">def</span> <span class="nf">initial_translate</span><span class="p">():</span>
    <span class="n">connector</span> <span class="o">=</span> <span class="n">Connector</span><span class="p">()</span>
    <span class="n">parameter</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="n">user_email</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;user_email&#39;</span><span class="p">]</span>
    <span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">])</span>
    <span class="n">sentence</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;sentence&#39;</span><span class="p">]</span>
    <span class="n">source_lang_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;source_lang_id&#39;</span><span class="p">])</span>
    <span class="n">target_lang_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;target_lang_id&#39;</span><span class="p">])</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_email</span><span class="p">)</span>

    <span class="n">init_result</span> <span class="o">=</span> <span class="n">connector</span><span class="o">.</span><span class="n">getTranslatedDataParallel</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">source_lang_id</span><span class="p">,</span> <span class="n">target_lang_id</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cand1&quot;</span><span class="p">:</span> <span class="n">init_result</span><span class="p">[</span><span class="s1">&#39;google&#39;</span><span class="p">],</span>
            <span class="s2">&quot;cand2&quot;</span><span class="p">:</span> <span class="n">init_result</span><span class="p">[</span><span class="s1">&#39;bing&#39;</span><span class="p">],</span>
            <span class="s2">&quot;cand3&quot;</span><span class="p">:</span> <span class="n">init_result</span><span class="p">[</span><span class="s1">&#39;yandex&#39;</span><span class="p">]</span>
            <span class="p">}</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="o">**</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/tool/sentence_tokenize&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="sentence_tokenize"><a class="viewcode-back" href="../../docs/app.application.html#app.application.sentence_tokenize">[문서]</a><span class="k">def</span> <span class="nf">sentence_tokenize</span><span class="p">():</span>
    <span class="n">warehouseObj</span> <span class="o">=</span> <span class="n">Warehousing</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="n">sentences</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;sentences&#39;</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">warehouseObj</span><span class="o">.</span><span class="n">parseSentence</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
        <span class="n">sentences</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/tool/i18n_test_parsing&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<div class="viewcode-block" id="i18n_parsing"><a class="viewcode-back" href="../../docs/app.application.html#app.application.i18n_parsing">[문서]</a><span class="k">def</span> <span class="nf">i18n_parsing</span><span class="p">():</span>
    <span class="n">i18nHandlerObj</span> <span class="o">=</span> <span class="n">I18nHandler</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="n">parameter</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">file_format</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_format&#39;</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">)</span>
    <span class="n">file_binary</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;file_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">file_langKey</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_langKey&#39;</span><span class="p">)</span>

    <span class="n">result_dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="n">i18nHandlerObj</span><span class="o">.</span><span class="n">_jsonToDict</span><span class="p">(</span><span class="n">file_binary</span><span class="p">,</span> <span class="n">file_langKey</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s1">&#39;unity&#39;</span><span class="p">:</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="n">i18nHandlerObj</span><span class="o">.</span><span class="n">_unityToDict</span><span class="p">(</span><span class="n">file_binary</span><span class="p">,</span> <span class="n">file_langKey</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s1">&#39;iOS&#39;</span><span class="p">:</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="n">i18nHandlerObj</span><span class="o">.</span><span class="n">_iosToDict</span><span class="p">(</span><span class="n">file_binary</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s1">&#39;android&#39;</span><span class="p">:</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="n">i18nHandlerObj</span><span class="o">.</span><span class="n">_androidToDict</span><span class="p">(</span><span class="n">file_binary</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s1">&#39;xamarin&#39;</span><span class="p">:</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="n">i18nHandlerObj</span><span class="o">.</span><span class="n">_xamarinToDict</span><span class="p">(</span><span class="n">file_binary</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result_dict</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="c1">################################################################################</span>
<span class="c1">#########                        ADMIN TOOL                            #########</span>
<span class="c1">################################################################################</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/language_assigner&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@admin_required</span>
<div class="viewcode-block" id="language_assigner"><a class="viewcode-back" href="../../docs/app.application.html#app.application.language_assigner">[문서]</a><span class="k">def</span> <span class="nf">language_assigner</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    해당 유저에게 해당 언어 번역가 권한 부여</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="n">user_email</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
    <span class="n">language_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;language_id&#39;</span><span class="p">])</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_email</span><span class="p">)</span>
    <span class="n">new_translation_list_id</span> <span class="o">=</span> <span class="n">get_new_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;D_TRANSLATABLE_LANGUAGES&quot;</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.D_USERS SET is_translator = true, trans_request_state = 2 WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT language_id FROM CICERON.D_TRANSLATABLE_LANGUAGES WHERE user_id = </span><span class="si">%s</span><span class="s2"> and language_id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">language_id</span><span class="p">))</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO CICERON.D_TRANSLATABLE_LANGUAGES VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">new_translation_list_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">language_id</span><span class="p">))</span>
    <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Language added successfully&quot;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/language_rejector&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@admin_required</span>
<div class="viewcode-block" id="language_rejector"><a class="viewcode-back" href="../../docs/app.application.html#app.application.language_rejector">[문서]</a><span class="k">def</span> <span class="nf">language_rejector</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    해당 유저 번역가 권한 빼앗기</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="n">user_email</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_email</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.D_USERS SET trans_request_state = CASE WHEN is_translator = false THEN 0 WHEN is_translator = true THEN 2 END WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Language added successfully&quot;</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/payback_list&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="c1">#@exception_detector</span>
<span class="nd">@admin_required</span>
<div class="viewcode-block" id="return_money"><a class="viewcode-back" href="../../docs/app.application.html#app.application.return_money">[문서]</a><span class="k">def</span> <span class="nf">return_money</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    환급해줘야 할 내역 조회 (GET), 환급으로 마킹 (POST)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="c1"># We&#39;ve not prepared for card payback.</span>

        <span class="c1">#parameters = parse_request(request)</span>
        <span class="c1">#user_id = get_user_id(session[&#39;useremail&#39;])</span>
        <span class="c1">#where_to_return = parameters[&#39;user_whereToReturn&#39;]</span>
        <span class="c1">#payment_id = parameters[&#39;user_PaymentId&#39;]</span>
        <span class="c1">#money_amount = parameters[&#39;user_revenue&#39;]</span>

        <span class="c1">## Logic flow</span>
        <span class="c1">##   1) Check how much money in user&#39;s revenue</span>
        <span class="c1">##     - If request amount is exceeded user&#39;s revenue, reject refund request.</span>
        <span class="c1">##   2) Send via paypal</span>

        <span class="c1">## SANDBOX</span>
        <span class="c1">#API_ID = &quot;APP-80W284485P519543T&quot;</span>
        <span class="c1">#API_USER = &quot;contact-facilitator_api1.ciceron.me&quot;</span>
        <span class="c1">#API_PASS = &#39;R8H3MF9EQYTNHD22&#39;</span>
        <span class="c1">#API_SIGNATURE = &#39;ABMADzBsLmPPJmWRmjvj6KuGeZ4MAoDQ7X0sCtehblA93Yolgrjto1tO&#39;</span>

        <span class="c1">## Live</span>
        <span class="c1">## API_ID = &#39;Should be issued later&#39;</span>
        <span class="c1">## API_USERNAME = &#39;contact_api1.ciceron.me&#39;</span>
        <span class="c1">## API_PASS = &#39;GJ5JNF596R3VNBK4&#39;</span>
        <span class="c1">## API_SIGNATURE = &#39;AiPC9BjkCyDFQXbSkoZcgqH3hpacAqbVr1jqSkiaKlwohFFSWhFvOxwI&#39;</span>

        <span class="c1">## END POINT = https://svcs.sandbox.paypal.com/AdaptivePayments/Pay</span>
        <span class="c1">## POST</span>
        <span class="c1">## Input header:</span>
        <span class="c1">## X-PAYPAL-APPLICATION-ID = API_ID</span>
        <span class="c1">## X-PAYPAL-SECURITY-USERID = API_USER</span>
        <span class="c1">## X-PAYPAL-SECURITY-PASSWORD = API_PASS</span>
        <span class="c1">## X-PAYPAL-SECURITY-SIGNATURE = API_SIGNATURE</span>
        <span class="c1">## X-PAYPAL-DEVICE-IPADDRESS = IP_ADDRESS</span>
        <span class="c1">## X-PAYPAL-REQUEST-DATA-FORMAT = &#39;JSON&#39;</span>
        <span class="c1">## X-PAYPAL-RESPONSE-DATA-FORMAT = &#39;JSON&#39;</span>

        <span class="c1">#body = {&quot;returnUrl&quot;:&quot;http://example.com/returnURL.htm&quot;,</span>
        <span class="c1">#        &quot;requestEnvelope&quot;:</span>
        <span class="c1">#           {&quot;errorLanguage&quot;:&quot;en_KR&quot;},</span>
        <span class="c1">#        &quot;currencyCode&quot;:&quot;USD&quot;,</span>
        <span class="c1">#        &quot;receiverList&quot;:{</span>
        <span class="c1">#            &quot;receiver&quot;:</span>
        <span class="c1">#            [{&quot;email&quot;:&quot;psy2848048@gmail.com&quot;,&quot;amount&quot;:&quot;10.00&quot;,}]</span>
        <span class="c1">#            },</span>
        <span class="c1">#        &quot;cancelUrl&quot;:&quot;http://example.com/cancelURL.htm&quot;,</span>
        <span class="c1">#        &quot;actionType&quot;:&quot;PAY&quot;}</span>

        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">id_order</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="n">order_no</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;orderNo&#39;</span><span class="p">]</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT user_id, amount FROM CICERON.RETURN_MONEY_BANK_ACCOUNT WHERE id = </span><span class="si">%s</span><span class="s2"> AND order_no = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">id_order</span><span class="p">),</span> <span class="n">order_no</span><span class="p">))</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.RETURN_MONEY_BANK_ACCOUNT SET is_returned = true, return_time = CURRENT_TIMESTAMP WHERE id = </span><span class="si">%s</span><span class="s2"> AND order_no = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">id_order</span><span class="p">,</span> <span class="n">order_no</span><span class="p">))</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE CICERON.REVENUE SET amount = amount - </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>

        <span class="c1"># Notification</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT user_id FROM CICERON.RETURN_MONEY_BANK_ACCOUNT WHERE id = </span><span class="si">%s</span><span class="s2"> AND order_no = </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">id_order</span><span class="p">,</span> <span class="n">order_no</span><span class="p">))</span>
        <span class="n">user_id_no</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">send_noti_lite</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id_no</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Payed back. Order no: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">order_no</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT</span>
<span class="s2">            fact.id, fact.order_no, fact.user_id, usr.email, fact.bank_name, fact.account_no, fact.request_time, fact.amount, fact.is_returned, fact.return_time</span>
<span class="s2">            FROM CICERON.RETURN_MONEY_BANK_ACCOUNT fact</span>
<span class="s2">            LEFT OUTER JOIN CICERON.D_USERS usr ON fact.user_id = usr.id</span>
<span class="s2">            WHERE fact.is_returned = false</span>
<span class="s2">                ORDER BY fact.id DESC&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;orderNo&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="s1">&#39;user_email&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="s1">&#39;bankName&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
                    <span class="s1">&#39;accountNo&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
                    <span class="s1">&#39;requestTime&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                    <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                    <span class="p">}</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span></div>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">gevent.wsgi</span> <span class="k">import</span> <span class="n">WSGIServer</span>
    <span class="n">http_server</span> <span class="o">=</span> <span class="n">WSGIServer</span><span class="p">((</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">),</span> <span class="n">app</span><span class="p">)</span>
    <span class="n">http_server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
    <span class="c1">#app.run(host=&quot;0.0.0.0&quot;, port=5000, threaded=True)</span>
    
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">모듈 코드</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>빠른 검색</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="바로 가기" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, psy2848048.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>