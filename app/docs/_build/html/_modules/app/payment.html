<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="ko">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>app.payment &#8212; CICERON 2.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <link rel="index" title="색인" href="../../genindex.html" />
    <link rel="search" title="검색" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for app.payment</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">tzinfo</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">paypalrestsdk</span>
<span class="kn">from</span> <span class="nn">iamport</span> <span class="k">import</span> <span class="n">Iamport</span>
<span class="kn">from</span> <span class="nn">alipay</span> <span class="k">import</span> <span class="n">Alipay</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">ciceron_lib</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ciceron_lib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.groupRequest</span> <span class="k">import</span> <span class="n">GroupRequest</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">groupRequest</span> <span class="k">import</span> <span class="n">GroupRequest</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.requestResell</span> <span class="k">import</span> <span class="n">RequestResell</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">requestResell</span> <span class="k">import</span> <span class="n">RequestResell</span>

<span class="n">ZERO</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="UTC"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.UTC">[문서]</a><span class="k">class</span> <span class="nc">UTC</span><span class="p">(</span><span class="n">tzinfo</span><span class="p">):</span>
<div class="viewcode-block" id="UTC.utcoffset"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.UTC.utcoffset">[문서]</a>    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ZERO</span></div>
<div class="viewcode-block" id="UTC.tzname"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.UTC.tzname">[문서]</a>    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;UTC&quot;</span></div>
<div class="viewcode-block" id="UTC.dst"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.UTC.dst">[문서]</a>    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ZERO</span></div></div>

<span class="n">utc</span> <span class="o">=</span> <span class="n">UTC</span><span class="p">()</span>

<div class="viewcode-block" id="Payment"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.Payment">[문서]</a><span class="k">class</span> <span class="nc">Payment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    결제모듈 담당</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span>

    <span class="k">def</span> <span class="nf">_orderNoGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iamport 방식으로 결제할 때에는 Iamport 단에서 주문번호를 만들어 주지 않기 때문에 우리가 직접 만들어야 한다.</span>
<span class="sd">        주문번호 형식은 YYYYMMDDxxxx (ex 20160716abcd) 방식으로 한다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">order_no</span> <span class="o">=</span> <span class="kc">None</span>
    
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
            <span class="n">order_no</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">ciceron_lib</span><span class="o">.</span><span class="n">random_string_gen</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT count(*) FROM CICERON.PAYMENT_INFO WHERE order_no = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">order_no</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    
            <span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="n">order_no</span>

    <span class="k">def</span> <span class="nf">_pointDeduction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_email</span><span class="p">,</span> <span class="n">point_for_use</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">ciceron_lib</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_email</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">point_for_use</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    UPDATE CICERON.return_point</span>
<span class="s2">                    SET amount = amount - </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                    WHERE id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span> 
                <span class="p">(</span><span class="n">point_for_use</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">)</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_markAsPaid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">is_additional</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">is_additional</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">query_setToPaid</span> <span class="o">=</span> <span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET is_paid = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query_setToPaid</span> <span class="o">=</span> <span class="s2">&quot;UPDATE CICERON.F_REQUESTS SET is_additional_points_paid = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_setToPaid</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="p">))</span>

    <span class="k">def</span> <span class="nf">_paypalPaymentCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_id</span><span class="p">,</span> <span class="n">payer_id</span><span class="p">):</span>
        <span class="n">payment</span> <span class="o">=</span> <span class="n">paypalrestsdk</span><span class="o">.</span><span class="n">Payment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">payment_id</span><span class="p">)</span>
        <span class="n">payment</span><span class="o">.</span><span class="n">execute</span><span class="p">({</span><span class="s2">&quot;payer_id&quot;</span><span class="p">:</span> <span class="n">payer_id</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_insertPaymentInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">payment_platform</span><span class="p">,</span> <span class="n">payment_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># Payment information update</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">payment_info_id</span> <span class="o">=</span> <span class="n">ciceron_lib</span><span class="o">.</span><span class="n">get_new_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;PAYMENT_INFO&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            INSERT INTO CICERON.PAYMENT_INFO</span>
<span class="s2">                (id, request_id, client_id, payed_via, order_no, pay_amount, payed_time)</span>
<span class="s2">            VALUES</span>
<span class="s2">                (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,CURRENT_TIMESTAMP)&quot;&quot;&quot;</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span>
                <span class="p">(</span>  <span class="n">payment_info_id</span>
                 <span class="p">,</span> <span class="n">request_id</span>
                 <span class="p">,</span> <span class="n">user_id</span>
                 <span class="p">,</span> <span class="n">payment_platform</span>
                 <span class="p">,</span> <span class="n">payment_id</span>
                 <span class="p">,</span> <span class="n">amount</span>
                 <span class="p">,</span> <span class="p">)</span>
                <span class="p">)</span>

<div class="viewcode-block" id="Payment.commonPromotionCodeChecker"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.Payment.commonPromotionCodeChecker">[문서]</a>    <span class="k">def</span> <span class="nf">commonPromotionCodeChecker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="c1"># return: (val1, val2, message)</span>
        <span class="c1">#          val1: is valid code? (codeType)</span>
        <span class="c1">#          val2: How much?</span>
        <span class="c1">#          message: Message</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        공용 프로모션 코드 validator이다.</span>
<span class="sd">        코드는 유효한지, 유효한 코드지만 이미 사용한 코드인지 등등을 체크한다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">query_commonPromotionCode</span><span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT id, benefitPoint, expireTime FROM CICERON.PROMOTIONCODES_COMMON WHERE text = UPPER(</span><span class="si">%s</span><span class="s2">) &quot;&quot;&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_commonPromotionCode</span><span class="p">,</span> <span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;There is no promo code matched.&quot;</span><span class="p">)</span>
    
        <span class="n">code_id</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">benefitPoint</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">expireTime</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    
        <span class="k">if</span> <span class="n">expireTime</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">utc</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;This promo code is expired.&quot;</span><span class="p">)</span>
    
        <span class="n">query_userCheck</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT count(*) FROM CICERON.USEDPROMOTION_COMMON WHERE id = </span><span class="si">%s</span><span class="s2"> AND user_id = </span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
    
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_userCheck</span><span class="p">,</span> <span class="p">(</span><span class="n">code_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    
        <span class="k">if</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;You&#39;ve already used this code.&quot;</span><span class="p">)</span>
    
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">benefitPoint</span><span class="p">,</span> <span class="s2">&quot;You may use this code.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Payment.commonPromotionCodeExecutor"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.Payment.commonPromotionCodeExecutor">[문서]</a>    <span class="k">def</span> <span class="nf">commonPromotionCodeExecutor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_email</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        프로모션 코드를 적용한다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">ciceron_lib</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_email</span><span class="p">)</span>
        <span class="n">query_searchPromoCodeId</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT id FROM CICERON.PROMOTIONCODES_COMMON WHERE text = UPPER(</span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_searchPromoCodeId</span><span class="p">,</span> <span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Promo code &#39;</span><span class="si">%s</span><span class="s2">&#39; doesn&#39;t exist!&quot;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>

        <span class="n">code_id</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">query_commonPromotionCodeExeutor</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            INSERT INTO CICERON.USEDPROMOTION_COMMON VALUES (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_commonPromotionCodeExeutor</span><span class="p">,</span> <span class="p">(</span><span class="n">code_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span></div>

<div class="viewcode-block" id="Payment.individualPromotionCodeChecker"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.Payment.individualPromotionCodeChecker">[문서]</a>    <span class="k">def</span> <span class="nf">individualPromotionCodeChecker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="c1"># return: (val1, val2)</span>
        <span class="c1">#          val1: is valid code?</span>
        <span class="c1">#          val2: How much?</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        개인 프로모션 코드 validator이다.</span>
<span class="sd">        그 밖의 기능은 위와 같다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">query_individualPromotionCode</span><span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT benefitPoint, expireTime, is_used</span>
<span class="s2">            FROM CICERON.PROMOTIONCODES_USER</span>
<span class="s2">            WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND text = UPPER(</span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_individualPromotionCode</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;There is no promo code matched.&quot;</span><span class="p">)</span>
    
        <span class="n">benefitPoint</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">expireTime</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">isUsed</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    
        <span class="k">if</span> <span class="n">expireTime</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">utc</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;This promo code is expired.&quot;</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">isUsed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;You&#39;ve already used this code.&quot;</span><span class="p">)</span>
    
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">benefitPoint</span><span class="p">,</span> <span class="s2">&quot;You may use this code.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Payment.individualPromotionCodeExecutor"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.Payment.individualPromotionCodeExecutor">[문서]</a>    <span class="k">def</span> <span class="nf">individualPromotionCodeExecutor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_email</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        개인용 프로모션 코드 적용기이다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">ciceron_lib</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_email</span><span class="p">)</span>
        <span class="n">query_commonPromotionCodeExeutor</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            UPDATE CICERON.PROMOTIONCODES_USER</span>
<span class="s2">            SET is_used = true </span>
<span class="s2">            WHERE user_id = </span><span class="si">%s</span><span class="s2"> AND text = UPPER(</span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_commonPromotionCodeExeutor</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="p">))</span></div>

<div class="viewcode-block" id="Payment.checkPoint"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.Payment.checkPoint">[문서]</a>    <span class="k">def</span> <span class="nf">checkPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">point_for_use</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        포인트 조회 함수</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT amount FROM CICERON.RETURN_POINT WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">current_point</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">current_point</span> <span class="o">-</span> <span class="n">point_for_use</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.00001</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">current_point</span>
    
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">current_point</span>
            
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Payment.alipayPayment"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.Payment.alipayPayment">[문서]</a>    <span class="k">def</span> <span class="nf">alipayPayment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_prod_server</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_email</span><span class="p">,</span> <span class="n">amount</span>
            <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="p">,</span> <span class="n">is_additional</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">,</span> <span class="n">is_groupRequest</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">,</span> <span class="n">is_public</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_prod_server</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;http://ciceron.xyz:5000&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;http://ciceron.me:5000&quot;</span>
        <span class="n">pay_by</span> <span class="o">=</span> <span class="s2">&quot;web&quot;</span>

        <span class="n">postprocess_api</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host_name</span><span class="p">,</span> <span class="s1">&#39;api/user/requests/</span><span class="si">%d</span><span class="s1">/payment/postprocess&#39;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>

        <span class="n">order_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orderNoGenerator</span><span class="p">()</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;pay_via&#39;</span><span class="p">:</span> <span class="s1">&#39;alipay&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_email</span>
              <span class="p">,</span> <span class="s1">&#39;pay_amt&#39;</span><span class="p">:</span> <span class="n">amount</span>
              <span class="p">,</span> <span class="s1">&#39;pay_by&#39;</span><span class="p">:</span> <span class="n">pay_by</span>
              <span class="p">,</span> <span class="s1">&#39;use_point&#39;</span><span class="p">:</span> <span class="n">point_for_use</span>
              <span class="p">,</span> <span class="s1">&#39;promo_type&#39;</span><span class="p">:</span> <span class="n">promo_type</span>
              <span class="p">,</span> <span class="s1">&#39;promo_code&#39;</span><span class="p">:</span> <span class="n">promo_code</span>
              <span class="p">,</span> <span class="s1">&#39;ciceron_order_no&#39;</span><span class="p">:</span> <span class="n">order_no</span>
              <span class="p">,</span> <span class="s1">&#39;is_additional&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span> <span class="k">if</span> <span class="n">is_additional</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;true&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;is_groupRequest&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span> <span class="k">if</span> <span class="n">is_groupRequest</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;true&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;is_public&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span> <span class="k">if</span> <span class="n">is_public</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;true&#39;</span>
                <span class="p">}</span>
        <span class="n">return_url</span> <span class="o">=</span> <span class="n">ciceron_lib</span><span class="o">.</span><span class="n">apiURLOrganizer</span><span class="p">(</span><span class="n">postprocess_api</span><span class="p">,</span> <span class="o">**</span><span class="n">param_dict</span><span class="p">)</span>

        <span class="n">alipay_obj</span> <span class="o">=</span> <span class="n">Alipay</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="s1">&#39;2088021580332493&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;lksk5gkmbsj0w7ejmhziqmoq2gdda3jo&#39;</span><span class="p">,</span> <span class="n">seller_email</span><span class="o">=</span><span class="s1">&#39;contact@ciceron.me&#39;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="s1">&#39;诗谐论翻译&#39;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
            <span class="s1">&#39;out_trade_no&#39;</span><span class="p">:</span> <span class="n">order_no</span><span class="p">,</span>
            <span class="c1">#&#39;subject&#39;: &#39;TEST&#39;,</span>
            <span class="s1">&#39;total_fee&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;return_url&#39;</span><span class="p">:</span> <span class="n">return_url</span>
            <span class="p">}</span>

        <span class="n">provided_link</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pay_by</span> <span class="o">==</span> <span class="s1">&#39;web&#39;</span><span class="p">:</span>
                <span class="n">provided_link</span> <span class="o">=</span> <span class="n">alipay_obj</span><span class="o">.</span><span class="n">create_forex_trade_url</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">pay_by</span> <span class="o">==</span> <span class="s1">&#39;mobile&#39;</span><span class="p">:</span>
                <span class="n">provided_link</span> <span class="o">=</span> <span class="n">alipay_obj</span><span class="o">.</span><span class="n">create_forex_trade_wap_url</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">provided_link</span></div>

<div class="viewcode-block" id="Payment.iamportPayment"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.Payment.iamportPayment">[문서]</a>    <span class="k">def</span> <span class="nf">iamportPayment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_prod_server</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_email</span><span class="p">,</span> <span class="n">amount</span>
            <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">,</span> <span class="n">is_additional</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">,</span> <span class="n">is_groupRequest</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">,</span> <span class="n">is_public</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">,</span> <span class="o">**</span><span class="n">payload</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        아임포트 No-ActiveX 결제 시스템이다.</span>

<span class="sd">        직접 카드번호 및 유효기간 등의 정보를 물러와서 결제를 바로 한다.</span>
<span class="sd">        그리고 이 자리에서 바로 결제를 하기 때문에 postprocessing 과정을 거쳐서 할 작업을 여기서 다 한다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pay_by</span> <span class="o">=</span> <span class="s2">&quot;web&quot;</span>
        <span class="k">if</span> <span class="n">is_prod_server</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;http://ciceron.xyz&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;http://ciceron.me&quot;</span>

        <span class="c1"># Payload parameter check</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;card_number&#39;</span><span class="p">,</span> <span class="s1">&#39;expiry&#39;</span><span class="p">,</span> <span class="s1">&#39;birth&#39;</span><span class="p">,</span> <span class="s1">&#39;pwd_2digit&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Insufficient parameters. &#39;card_number&#39;, &#39;expiry&#39;, &#39;birth&#39;, &#39;pwd_2digit&#39; are needed.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">new_payload</span> <span class="o">=</span> <span class="n">payload</span>
        <span class="n">order_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orderNoGenerator</span><span class="p">()</span>
        <span class="c1"># Should check USD-&gt;KRW currency</span>
        <span class="c1"># Hard coded: 1200</span>
        <span class="n">kor_amount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount</span> <span class="o">*</span> <span class="mi">1160</span><span class="p">)</span>

        <span class="n">new_payload</span><span class="p">[</span><span class="s1">&#39;merchant_uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order_no</span>
        <span class="n">new_payload</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kor_amount</span>

        <span class="n">pay_module</span> <span class="o">=</span> <span class="n">Iamport</span><span class="p">(</span><span class="n">imp_key</span><span class="o">=</span><span class="mi">2311212273535904</span><span class="p">,</span> <span class="n">imp_secret</span><span class="o">=</span><span class="s1">&#39;jZM7opWBO5K2cZfVoMgYJhsnSw4TiSmBR8JgyGRnLCpYCFT0raZbsrylYDehvBSnKCDjivG4862KLWLd&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">payment_result</span> <span class="o">=</span> <span class="n">pay_module</span><span class="o">.</span><span class="n">pay_onetime</span><span class="p">(</span><span class="o">**</span><span class="n">new_payload</span><span class="p">)</span>
            <span class="n">double_check</span> <span class="o">=</span> <span class="n">pay_module</span><span class="o">.</span><span class="n">is_paid</span><span class="p">(</span><span class="o">**</span><span class="n">payment_result</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Iamport</span><span class="o">.</span><span class="n">ResponseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="n">postprocess_api</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host_name</span><span class="p">,</span> <span class="s1">&#39;api/user/requests/</span><span class="si">%d</span><span class="s1">/payment/postprocess&#39;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;pay_via&#39;</span><span class="p">:</span> <span class="s1">&#39;iamport&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_email</span>
              <span class="p">,</span> <span class="s1">&#39;pay_amt&#39;</span><span class="p">:</span> <span class="n">amount</span>
              <span class="p">,</span> <span class="s1">&#39;pay_by&#39;</span><span class="p">:</span> <span class="n">pay_by</span>
              <span class="p">,</span> <span class="s1">&#39;use_point&#39;</span><span class="p">:</span> <span class="n">point_for_use</span>
              <span class="p">,</span> <span class="s1">&#39;promo_type&#39;</span><span class="p">:</span> <span class="n">promo_type</span>
              <span class="p">,</span> <span class="s1">&#39;promo_code&#39;</span><span class="p">:</span> <span class="n">promo_code</span>
              <span class="p">,</span> <span class="s1">&#39;is_additional&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span> <span class="k">if</span> <span class="n">is_additional</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;true&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;is_groupRequest&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span> <span class="k">if</span> <span class="n">is_groupRequest</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;true&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;is_public&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span> <span class="k">if</span> <span class="n">is_public</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;true&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;ciceron_order_id&#39;</span><span class="p">:</span> <span class="n">order_no</span>
                <span class="p">}</span>
        <span class="n">return_url</span> <span class="o">=</span> <span class="n">ciceron_lib</span><span class="o">.</span><span class="n">apiURLOrganizer</span><span class="p">(</span><span class="n">postprocess_api</span><span class="p">,</span> <span class="o">**</span><span class="n">param_dict</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">double_check</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Iamport checkout abnormaly works!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">return_url</span></div>

<div class="viewcode-block" id="Payment.paypalPayment"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.Payment.paypalPayment">[문서]</a>    <span class="k">def</span> <span class="nf">paypalPayment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_prod_server</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_email</span><span class="p">,</span> <span class="n">amount</span>
            <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="p">,</span> <span class="n">is_additional</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">,</span> <span class="n">is_groupRequest</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">,</span> <span class="n">is_public</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        페이팔은 그냥 모든 정보를 URL에 박아서 페이팔에 넘겨주면 된다.</span>
<span class="sd">        결제는 페이팔에서 한 후 콜백으로 postprocessing을 불러오기때문에, 여기서는 페이팔로의 링크만 제공해주면 된다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pay_by</span> <span class="o">=</span> <span class="s2">&quot;web&quot;</span>
        <span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># SANDBOX</span>
        <span class="k">if</span> <span class="n">is_prod_server</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;http://ciceron.xyz&quot;</span>
            <span class="n">paypalrestsdk</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;sandbox&quot;</span><span class="p">,</span>
                    <span class="n">client_id</span><span class="o">=</span><span class="s2">&quot;AQX4nD2IQ4xQ03Rm775wQ0SptsSe6-WBdMLldyktgJG0LPhdGwBf90C7swX2ymaSJ-PuxYKicVXg12GT&quot;</span><span class="p">,</span>
                    <span class="n">client_secret</span><span class="o">=</span><span class="s2">&quot;EHUxNGZPZNGe_pPDrofV80ZKkSMbApS2koofwDYRZR6efArirYcJazG2ao8eFqqd8sX-8fUd2im9GzBG&quot;</span>
            <span class="p">)</span>

        <span class="c1"># LIVE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;http://ciceron.me&quot;</span>
            <span class="n">paypalrestsdk</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;live&quot;</span><span class="p">,</span>
                    <span class="n">client_id</span><span class="o">=</span><span class="s2">&quot;AevAg0UyjlRVArPOUN6jjsRVQrlasLZVyqJrioOlnF271796_2taD1HOZFry9TjkAYSTZExpyFyJV5Tl&quot;</span><span class="p">,</span>
                    <span class="n">client_secret</span><span class="o">=</span><span class="s2">&quot;EJjp8RzEmFRH_qpwzOyJU7ftf9GxZM__vl5w2pqERkXrt3aI6nsVBj2MnbkfLsDzcZzX3KW8rgqTdSIR&quot;</span>
                    <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

        <span class="n">postprocess_api</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host_name</span><span class="p">,</span> <span class="s1">&#39;api/user/requests/</span><span class="si">%d</span><span class="s1">/payment/postprocess&#39;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;pay_via&#39;</span><span class="p">:</span> <span class="s1">&#39;paypal&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_email</span>
              <span class="p">,</span> <span class="s1">&#39;pay_amt&#39;</span><span class="p">:</span> <span class="n">amount</span>
              <span class="p">,</span> <span class="s1">&#39;pay_by&#39;</span><span class="p">:</span> <span class="n">pay_by</span>
              <span class="p">,</span> <span class="s1">&#39;use_point&#39;</span><span class="p">:</span> <span class="n">point_for_use</span>
              <span class="p">,</span> <span class="s1">&#39;promo_type&#39;</span><span class="p">:</span> <span class="n">promo_type</span>
              <span class="p">,</span> <span class="s1">&#39;promo_code&#39;</span><span class="p">:</span> <span class="n">promo_code</span>
              <span class="p">,</span> <span class="s1">&#39;is_additional&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span> <span class="k">if</span> <span class="n">is_additional</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;true&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;is_groupRequest&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span> <span class="k">if</span> <span class="n">is_groupRequest</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;true&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;is_public&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span> <span class="k">if</span> <span class="n">is_public</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;true&#39;</span>
                <span class="p">}</span>
        <span class="n">return_url</span> <span class="o">=</span> <span class="n">ciceron_lib</span><span class="o">.</span><span class="n">apiURLOrganizer</span><span class="p">(</span><span class="n">postprocess_api</span><span class="p">,</span> <span class="o">**</span><span class="n">param_dict</span><span class="p">)</span>

        <span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
        <span class="n">cancel_url</span> <span class="o">=</span> <span class="n">ciceron_lib</span><span class="o">.</span><span class="n">apiURLOrganizer</span><span class="p">(</span><span class="n">postprocess_api</span><span class="p">,</span> <span class="o">**</span><span class="n">param_dict</span><span class="p">)</span>

        <span class="n">payment</span> <span class="o">=</span> <span class="n">paypalrestsdk</span><span class="o">.</span><span class="n">Payment</span><span class="p">({</span>
          <span class="s2">&quot;intent&quot;</span><span class="p">:</span> <span class="s2">&quot;sale&quot;</span><span class="p">,</span>
          <span class="s2">&quot;payer&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;payment_method&quot;</span><span class="p">:</span> <span class="s2">&quot;paypal&quot;</span><span class="p">},</span>
          <span class="s2">&quot;redirect_urls&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;return_url&quot;</span><span class="p">:</span> <span class="n">return_url</span><span class="p">,</span>
            <span class="s2">&quot;cancel_url&quot;</span><span class="p">:</span> <span class="n">cancel_url</span>
            <span class="p">},</span>
          <span class="s2">&quot;transactions&quot;</span><span class="p">:</span> <span class="p">[{</span>
            <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">amount</span><span class="p">,</span>
                <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="s2">&quot;USD&quot;</span><span class="p">,</span>
            <span class="p">},</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Ciceron translation request fee USD: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">amount</span> <span class="p">}]})</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">payment</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>  <span class="c1"># return True or False</span>
        <span class="n">paypal_link</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">payment</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;REDIRECT&#39;</span><span class="p">:</span>
                <span class="n">paypal_link</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">paypal_link</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Payment.pointPayment"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.Payment.pointPayment">[문서]</a>    <span class="k">def</span> <span class="nf">pointPayment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_prod_server</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_email</span><span class="p">,</span> <span class="n">amount</span>
            <span class="p">,</span> <span class="n">point_for_use</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="p">,</span> <span class="n">is_additional</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">,</span> <span class="n">is_groupRequest</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">,</span> <span class="n">is_public</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        페이팔은 그냥 모든 정보를 URL에 박아서 페이팔에 넘겨주면 된다.</span>
<span class="sd">        결제는 페이팔에서 한 후 콜백으로 postprocessing을 불러오기때문에, 여기서는 페이팔로의 링크만 제공해주면 된다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pay_by</span> <span class="o">=</span> <span class="s2">&quot;web&quot;</span>
        <span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_prod_server</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;http://ciceron.xyz&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;http://ciceron.me&quot;</span>

        <span class="n">order_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orderNoGenerator</span><span class="p">()</span>
        <span class="n">postprocess_api</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host_name</span><span class="p">,</span> <span class="s1">&#39;api/user/requests/</span><span class="si">%d</span><span class="s1">/payment/postprocess&#39;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;pay_via&#39;</span><span class="p">:</span> <span class="s1">&#39;point&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_email</span>
              <span class="p">,</span> <span class="s1">&#39;pay_amt&#39;</span><span class="p">:</span> <span class="n">amount</span>
              <span class="p">,</span> <span class="s1">&#39;pay_by&#39;</span><span class="p">:</span> <span class="n">pay_by</span>
              <span class="p">,</span> <span class="s1">&#39;use_point&#39;</span><span class="p">:</span> <span class="n">point_for_use</span>
              <span class="p">,</span> <span class="s1">&#39;promo_type&#39;</span><span class="p">:</span> <span class="n">promo_type</span>
              <span class="p">,</span> <span class="s1">&#39;promo_code&#39;</span><span class="p">:</span> <span class="n">promo_code</span>
              <span class="p">,</span> <span class="s1">&#39;is_additional&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span> <span class="k">if</span> <span class="n">is_additional</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;true&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;is_groupRequest&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span> <span class="k">if</span> <span class="n">is_groupRequest</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;true&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;is_public&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span> <span class="k">if</span> <span class="n">is_public</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;true&#39;</span>
              <span class="p">,</span> <span class="s1">&#39;ciceron_order_id&#39;</span><span class="p">:</span> <span class="n">order_no</span>
                <span class="p">}</span>
        <span class="n">return_url</span> <span class="o">=</span> <span class="n">ciceron_lib</span><span class="o">.</span><span class="n">apiURLOrganizer</span><span class="p">(</span><span class="n">postprocess_api</span><span class="p">,</span> <span class="o">**</span><span class="n">param_dict</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">return_url</span></div>

<div class="viewcode-block" id="Payment.postProcess"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.Payment.postProcess">[문서]</a>    <span class="k">def</span> <span class="nf">postProcess</span><span class="p">(</span><span class="bp">self</span>
            <span class="p">,</span> <span class="n">user_email</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">,</span> <span class="n">pay_via</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">,</span> <span class="n">pay_by</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">,</span> <span class="n">is_succeeded</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">,</span> <span class="n">use_point</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">,</span> <span class="n">promo_type</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">,</span> <span class="n">promo_code</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">,</span> <span class="n">is_additional</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">,</span> <span class="n">is_groupRequest</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">,</span> <span class="n">is_public</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">,</span> <span class="n">paymentId</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">,</span> <span class="n">PayerID</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">,</span> <span class="n">ciceron_order_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="n">ciceron_lib</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="n">user_email</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_succeeded</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Point deduction</span>
        <span class="k">if</span> <span class="n">use_point</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pointDeduction</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">use_point</span><span class="p">)</span>

        <span class="c1"># Use promo code</span>
        <span class="k">if</span> <span class="n">promo_type</span> <span class="o">==</span> <span class="s1">&#39;common&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commonPromotionCodeExecutor</span><span class="p">(</span><span class="n">user_email</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">promo_type</span> <span class="o">==</span> <span class="s1">&#39;indiv&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">individualPromotionCodeExecutor</span><span class="p">(</span><span class="n">user_email</span><span class="p">,</span> <span class="n">promo_code</span><span class="p">)</span>

        <span class="c1"># Check payment in each payment platform</span>
        <span class="n">payment_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pay_via</span> <span class="o">==</span> <span class="s1">&#39;paypal&#39;</span> <span class="ow">and</span> <span class="n">is_succeeded</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">payment_id</span> <span class="o">=</span> <span class="n">paymentId</span>
            <span class="n">payer_id</span> <span class="o">=</span> <span class="n">PayerID</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_paypalPaymentCheck</span><span class="p">(</span><span class="n">payment_id</span><span class="p">,</span> <span class="n">payer_id</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">pay_via</span> <span class="o">==</span> <span class="s1">&#39;alipay&#39;</span> <span class="ow">and</span> <span class="n">is_succeeded</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">payment_id</span> <span class="o">=</span> <span class="n">ciceron_order_id</span>

        <span class="k">elif</span> <span class="n">pay_via</span> <span class="o">==</span> <span class="s1">&#39;iamport&#39;</span> <span class="ow">and</span> <span class="n">is_succeeded</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">payment_id</span> <span class="o">=</span> <span class="n">ciceron_order_id</span>

        <span class="k">elif</span> <span class="n">pay_via</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span> <span class="ow">and</span> <span class="n">is_succeeded</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">payment_id</span> <span class="o">=</span> <span class="n">ciceron_order_id</span>

        <span class="c1"># Set to &#39;paid&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_markAsPaid</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">is_additional</span><span class="p">)</span>

        <span class="c1"># Group request processing</span>
        <span class="k">if</span> <span class="n">is_groupRequest</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">groupRequestObj</span> <span class="o">=</span> <span class="n">GroupRequest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
            <span class="n">groupRequestObj</span><span class="o">.</span><span class="n">updatePaymentInfo</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">pay_via</span><span class="p">,</span> <span class="n">payment_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_public</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">requestResellObj</span> <span class="o">=</span> <span class="n">RequestResell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
            <span class="n">requestResellObj</span><span class="o">.</span><span class="n">setToPaid</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">pay_via</span><span class="p">,</span> <span class="n">payment_id</span><span class="p">)</span>

        <span class="c1"># Insert payment info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insertPaymentInfo</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">pay_via</span><span class="p">,</span> <span class="n">payment_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Payment.refundByPoint"><a class="viewcode-back" href="../../docs/app.payment.html#app.payment.Payment.refundByPoint">[문서]</a>    <span class="k">def</span> <span class="nf">refundByPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    UPDATE CICERON.REVENUE </span>
<span class="s2">                    SET amount = amount + </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">                    WHERE id = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="p">))</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">모듈 코드</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>빠른 검색</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="바로 가기" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, psy2848048.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>